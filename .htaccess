# Hostinger Configuration pour Symfony/React
# Logging configuration
LogLevel alert rewrite:trace6
ErrorLog /home/u817324220/domains/peru-ape-766379.hostingersite.com/logs/error.log
RewriteLog "/home/u817324220/domains/peru-ape-766379.hostingersite.com/logs/rewrite.log"
RewriteLogLevel 9

# Enable rewrite engine
RewriteEngine On
RewriteBase /

# Allow direct access to frontend/dist directory
<Directory "/home/u817324220/domains/peru-ape-766379.hostingersite.com/public_html/frontend/dist">
    Require all granted
    Allow from all
    Options +FollowSymLinks
</Directory>

# If the request is for an actual file or directory in frontend/dist, serve it
RewriteCond %{DOCUMENT_ROOT}/frontend/dist%{REQUEST_URI} -f [OR]
RewriteCond %{DOCUMENT_ROOT}/frontend/dist%{REQUEST_URI} -d
RewriteRule ^(.*)$ frontend/dist/$1 [L]

# Handle API requests
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ backend/public/index.php [QSA,L]

# If requesting assets, serve from frontend/dist/assets
RewriteCond %{REQUEST_URI} ^/assets/
RewriteRule ^assets/(.*)$ frontend/dist/assets/$1 [L]

# For the root URL or any non-existing path, serve index.html
RewriteCond %{REQUEST_URI} ^/$ [OR]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ frontend/dist/index.html [L]

# PHP settings
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value memory_limit 256M
    php_value max_execution_time 60
    php_value error_log /home/u817324220/domains/peru-ape-766379.hostingersite.com/logs/php_errors.log
    php_flag log_errors on
</IfModule>

# Set proper MIME types
AddType application/javascript .js
AddType text/css .css
AddType image/svg+xml .svg
AddType application/json .json

# Enable CORS
Header set Access-Control-Allow-Origin "*"
Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"

# Security headers
Header set X-Content-Type-Options "nosniff"
Header set X-XSS-Protection "1; mode=block"
Header set X-Frame-Options "SAMEORIGIN"
Header set Referrer-Policy "strict-origin-when-cross-origin"

# Cache control for assets
<FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$">
    Header set Cache-Control "max-age=31536000, public"
</FilesMatch>

# No cache for HTML files
<FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires 0
</FilesMatch>

# Allow access to frontend/dist directory
<Directory "${DOCUMENT_ROOT}/frontend/dist">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
    
    # Additional security headers for this directory
    Header set X-Content-Security-Policy "default-src 'self'"
    Header set X-WebKit-CSP "default-src 'self'"
</Directory>

# Protect sensitive directories
<DirectoryMatch "^/.*(git|config|src|tests)/">
    Order deny,allow
    Deny from all
</DirectoryMatch>

# Debug information in server response headers
Header set X-Debug-Path "%{REQUEST_URI}e"
Header set X-Debug-Rule "%{DEBUG}e"

# Prevent directory listing
Options -Indexes