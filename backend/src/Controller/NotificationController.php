<?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\Mercure\HubInterface;
use Symfony\Component\Mercure\Update;
use Symfony\Component\Routing\Attribute\Route;

class NotificationController extends AbstractController{
    #[Route('/publish', name: 'publish')]
    public function publish(HubInterface $hub): Response
    {
        $topic = 'https://example.com/my-private-topic';
        $data = [
            'status' => 'ðŸ”” NOUVELLE NOTIFICATION: Le tacos est vraiment bon!', 
            'time' => time(),
            'id' => uniqid()
        ];
        
        // CrÃ©er la mise Ã  jour avec le topic et les donnÃ©es
        $update = new Update(
            $topic,
            json_encode($data),
            false // private = false, donc c'est public (important pour les tests)
        );

        // Publier la mise Ã  jour
        $hub->publish($update);

        return new Response(json_encode([
            'success' => true,
            'message' => 'Le tacos est vraiment bon!',
            'topic' => $topic,
            'data' => $data
        ]), 200, [
            'Content-Type' => 'application/json',
            'Access-Control-Allow-Origin' => 'http://localhost:5173',
            'Access-Control-Allow-Credentials' => 'true'
        ]);
    }

    #[Route('/mercure-info', name: 'mercure_info')]
    public function mercureInfo(): Response
    {
        $mercureUrl = $_ENV['MERCURE_URL'] ?? 'Not configured';
        $mercurePublicUrl = $_ENV['MERCURE_PUBLIC_URL'] ?? 'Not configured';
        
        return new Response(json_encode([
            'mercure_url' => $mercureUrl,
            'mercure_public_url' => $mercurePublicUrl,
            'topic' => 'https://example.com/my-private-topic'
        ]), 200, [
            'Content-Type' => 'application/json',
            'Access-Control-Allow-Origin' => 'http://localhost:5173',
            'Access-Control-Allow-Credentials' => 'true'
        ]);
    }

    #[Route('/notify-document', name: 'notify_document', methods: ['POST', 'OPTIONS'])]
    public function notifyDocument(Request $request, HubInterface $hub): Response
    {
        // GÃ©rer les requÃªtes prÃ©flight OPTIONS pour CORS
        if ($request->getMethod() === 'OPTIONS') {
            return new Response('', 200, [
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Methods' => 'POST, OPTIONS',
                'Access-Control-Allow-Headers' => 'Content-Type, Authorization',
                'Access-Control-Allow-Credentials' => 'true',
                'Access-Control-Max-Age' => '3600'
            ]);
        }
        
        // RÃ©cupÃ©rer les donnÃ©es du document depuis la requÃªte
        $content = json_decode($request->getContent(), true);
        
        if (!isset($content['documentId']) || !isset($content['documentName'])) {
            return new Response(json_encode([
                'success' => false,
                'message' => 'Les donnÃ©es du document sont manquantes'
            ]), 400, [
                'Content-Type' => 'application/json',
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Credentials' => 'true'
            ]);
        }
        
        // DÃ©finir le topic spÃ©cifique pour les documents
        $topic = 'https://example.com/documents';
        
        // CrÃ©er les donnÃ©es de notification
        $data = [
            'type' => 'document_added',
            'documentId' => $content['documentId'],
            'documentName' => $content['documentName'],
            'addedBy' => $content['addedBy'] ?? 'Utilisateur',
            'status' => $content['status'] ?? 'PENDING',
            'documentType' => $content['documentType'] ?? null,
            'timestamp' => time()
        ];
        
        // CrÃ©er la mise Ã  jour
        $update = new Update(
            $topic,
            json_encode($data),
            false // Public pour que tous les utilisateurs concernÃ©s puissent voir
        );
        
        // Publier la mise Ã  jour
        $hub->publish($update);
        
        return new Response(json_encode([
            'success' => true,
            'message' => 'Notification de document publiÃ©e',
            'topic' => $topic,
            'data' => $data
        ]), 200, [
            'Content-Type' => 'application/json',
            'Access-Control-Allow-Origin' => 'http://localhost:5173',
            'Access-Control-Allow-Credentials' => 'true'
        ]);
    }

    #[Route('/notify-cv-upload', name: 'notify_cv_upload', methods: ['POST', 'OPTIONS'])]
    public function notifyCvUpload(Request $request, HubInterface $hub): Response
    {
        // GÃ©rer les requÃªtes prÃ©flight OPTIONS pour CORS
        if ($request->getMethod() === 'OPTIONS') {
            return new Response('', 200, [
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Methods' => 'POST, OPTIONS',
                'Access-Control-Allow-Headers' => 'Content-Type, Authorization',
                'Access-Control-Allow-Credentials' => 'true',
                'Access-Control-Max-Age' => '3600'
            ]);
        }
        
        // RÃ©cupÃ©rer les donnÃ©es du document depuis la requÃªte
        $content = json_decode($request->getContent(), true);
        
        if (!isset($content['documentId']) || !isset($content['userId'])) {
            return new Response(json_encode([
                'success' => false,
                'message' => 'Les donnÃ©es du CV sont manquantes'
            ]), 400, [
                'Content-Type' => 'application/json',
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Credentials' => 'true'
            ]);
        }
        
        // Topic spÃ©cifique pour l'utilisateur (notifications personnelles)
        $userTopic = 'https://example.com/users/' . $content['userId'];
        
        // Topic pour les administrateurs (pour voir tous les nouveaux CV)
        $adminTopic = 'https://example.com/admin/documents';
        
        // DonnÃ©es de notification pour l'utilisateur
        $userData = [
            'type' => 'cv_uploaded',
            'documentId' => $content['documentId'],
            'documentName' => $content['documentName'] ?? 'CV',
            'message' => 'Votre CV a Ã©tÃ© tÃ©lÃ©chargÃ© avec succÃ¨s',
            'status' => $content['status'] ?? 'APPROVED',
            'timestamp' => time()
        ];
        
        // DonnÃ©es de notification pour les administrateurs
        $adminData = [
            'type' => 'new_cv_uploaded',
            'documentId' => $content['documentId'],
            'documentName' => $content['documentName'] ?? 'CV',
            'userId' => $content['userId'],
            'userName' => $content['userName'] ?? 'Utilisateur',
            'timestamp' => time()
        ];
        
        // CrÃ©er et publier la mise Ã  jour pour l'utilisateur
        $userUpdate = new Update(
            $userTopic,
            json_encode($userData),
            true // PrivÃ© - seulement pour l'utilisateur concernÃ©
        );
        $hub->publish($userUpdate);
        
        // CrÃ©er et publier la mise Ã  jour pour les administrateurs
        $adminUpdate = new Update(
            $adminTopic,
            json_encode($adminData),
            false // Public pour tous les administrateurs
        );
        $hub->publish($adminUpdate);
        
        return new Response(json_encode([
            'success' => true,
            'message' => 'Notifications de CV publiÃ©es',
            'userTopic' => $userTopic,
            'adminTopic' => $adminTopic
        ]), 200, [
            'Content-Type' => 'application/json',
            'Access-Control-Allow-Origin' => 'http://localhost:5173',
            'Access-Control-Allow-Credentials' => 'true'
        ]);
    }

    #[Route('/notify-document-status-change', name: 'notify_document_status', methods: ['POST', 'OPTIONS'])]
    public function notifyDocumentStatusChange(Request $request, HubInterface $hub): Response
    {
        // GÃ©rer les requÃªtes prÃ©flight OPTIONS pour CORS
        if ($request->getMethod() === 'OPTIONS') {
            return new Response('', 200, [
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Methods' => 'POST, OPTIONS',
                'Access-Control-Allow-Headers' => 'Content-Type, Authorization',
                'Access-Control-Allow-Credentials' => 'true',
                'Access-Control-Max-Age' => '3600'
            ]);
        }
        
        // RÃ©cupÃ©rer les donnÃ©es du document depuis la requÃªte
        $content = json_decode($request->getContent(), true);
        
        if (!isset($content['documentId']) || !isset($content['status']) || !isset($content['userId'])) {
            return new Response(json_encode([
                'success' => false,
                'message' => 'Les donnÃ©es du document sont manquantes'
            ]), 400, [
                'Content-Type' => 'application/json',
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Credentials' => 'true'
            ]);
        }
        
        // Topic spÃ©cifique pour l'utilisateur
        $userTopic = 'https://example.com/users/' . $content['userId'];
        
        // CrÃ©er les donnÃ©es de notification
        $data = [
            'type' => 'document_status_changed',
            'documentId' => $content['documentId'],
            'documentName' => $content['documentName'] ?? 'Document',
            'oldStatus' => $content['oldStatus'] ?? null,
            'newStatus' => $content['status'],
            'comment' => $content['comment'] ?? null,
            'timestamp' => time()
        ];
        
        // Message adaptÃ© selon le statut
        if ($content['status'] === 'APPROVED') {
            $data['message'] = 'Votre document a Ã©tÃ© approuvÃ©';
        } elseif ($content['status'] === 'REJECTED') {
            $data['message'] = 'Votre document a Ã©tÃ© rejetÃ©' . ($content['comment'] ? ' : ' . $content['comment'] : '');
        }
        
        // CrÃ©er la mise Ã  jour
        $update = new Update(
            $userTopic,
            json_encode($data),
            true // PrivÃ© - seulement pour l'utilisateur concernÃ©
        );
        
        // Publier la mise Ã  jour
        $hub->publish($update);
        
        return new Response(json_encode([
            'success' => true,
            'message' => 'Notification de changement de statut publiÃ©e',
            'topic' => $userTopic,
            'data' => $data
        ]), 200, [
            'Content-Type' => 'application/json',
            'Access-Control-Allow-Origin' => 'http://localhost:5173',
            'Access-Control-Allow-Credentials' => 'true'
        ]);
    }

    #[Route('/notify-document-deletion', name: 'notify_document_deletion', methods: ['POST', 'OPTIONS'])]
    public function notifyDocumentDeletion(Request $request, HubInterface $hub): Response
    {
        // GÃ©rer les requÃªtes prÃ©flight OPTIONS pour CORS
        if ($request->getMethod() === 'OPTIONS') {
            return new Response('', 200, [
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Methods' => 'POST, OPTIONS',
                'Access-Control-Allow-Headers' => 'Content-Type, Authorization',
                'Access-Control-Allow-Credentials' => 'true',
                'Access-Control-Max-Age' => '3600'
            ]);
        }
        
        // RÃ©cupÃ©rer les donnÃ©es du document depuis la requÃªte
        $content = json_decode($request->getContent(), true);
        
        if (!isset($content['documentId']) || !isset($content['userId']) || !isset($content['documentName'])) {
            return new Response(json_encode([
                'success' => false,
                'message' => 'Les donnÃ©es du document sont manquantes'
            ]), 400, [
                'Content-Type' => 'application/json',
                'Access-Control-Allow-Origin' => 'http://localhost:5173',
                'Access-Control-Allow-Credentials' => 'true'
            ]);
        }
        
        // Topic spÃ©cifique pour l'utilisateur
        $userTopic = 'https://example.com/users/' . $content['userId'];
        
        // Topic pour les administrateurs (si besoin)
        $adminTopic = 'https://example.com/admin/documents';
        
        // CrÃ©er les donnÃ©es de notification pour l'utilisateur
        $userData = [
            'type' => 'document_deleted',
            'documentId' => $content['documentId'],
            'documentName' => $content['documentName'],
            'message' => 'Votre document a Ã©tÃ© supprimÃ©',
            'timestamp' => time()
        ];
        
        // CrÃ©er les donnÃ©es de notification pour les administrateurs (si nÃ©cessaire)
        $adminData = [
            'type' => 'document_deleted',
            'documentId' => $content['documentId'],
            'documentName' => $content['documentName'],
            'userId' => $content['userId'],
            'userName' => $content['userName'] ?? 'Utilisateur',
            'deletedBy' => $content['deletedBy'] ?? $content['userName'] ?? 'Utilisateur',
            'timestamp' => time()
        ];
        
        // CrÃ©er et publier la mise Ã  jour pour l'utilisateur
        $userUpdate = new Update(
            $userTopic,
            json_encode($userData),
            true // PrivÃ© - seulement pour l'utilisateur concernÃ©
        );
        $hub->publish($userUpdate);
        
        // Publier Ã©galement pour les administrateurs si nÃ©cessaire
        if (isset($content['notifyAdmin']) && $content['notifyAdmin'] === true) {
            $adminUpdate = new Update(
                $adminTopic,
                json_encode($adminData),
                false // Public pour tous les administrateurs
            );
            $hub->publish($adminUpdate);
        }
        
        return new Response(json_encode([
            'success' => true,
            'message' => 'Notification de suppression publiÃ©e',
            'userTopic' => $userTopic
        ]), 200, [
            'Content-Type' => 'application/json',
            'Access-Control-Allow-Origin' => 'http://localhost:5173',
            'Access-Control-Allow-Credentials' => 'true'
        ]);
    }
}

?>