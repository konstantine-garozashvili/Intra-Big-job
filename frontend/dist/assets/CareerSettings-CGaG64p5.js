import{j as e}from"./ui-B5ZVMT00.js";import{r as s,b as a}from"./router-Cgxi-4fo.js";import{y as r,x as t,a8 as i,Y as l,t as n,D as o,k as d,H as c,l as m,n as u,I as p,B as h,R as x,P as y,g,h as j,f as b,i as v,a9 as f,aa as D,ab as N,V as w,b as S}from"./index-XAN29Is_.js";import{P as A}from"./ProfileSettingsSkeleton-BdE-90xB.js";import{u as E,b as k,a as C}from"./query-DUefEkVx.js";import"./separator-Bm3T7Scp.js";import"./input-C0qWiGl4.js";import{C as U,J as I}from"./JobSeekingSettings-BtFVI_oL.js";import"./label-SSxY3P1H.js";import{C as M,a as P,b as R,c as T,d as V,e as _}from"./command-C33rxl9l.js";import{f as L}from"./index-D4PYUcdn.js";import{C as O}from"./chevrons-up-down-DH6MeUzj.js";import{T as Q}from"./trash-2-DTjWsaJ7.js";import"./react-0RZ2pslC.js";import"./charts-D4j3G6dB.js";import"./phone-input-ChH8hFiB.js";import"./pencil-CSf7c9nA.js";import"./download-X3v4VPHE.js";import"./upload-B6u2oBlv.js";import"./circle-check-x9OTPsRV.js";import"./circle-alert-DsiMPx8y.js";import"./switch-C4vXYI_w.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=r("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),F=r("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),z=e=>!!e&&(Array.isArray(e)?e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_ADMIN"===s||"ADMIN"===s})):"ROLE_ADMIN"===e||"ADMIN"===e),G=e=>!!e&&(Array.isArray(e)?e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_STUDENT"===s||"STUDENT"===s})):"ROLE_STUDENT"===e||"STUDENT"===e),K=e=>{if(!e)return!1;if(Array.isArray(e)){return e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_GUEST"===s||"GUEST"===s}))}if(Array.isArray(e)){console.log("isGuest check with array:",e);const s=e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e,a="ROLE_GUEST"===s||"GUEST"===s;return console.log(`Role ${s} is guest? ${a}`),a}));return console.log("isGuest result with array:",s),s}console.log("isGuest check with string:",e);const s="ROLE_GUEST"===e||"GUEST"===e;return console.log("isGuest result with string:",s),s},$=e=>z(e)||G(e)||K(e)||(e=>!!e&&(Array.isArray(e)?e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_SUPER_ADMIN"===s||"SUPER_ADMIN"===s||"SUPERADMIN"===s})):"ROLE_SUPER_ADMIN"===e||"SUPER_ADMIN"===e||"SUPERADMIN"===e))(e),J={listeners:new Set,subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)},notify(){this.listeners.forEach((e=>e()))}},H={clearUserDiplomas(){localStorage.removeItem("user_diplomas_cache")},clearAvailableDiplomas(){localStorage.removeItem("available_diplomas_cache")},clearAll(){this.clearUserDiplomas(),this.clearAvailableDiplomas()}};const B=new class{async getAvailableDiplomas(e=!0){try{const s=e?`/api/user-diplomas/available?_=${Date.now()}`:"/api/user-diplomas/available",a=await t.get(s);return H.clearAvailableDiplomas(),a.data}catch(s){throw s}}async getUserDiplomas(e=!0){try{const s=e?`/api/user-diplomas?_=${Date.now()}`:"/api/user-diplomas",a=await t.get(s);return H.clearUserDiplomas(),a.data}catch(s){throw s}}async addUserDiploma(e){try{H.clearAll();const s=await t.post("/api/user-diplomas",e);return J.notify(),this.getUserDiplomas(!0).catch((()=>{})),this.getAvailableDiplomas(!0).catch((()=>{})),s.data}catch(s){throw s}}async deleteUserDiploma(e){try{H.clearAll();const s=await t.delete(`/api/user-diplomas/${e}`);return J.notify(),this.getUserDiplomas(!0).catch((()=>{})),this.getAvailableDiplomas(!0).catch((()=>{})),s.data}catch(s){throw s}}},W=({userData:r,diplomas:t,setDiplomas:N})=>{const w=E(),S=r?.role,[A,k]=s.useState(!1),[C,U]=s.useState(!1),[I,J]=s.useState(null),[H,W]=s.useState({diplomaId:"",obtainedDate:L(new Date,"yyyy-MM-dd")}),[Y,X]=s.useState(""),[Z,ee]=s.useState(!1),{data:se,isLoading:ae,refetch:re}=i("/api/user-diplomas/available","availableDiplomas",{onError:e=>{n.error("Erreur lors du chargement des diplômes")}}),{refetch:te}=i("/api/user-diplomas","userDiplomas",{enabled:!0,onSuccess:e=>{e&&Array.isArray(e)?N(e):e&&e.data&&Array.isArray(e.data)&&N(e.data)},onError:e=>{console.error("Error fetching user diplomas:",e)}});s.useEffect((()=>{t&&Array.isArray(t)&&re()}),[t,re]);const ie=()=>{w.invalidateQueries(["userDiplomas"]),w.invalidateQueries(["availableDiplomas"]),w.invalidateQueries(["/api/profile"]),setTimeout((()=>{B.getUserDiplomas().then((e=>{})).catch((e=>{})),B.getAvailableDiplomas().then((e=>{})).catch((e=>{})),te(),re()}),500)},le=a.useMemo((()=>se?se.success&&Array.isArray(se.data)?se.data:Array.isArray(se)?se:[]:[]),[se]),ne=l("/api/user-diplomas","post","userDiplomas",{onSuccess:e=>{n.success("Diplôme ajouté avec succès"),w.invalidateQueries(["userDiplomas"]),w.invalidateQueries(["/api/profile"]),setTimeout((()=>{re(),B.getAvailableDiplomas().catch((e=>console.error("[DiplomaManager] Error fetching available diplomas:",e)))}),300),ie();const s=e.data||e,a=[...t,s].sort(((e,s)=>{const a=new Date(e.obtainedDate);return new Date(s.obtainedDate)-a}));N(a),document.dispatchEvent(new CustomEvent("user:data-updated")),W({diplomaId:"",obtainedDate:L(new Date,"yyyy-MM-dd")}),k(!1)},onError:e=>{if(e.response){if(400===e.response.status){const s=e.response.data;if(s&&s.message&&s.message.includes("already has this diploma"))return void X("Vous possédez déjà ce diplôme dans votre profil");if(s&&s.message)return void X(s.message)}if(409===e.response.status)return void X("Vous possédez déjà ce diplôme dans votre profil")}X("Erreur lors de l'ajout du diplôme")}}),oe=l((e=>`/api/user-diplomas/${e}`),"delete","userDiplomas",{onSuccess:(e,s)=>{n.success("Diplôme supprimé avec succès"),w.invalidateQueries(["userDiplomas"]),w.invalidateQueries(["/api/profile"]),setTimeout((()=>{re(),B.getAvailableDiplomas().catch((e=>console.error("[DiplomaManager] Error fetching available diplomas:",e)))}),300),ie(),N(t.filter((e=>e.id!==s))),J(null),document.dispatchEvent(new CustomEvent("user:data-updated"))},onError:e=>{n.error("Erreur lors de la suppression du diplôme")}});return z(S)||G(S)||K(S)?e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{open:C,onOpenChange:U,children:e.jsxs(d,{children:[e.jsxs(c,{children:[e.jsx(m,{children:"Confirmer la suppression"}),e.jsxs(u,{children:['Êtes-vous sûr de vouloir supprimer le diplôme "',I?.diploma?.name,'" ? Cette action est irréversible.']})]}),e.jsxs(p,{className:"flex justify-end space-x-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{U(!1),J(null)},children:"Annuler"}),e.jsx(h,{variant:"destructive",onClick:()=>{I&&I.id?(oe.mutate(I.id),U(!1)):n.error("Aucun diplôme à supprimer")},disabled:oe.isPending,children:oe.isPending?"Suppression...":"Supprimer"})]})]})}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(x,{className:"h-5 w-5 text-blue-600"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Gestion des diplômes"})]}),ae?e.jsx("div",{className:"flex justify-center items-center py-6",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs(e.Fragment,{children:[$(S)&&!A&&e.jsxs("button",{onClick:()=>k(!0),className:"w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg border-2 border-dashed border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition-all",children:[e.jsx(q,{className:"h-5 w-5"}),e.jsx("span",{children:"Ajouter un diplôme"})]}),A&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-4",children:[e.jsx("h3",{className:"text-base font-medium",children:"Ajouter un diplôme"}),Y&&e.jsx("div",{className:"text-sm text-red-500 p-2 bg-red-50 rounded-md",children:Y}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Diplôme"}),e.jsxs(y,{open:Z,onOpenChange:ee,children:[e.jsx(g,{asChild:!0,children:e.jsxs(h,{variant:"outline",role:"combobox","aria-expanded":Z,className:"w-full justify-between",children:[e.jsx("span",{className:"truncate",children:H.diplomaId?le.find((e=>e.id.toString()===H.diplomaId))?.name:"Sélectionner un diplôme..."}),e.jsx(O,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(j,{className:"w-[var(--radix-popover-trigger-width)] p-0",children:e.jsxs(M,{children:[e.jsx(P,{placeholder:"Rechercher un diplôme..."}),e.jsxs(R,{children:[e.jsx(T,{children:"Aucun diplôme trouvé."}),e.jsx(V,{children:le.map((s=>{const a=t.some((e=>e.diploma.id.toString()===s.id.toString()));return e.jsxs(_,{value:s.name,disabled:a,onSelect:()=>{W({...H,diplomaId:s.id.toString()}),Y&&X(""),ee(!1)},className:b(a&&"opacity-50","flex items-center justify-between"),children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsx("span",{className:"text-sm text-gray-500",children:s.institution})]}),H.diplomaId===s.id.toString()&&e.jsx(v,{className:"h-4 w-4 shrink-0"})]},s.id)}))})]})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"date-obtention",className:"block text-sm font-medium text-gray-700",children:"Date d'obtention"}),e.jsx("input",{id:"date-obtention",type:"date",value:H.obtainedDate,onChange:e=>{W({...H,obtainedDate:e.target.value}),Y&&X("")},className:"w-full rounded-md border border-gray-200 px-3 py-2 text-sm"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsxs(h,{variant:"outline",onClick:()=>{k(!1),W({diplomaId:"",obtainedDate:L(new Date,"yyyy-MM-dd")})},className:"text-sm",children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Annuler"]}),e.jsx(h,{onClick:async()=>{if(!H.diplomaId)return void X("Veuillez sélectionner un diplôme");if(!H.obtainedDate)return void X("Veuillez sélectionner une date d'obtention");t.some((e=>e.diploma&&"object"==typeof e.diploma?e.diploma.id.toString()===H.diplomaId.toString():e.id.toString()===H.diplomaId.toString()))?X("Vous possédez déjà ce diplôme dans votre profil"):(X(""),ne.mutate(H))},disabled:ne.isPending,className:"text-sm",children:ne.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),e.jsx("span",{children:"Enregistrement..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"Enregistrer"]})})]})]}),t&&t.length>0?e.jsx("div",{className:"space-y-3",children:t.map((s=>e.jsxs("div",{className:"flex items-start justify-between gap-4 py-3",children:[e.jsxs("div",{className:"flex items-start gap-3 min-w-0",children:[e.jsx(x,{className:"h-5 w-5 text-gray-400 flex-shrink-0 mt-1"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 truncate",children:s.diploma.name}),e.jsx("p",{className:"text-sm text-gray-500 truncate",children:s.diploma.institution}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Obtenu le ",L(new Date(s.obtainedDate),"dd MMMM yyyy",{locale:D})]})]})]}),$(S)&&e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>(async e=>{e&&e.id?(J(e),U(!0)):n.error("Diplôme introuvable")})(s),disabled:oe.isPending,className:"h-8 w-8 text-red-500 hover:text-red-600",children:oe.isPending&&oe.variables===s.id?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-red-500"}):e.jsx(Q,{className:"h-4 w-4"})})]},s.id)))}):e.jsxs("div",{className:"text-center py-6",children:[e.jsx(x,{className:"h-12 w-12 mx-auto text-gray-400 mb-3"}),e.jsx("p",{className:"text-gray-500",children:"Vous n'avez pas encore ajouté de diplômes à votre profil."}),$(S)&&!A&&e.jsxs(h,{variant:"outline",onClick:()=>k(!0),className:"mt-4",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Ajouter un diplôme"]})]})]})]}):null},Y=()=>{const a=E(),[r,t]=s.useState(null),{data:i,isLoading:l,isFetching:o,status:d}=k({queryKey:["currentUser"],queryFn:async()=>{try{const e=await S.getCurrentUser();if(!e||!e.roles||!Array.isArray(e.roles)||0===e.roles.length)throw new Error("Données utilisateur invalides");return e}catch(e){throw e}},staleTime:3e5,retry:2,onError:e=>{t("Impossible de charger vos informations. Veuillez rafraîchir la page.")}}),c=i?.roles?.[0]||null,m=G(c),u=K(c),p="success"===d&&(m||u),{data:h,isLoading:x,isFetching:y}=k({queryKey:["studentProfile"],queryFn:w.getMyProfile,enabled:"success"===d&&!!i?.roles?.includes("ROLE_STUDENT"),staleTime:3e4,refetchOnMount:!0,refetchOnWindowFocus:!0,retry:2,onError:()=>{}}),{data:g,isLoading:j,isFetching:b}=k({queryKey:["documents","CV"],queryFn:()=>N.getDocumentByType("CV",!1),enabled:p,staleTime:12e4,retry:1,onError:()=>{}}),v=g&&Array.isArray(g)&&g.length>0?g[0]:null,{data:f,isLoading:D,isFetching:M}=k({queryKey:["userDiplomas"],queryFn:B.getUserDiplomas,enabled:p,staleTime:12e4,retry:1,select:e=>e&&Array.isArray(e)?[...e].sort(((e,s)=>{const a=new Date(e.obtainedDate||"1900-01-01");return new Date(s.obtainedDate||"1900-01-01")-a})):[],onError:()=>{}}),P=C({mutationFn:e=>{const s=new FormData;return s.append("file",e),N.uploadCV(s)},onSuccess:()=>{a.invalidateQueries({queryKey:["documents","CV"]}),n.success("CV téléversé avec succès")},onError:e=>{n.error("Erreur lors du téléversement du CV")}}),R=C({mutationFn:e=>N.deleteDocument(e),onSuccess:()=>{a.invalidateQueries({queryKey:["documents","CV"]}),N.clearCache(),n.success("CV supprimé avec succès")},onError:e=>{n.error("Erreur lors de la suppression du CV")}}),T=C({mutationFn:e=>w.updateJobSeekingStatus(e),onMutate:async e=>{await a.cancelQueries({queryKey:["studentProfile"]});const s=a.getQueryData(["studentProfile"]);return a.setQueryData(["studentProfile"],(s=>{if(!s)return s;const a=JSON.parse(JSON.stringify(s));return a.studentProfile?(a.studentProfile.isSeekingInternship=e.isSeekingInternship,a.studentProfile.isSeekingApprenticeship=e.isSeekingApprenticeship):(a.isSeekingInternship=e.isSeekingInternship,a.isSeekingApprenticeship=e.isSeekingApprenticeship),a})),{previousProfile:s}},onError:(e,s,r)=>{r?.previousProfile&&a.setQueryData(["studentProfile"],r.previousProfile),n.error("Erreur lors de la mise à jour du profil")},onSuccess:e=>{a.setQueryData(["studentProfile"],(s=>s?{...s,...e}:e)),a.invalidateQueries({queryKey:["studentProfile"],refetchActive:!0,refetchInactive:!0})}});return l&&!i||G&&x&&!h||p&&j&&!g||p&&D&&!f?e.jsx("div",{className:"space-y-6 bg-white p-6 rounded-lg shadow",children:e.jsx(A,{type:"career"})}):r?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("p",{className:"text-red-500 mb-4",children:r}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600",children:"Réessayer"})]}):"success"!==d||G||K?e.jsxs("div",{className:"w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold mb-4 sm:mb-6",children:"Gestion de carrière"}),e.jsxs("div",{className:"space-y-6 sm:space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold mb-2 sm:mb-4",children:"Curriculum Vitae"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 sm:mb-6",children:"Votre CV est essentiel pour vos candidatures. Assurez-vous qu'il est à jour et reflète vos compétences actuelles."}),e.jsx(U,{cvDocument:v,onUpload:e=>P.mutate(e),onDelete:e=>R.mutate(e),onDownload:async e=>{if(e)try{const s=await N.downloadDocument(e),a=window.URL.createObjectURL(s),r=document.createElement("a");r.style.display="none",r.href=a,r.download=v?.name||"cv.pdf",document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(a),document.body.removeChild(r),n.success("Document importé avec succès")}catch(s){n.error("Erreur lors du téléchargement du document")}else n.error("Impossible de télécharger le document: ID manquant")}})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold mb-2 sm:mb-4",children:"Diplômes"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 sm:mb-6",children:"Ajoutez vos diplômes pour mettre en valeur votre parcours académique auprès des recruteurs."}),e.jsx(W,{userData:{role:c},diplomas:f||[],setDiplomas:e=>{a.setQueryData(["userDiplomas"],e),a.invalidateQueries(["userDiplomas"]),a.refetchQueries(["userDiplomas"]),a.invalidateQueries(["/api/profile"]),B.getUserDiplomas().catch((e=>console.error("[CareerSettings] Error directly fetching user diplomas:",e)))}})]}),G&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold mb-2 sm:mb-4",children:"Recherche d'emploi"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 sm:mb-6",children:"Indiquez si vous êtes à la recherche d'un stage ou d'une alternance pour être visible auprès des recruteurs."}),e.jsx(I,{profile:h?.data,onProfileUpdate:e=>{T.mutate(e)}})]})]})]}):e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"text-gray-500",children:"Cette section est réservée aux étudiants et aux invités."})})};export{Y as default};
