import{j as e}from"./ui-CEgDFHEN.js";import{r as s,b as a}from"./router-Cgxi-4fo.js";import{z as r,y as i,aa as t,Y as l,t as o,D as n,k as c,I as d,l as m,n as u,J as p,B as h,R as g,P as x,g as y,h as v,f as b,i as f,ab as D,ac as j,ad as N,V as w,b as S}from"./index-BnANEtVp.js";import{P as A}from"./ProfileSettingsSkeleton-DHINh_0Q.js";import{u as E,b as C,a as U}from"./query-CdiCT4_A.js";import{C as M,J as I}from"./JobSeekingSettings-DsbrGPRZ.js";import"./input-DQoClNUI.js";import"./label-T_DAMYbi.js";import{C as P,a as k,b as R,c as T,d as V,e as _}from"./command-BVDWa1pB.js";import{f as Q}from"./index-DLO_YBUS.js";import{P as F}from"./plus-DuVqBw9_.js";import{C as L}from"./chevrons-up-down-CwAy8pCf.js";import{T as O}from"./trash-2-B7QEiv6g.js";import"./react-0RZ2pslC.js";import"./charts-D4j3G6dB.js";import"./phone-input-DxSsdugA.js";import"./download-BlJ8yCz1.js";import"./circle-alert-MkLjJhtw.js";import"./switch-CIzLH02W.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=r("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),z=e=>!!e&&(Array.isArray(e)?e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_ADMIN"===s||"ADMIN"===s})):"ROLE_ADMIN"===e||"ADMIN"===e),G=e=>!!e&&(Array.isArray(e)?e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_STUDENT"===s||"STUDENT"===s})):"ROLE_STUDENT"===e||"STUDENT"===e),K=e=>{if(!e)return console.log("isGuest check with null/undefined userRole"),!1;if(Array.isArray(e)){console.log("isGuest check with array:",e);const s=e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e,a="ROLE_GUEST"===s||"GUEST"===s;return console.log(`Role ${s} is guest? ${a}`),a}));return console.log("isGuest result with array:",s),s}console.log("isGuest check with string:",e);const s="ROLE_GUEST"===e||"GUEST"===e;return console.log("isGuest result with string:",s),s},$=e=>z(e)||G(e)||K(e)||(e=>!!e&&(Array.isArray(e)?e.some((e=>{const s="object"==typeof e&&null!==e?e.name:e;return"ROLE_SUPER_ADMIN"===s||"SUPER_ADMIN"===s||"SUPERADMIN"===s})):"ROLE_SUPER_ADMIN"===e||"SUPER_ADMIN"===e||"SUPERADMIN"===e))(e),J={listeners:new Set,subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)},notify(){this.listeners.forEach((e=>e()))}},B={clearUserDiplomas(){console.log("[DiplomaService] Clearing user diplomas cache"),localStorage.removeItem("user_diplomas_cache")},clearAvailableDiplomas(){console.log("[DiplomaService] Clearing available diplomas cache"),localStorage.removeItem("available_diplomas_cache")},clearAll(){this.clearUserDiplomas(),this.clearAvailableDiplomas()}};const H=new class{async getAvailableDiplomas(e=!0){try{console.log("[DiplomaService] Calling API for available diplomas");const s=e?`/api/user-diplomas/available?_=${Date.now()}`:"/api/user-diplomas/available",a=await i.get(s);return console.log("[DiplomaService] API response for available diplomas received"),B.clearAvailableDiplomas(),a.data}catch(s){throw console.error("[DiplomaService] Error in getAvailableDiplomas:",s),s}}async getUserDiplomas(e=!0){try{console.log("[DiplomaService] Calling API for user diplomas");const s=e?`/api/user-diplomas?_=${Date.now()}`:"/api/user-diplomas",a=await i.get(s);return console.log("[DiplomaService] API response for user diplomas received"),B.clearUserDiplomas(),a.data}catch(s){throw console.error("[DiplomaService] Error in getUserDiplomas:",s),s}}async addUserDiploma(e){try{console.log("[DiplomaService] Adding user diploma",e),B.clearAll();const s=await i.post("/api/user-diplomas",e);return console.log("[DiplomaService] Diploma added successfully"),B.clearAll(),J.notify(),this.getUserDiplomas(!0).catch((e=>console.error("[DiplomaService] Error refetching user diplomas after add:",e))),this.getAvailableDiplomas(!0).catch((e=>console.error("[DiplomaService] Error refetching available diplomas after add:",e))),s.data}catch(s){throw console.error("[DiplomaService] Error in addUserDiploma:",s),s}}async deleteUserDiploma(e){try{console.log("[DiplomaService] Deleting user diploma",e),B.clearAll();const s=await i.delete(`/api/user-diplomas/${e}`);return console.log("[DiplomaService] Diploma deleted successfully"),B.clearAll(),J.notify(),this.getUserDiplomas(!0).catch((e=>console.error("[DiplomaService] Error refetching user diplomas after delete:",e))),this.getAvailableDiplomas(!0).catch((e=>console.error("[DiplomaService] Error refetching available diplomas after delete:",e))),s.data}catch(s){throw console.error("[DiplomaService] Error in deleteUserDiploma:",s),s}}},Y=({userData:r,diplomas:i,setDiplomas:N})=>{const w=E(),S=r?.role,[A,C]=s.useState(!1),[U,M]=s.useState(!1),[I,J]=s.useState(null),[B,Y]=s.useState({diplomaId:"",obtainedDate:Q(new Date,"yyyy-MM-dd")}),[W,Z]=s.useState(""),[X,ee]=s.useState(!1),{data:se,isLoading:ae,refetch:re}=t("/api/user-diplomas/available","availableDiplomas",{onError:e=>{o.error("Erreur lors du chargement des diplômes")}}),{refetch:ie}=t("/api/user-diplomas","userDiplomas",{enabled:!0,onSuccess:e=>{console.log("[DiplomaManager] Successfully fetched user diplomas:",e),e&&Array.isArray(e)?N(e):e&&e.data&&Array.isArray(e.data)&&N(e.data)},onError:e=>{console.error("Error fetching user diplomas:",e)}});s.useEffect((()=>{i&&Array.isArray(i)&&re()}),[i,re]);const te=()=>{console.log("[DiplomaManager] Force refreshing all diploma data"),w.invalidateQueries(["userDiplomas"]),w.invalidateQueries(["availableDiplomas"]),w.invalidateQueries(["/api/profile"]),setTimeout((()=>{console.log("[DiplomaManager] Calling getUserDiplomas directly"),H.getUserDiplomas().then((e=>console.log("[DiplomaManager] Direct getUserDiplomas success"))).catch((e=>console.error("[DiplomaManager] Error in direct getUserDiplomas call:",e))),console.log("[DiplomaManager] Calling getAvailableDiplomas directly"),H.getAvailableDiplomas().then((e=>console.log("[DiplomaManager] Direct getAvailableDiplomas success"))).catch((e=>console.error("[DiplomaManager] Error in direct getAvailableDiplomas call:",e))),ie(),re()}),500)},le=a.useMemo((()=>se?se.success&&Array.isArray(se.data)?se.data:Array.isArray(se)?se:[]:[]),[se]),oe=l("/api/user-diplomas","post","userDiplomas",{onSuccess:e=>{o.success("Diplôme ajouté avec succès"),w.invalidateQueries(["userDiplomas"]),w.invalidateQueries(["/api/profile"]),setTimeout((()=>{console.log("[DiplomaManager] Refetching available diplomas after add"),re(),H.getAvailableDiplomas().catch((e=>console.error("[DiplomaManager] Error fetching available diplomas:",e)))}),300),te();const s=e.data||e,a=[...i,s].sort(((e,s)=>{const a=new Date(e.obtainedDate);return new Date(s.obtainedDate)-a}));N(a),document.dispatchEvent(new CustomEvent("user:data-updated")),Y({diplomaId:"",obtainedDate:Q(new Date,"yyyy-MM-dd")}),C(!1)},onError:e=>{if(e.response){if(400===e.response.status){const s=e.response.data;if(s&&s.message&&s.message.includes("already has this diploma"))return void Z("Vous possédez déjà ce diplôme dans votre profil");if(s&&s.message)return void Z(s.message)}if(409===e.response.status)return void Z("Vous possédez déjà ce diplôme dans votre profil")}Z("Erreur lors de l'ajout du diplôme")}}),ne=l((e=>`/api/user-diplomas/${e}`),"delete","userDiplomas",{onSuccess:(e,s)=>{o.success("Diplôme supprimé avec succès"),w.invalidateQueries(["userDiplomas"]),w.invalidateQueries(["/api/profile"]),setTimeout((()=>{console.log("[DiplomaManager] Refetching available diplomas after delete"),re(),H.getAvailableDiplomas().catch((e=>console.error("[DiplomaManager] Error fetching available diplomas:",e)))}),300),te(),N(i.filter((e=>e.id!==s))),J(null),document.dispatchEvent(new CustomEvent("user:data-updated"))},onError:e=>{o.error("Erreur lors de la suppression du diplôme")}});return z(S)||G(S)||K(S)?e.jsxs("div",{className:"space-y-4",children:[e.jsx(n,{open:U,onOpenChange:M,children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(m,{children:"Confirmer la suppression"}),e.jsxs(u,{children:['Êtes-vous sûr de vouloir supprimer le diplôme "',I?.diploma?.name,'" ? Cette action est irréversible.']})]}),e.jsxs(p,{className:"flex justify-end space-x-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{M(!1),J(null)},children:"Annuler"}),e.jsx(h,{variant:"destructive",onClick:()=>{I&&I.id?(ne.mutate(I.id),M(!1)):o.error("Aucun diplôme à supprimer")},disabled:ne.isPending,children:ne.isPending?"Suppression...":"Supprimer"})]})]})}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(g,{className:"h-5 w-5 text-blue-600"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Gestion des diplômes"})]}),ae?e.jsx("div",{className:"flex justify-center items-center py-6",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs(e.Fragment,{children:[$(S)&&!A&&e.jsxs("button",{onClick:()=>C(!0),className:"w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg border-2 border-dashed border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition-all",children:[e.jsx(F,{className:"h-5 w-5"}),e.jsx("span",{children:"Ajouter un diplôme"})]}),A&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-4",children:[e.jsx("h3",{className:"text-base font-medium",children:"Ajouter un diplôme"}),W&&e.jsx("div",{className:"text-sm text-red-500 p-2 bg-red-50 rounded-md",children:W}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Diplôme"}),e.jsxs(x,{open:X,onOpenChange:ee,children:[e.jsx(y,{asChild:!0,children:e.jsxs(h,{variant:"outline",role:"combobox","aria-expanded":X,className:"w-full justify-between",children:[e.jsx("span",{className:"truncate",children:B.diplomaId?le.find((e=>e.id.toString()===B.diplomaId))?.name:"Sélectionner un diplôme..."}),e.jsx(L,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(v,{className:"w-[var(--radix-popover-trigger-width)] p-0",children:e.jsxs(P,{children:[e.jsx(k,{placeholder:"Rechercher un diplôme..."}),e.jsxs(R,{children:[e.jsx(T,{children:"Aucun diplôme trouvé."}),e.jsx(V,{children:le.map((s=>{const a=i.some((e=>e.diploma.id.toString()===s.id.toString()));return e.jsxs(_,{value:s.name,disabled:a,onSelect:()=>{Y({...B,diplomaId:s.id.toString()}),W&&Z(""),ee(!1)},className:b(a&&"opacity-50","flex items-center justify-between"),children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsx("span",{className:"text-sm text-gray-500",children:s.institution})]}),B.diplomaId===s.id.toString()&&e.jsx(f,{className:"h-4 w-4 shrink-0"})]},s.id)}))})]})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"date-obtention",className:"block text-sm font-medium text-gray-700",children:"Date d'obtention"}),e.jsx("input",{id:"date-obtention",type:"date",value:B.obtainedDate,onChange:e=>{Y({...B,obtainedDate:e.target.value}),W&&Z("")},className:"w-full rounded-md border border-gray-200 px-3 py-2 text-sm"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsxs(h,{variant:"outline",onClick:()=>{C(!1),Y({diplomaId:"",obtainedDate:Q(new Date,"yyyy-MM-dd")})},className:"text-sm",children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),"Annuler"]}),e.jsx(h,{onClick:async()=>{if(!B.diplomaId)return void Z("Veuillez sélectionner un diplôme");if(!B.obtainedDate)return void Z("Veuillez sélectionner une date d'obtention");i.some((e=>e.diploma&&"object"==typeof e.diploma?e.diploma.id.toString()===B.diplomaId.toString():e.id.toString()===B.diplomaId.toString()))?Z("Vous possédez déjà ce diplôme dans votre profil"):(Z(""),oe.mutate(B))},disabled:oe.isPending,className:"text-sm",children:oe.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),e.jsx("span",{children:"Enregistrement..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Enregistrer"]})})]})]}),i&&i.length>0?e.jsx("div",{className:"space-y-3",children:i.map((s=>e.jsxs("div",{className:"flex items-start justify-between gap-4 py-3",children:[e.jsxs("div",{className:"flex items-start gap-3 min-w-0",children:[e.jsx(g,{className:"h-5 w-5 text-gray-400 flex-shrink-0 mt-1"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 truncate",children:s.diploma.name}),e.jsx("p",{className:"text-sm text-gray-500 truncate",children:s.diploma.institution}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Obtenu le ",Q(new Date(s.obtainedDate),"dd MMMM yyyy",{locale:j})]})]})]}),$(S)&&e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>(async e=>{e&&e.id?(J(e),M(!0)):o.error("Diplôme introuvable")})(s),disabled:ne.isPending,className:"h-8 w-8 text-red-500 hover:text-red-600",children:ne.isPending&&ne.variables===s.id?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-red-500"}):e.jsx(O,{className:"h-4 w-4"})})]},s.id)))}):e.jsxs("div",{className:"text-center py-6",children:[e.jsx(g,{className:"h-12 w-12 mx-auto text-gray-400 mb-3"}),e.jsx("p",{className:"text-gray-500",children:"Vous n'avez pas encore ajouté de diplômes à votre profil."}),$(S)&&!A&&e.jsxs(h,{variant:"outline",onClick:()=>C(!0),className:"mt-4",children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"Ajouter un diplôme"]})]})]})]}):null},W=()=>{const a=E(),[r,i]=s.useState(null),{data:t,isLoading:l,isFetching:n,status:c}=C({queryKey:["currentUser"],queryFn:async()=>{try{const e=await S.getCurrentUser();if(!e||!e.roles||!Array.isArray(e.roles)||0===e.roles.length)throw new Error("Données utilisateur invalides");return e}catch(e){throw e}},staleTime:3e5,retry:2,onError:e=>{i("Impossible de charger vos informations. Veuillez rafraîchir la page.")}}),d=t?.roles?.[0]||null,m=G(d),u=K(d),p="success"===c&&(m||u),{data:h,isLoading:g,isFetching:x}=C({queryKey:["studentProfile"],queryFn:w.getMyProfile,enabled:"success"===c&&!!t?.roles?.includes("ROLE_STUDENT"),staleTime:3e4,refetchOnMount:!0,refetchOnWindowFocus:!0,retry:2,onError:()=>{}}),{data:y,isLoading:v,isFetching:b}=C({queryKey:["documents","CV"],queryFn:()=>N.getDocumentByType("CV",!1),enabled:p,staleTime:12e4,retry:1,onError:()=>{}}),f=y&&Array.isArray(y)&&y.length>0?y[0]:null,{data:D,isLoading:j,isFetching:P}=C({queryKey:["userDiplomas"],queryFn:H.getUserDiplomas,enabled:p,staleTime:12e4,retry:1,select:e=>e&&Array.isArray(e)?[...e].sort(((e,s)=>{const a=new Date(e.obtainedDate||"1900-01-01");return new Date(s.obtainedDate||"1900-01-01")-a})):[],onError:()=>{}}),k=U({mutationFn:e=>{const s=new FormData;return s.append("file",e),N.uploadCV(s)},onSuccess:()=>{a.invalidateQueries({queryKey:["documents","CV"]}),o.success("CV téléversé avec succès")},onError:e=>{o.error("Erreur lors du téléversement du CV")}}),R=U({mutationFn:e=>N.deleteDocument(e),onSuccess:()=>{a.invalidateQueries({queryKey:["documents","CV"]}),N.clearCache(),o.success("CV supprimé avec succès")},onError:e=>{o.error("Erreur lors de la suppression du CV")}}),T=U({mutationFn:e=>w.updateJobSeekingStatus(e),onMutate:async e=>{await a.cancelQueries({queryKey:["studentProfile"]});const s=a.getQueryData(["studentProfile"]);return a.setQueryData(["studentProfile"],(s=>{if(!s)return s;const a=JSON.parse(JSON.stringify(s));return a.studentProfile?(a.studentProfile.isSeekingInternship=e.isSeekingInternship,a.studentProfile.isSeekingApprenticeship=e.isSeekingApprenticeship):(a.isSeekingInternship=e.isSeekingInternship,a.isSeekingApprenticeship=e.isSeekingApprenticeship),a})),{previousProfile:s}},onError:(e,s,r)=>{r?.previousProfile&&a.setQueryData(["studentProfile"],r.previousProfile),o.error("Erreur lors de la mise à jour du profil")},onSuccess:e=>{a.setQueryData(["studentProfile"],(s=>s?{...s,...e}:e)),a.invalidateQueries({queryKey:["studentProfile"],refetchActive:!0,refetchInactive:!0})}});return l&&!t||G&&g&&!h||p&&v&&!y||p&&j&&!D?e.jsx("div",{className:"space-y-6 bg-white p-6 rounded-lg shadow",children:e.jsx(A,{type:"career"})}):r?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("p",{className:"text-red-500 mb-4",children:r}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600",children:"Réessayer"})]}):"success"!==c||G||K?e.jsxs("div",{className:"w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold mb-4 sm:mb-6",children:"Gestion de carrière"}),e.jsxs("div",{className:"space-y-6 sm:space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold mb-2 sm:mb-4",children:"Curriculum Vitae"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 sm:mb-6",children:"Votre CV est essentiel pour vos candidatures. Assurez-vous qu'il est à jour et reflète vos compétences actuelles."}),e.jsx(M,{cvDocument:f,onUpload:e=>k.mutate(e),onDelete:e=>R.mutate(e),onDownload:async e=>{if(e)try{const s=await N.downloadDocument(e),a=window.URL.createObjectURL(s),r=document.createElement("a");r.style.display="none",r.href=a,r.download=f?.name||"cv.pdf",document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(a),document.body.removeChild(r),o.success("Document importé avec succès")}catch(s){o.error("Erreur lors du téléchargement du document")}else o.error("Impossible de télécharger le document: ID manquant")}})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold mb-2 sm:mb-4",children:"Diplômes"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 sm:mb-6",children:"Ajoutez vos diplômes pour mettre en valeur votre parcours académique auprès des recruteurs."}),e.jsx(Y,{userData:{role:d},diplomas:D||[],setDiplomas:e=>{a.setQueryData(["userDiplomas"],e),a.invalidateQueries(["userDiplomas"]),a.refetchQueries(["userDiplomas"]),a.invalidateQueries(["/api/profile"]),H.getUserDiplomas().catch((e=>console.error("[CareerSettings] Error directly fetching user diplomas:",e)))}})]}),G&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold mb-2 sm:mb-4",children:"Recherche d'emploi"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 sm:mb-6",children:"Indiquez si vous êtes à la recherche d'un stage ou d'une alternance pour être visible auprès des recruteurs."}),e.jsx(I,{profile:h,onProfileUpdate:e=>{T.mutate(e)}})]})]})]}):e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"text-gray-500",children:"Cette section est réservée aux étudiants et aux invités."})})};export{W as default};
