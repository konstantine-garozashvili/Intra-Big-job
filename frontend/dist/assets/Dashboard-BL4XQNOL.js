import{j as e}from"./ui-DiOaG2iA.js";import{R as r,r as o}from"./router-D7BdrHDj.js";import{D as t}from"./DashboardLayout-CdL0IJG0.js";import{b as a}from"./query-D8UIi9X6.js";import{w as i,af as n,ag as s,m as l}from"./index-BpIDiI3H.js";import"./react-0RZ2pslC.js";import"./charts-DkICKEBk.js";import"./circle-alert-e-A8qJUH.js";const c=(e={})=>{const r=s();return window._profilePreloadInitiated||(window._profilePreloadInitiated=!0,i.preloadProfileData()),function(){if(window._memoryMonitoringInitiated)return;if(window._memoryMonitoringInitiated=!0,window.performance&&window.performance.memory){const e=setInterval((()=>{const e=window.performance.memory;e.usedJSHeapSize>.8*e.jsHeapSizeLimit&&(console.warn("Memory usage high, clearing caches"),i.clearMemoryCache(),n&&"function"==typeof n.clear&&n.clear())}),3e4);window.addEventListener("beforeunload",(()=>{clearInterval(e)}))}"onlowmemory"in window&&window.addEventListener("lowmemory",(()=>{console.warn("Low memory event detected, clearing caches"),i.clearMemoryCache()}))}(),a({queryKey:["user-profile",r],queryFn:async()=>{try{const r=localStorage.getItem("user");if(r&&!e.skipCache){const e=JSON.parse(r),o=e._extractedAt||0,t=Date.now()-o;if(t<2e4)return console.log("useOptimizedProfile - Using very fresh cached data"),t>5e3&&setTimeout((()=>{i.getUserProfile({background:!0,noCache:!0,minimal:!0}).catch((()=>{}))}),0),e}console.log("useOptimizedProfile - Fetching fresh data from API");return await i.getUserProfile({timeout:2e3,retries:0,minimal:!e.fullData})}catch(r){console.error("Error in useOptimizedProfile:",r);try{const e=localStorage.getItem("user");if(e)return console.log("useOptimizedProfile - Using cached data as fallback after error"),JSON.parse(e)}catch(o){}throw r}},meta:{tracked:!0,source:"useOptimizedProfile",type:"profile",userId:r},staleTime:3e4,cacheTime:3e5,refetchOnWindowFocus:!1,refetchOnMount:!0,refetchInterval:!1,retry:0,retryDelay:1e3,gcTime:6e5,...e})};const d=r.memo((()=>{const[r,a]=o.useState(!1),[n,s]=o.useState(!1);o.useEffect((()=>(i.preloadProfileData({minimal:!0}),()=>{window._dashboardCleanupTimeout&&clearTimeout(window._dashboardCleanupTimeout)})),[]);const{data:d,error:m,isLoading:u,refetch:w}=c({staleTime:2e4,refetchOnMount:!0,fullData:n});o.useEffect((()=>{if(!d&&!u){const e=setTimeout((()=>{w().catch((e=>{console.error("Error refreshing dashboard data:",e)}))}),20);return()=>clearTimeout(e)}}),[w,d,u]),o.useEffect((()=>{const e=()=>{window._dashboardCleanupTimeout&&clearTimeout(window._dashboardCleanupTimeout),window._dashboardCleanupTimeout=setTimeout((()=>{document.hasFocus()||i.clearMemoryCache()}),3e5)};e();const r=()=>e();return window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("mousemove",r),()=>{window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("mousemove",r),window._dashboardCleanupTimeout&&clearTimeout(window._dashboardCleanupTimeout)}}),[]),o.useEffect((()=>{d&&!r&&a(!0)}),[d,r]);const f=o.useMemo((()=>{if(d)return null;try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return null}}),[d]),h=d||f,p=o.useMemo((()=>{if(!h)return"";let e="";return h.roles&&(Array.isArray(h.roles)&&h.roles.length>0?e=h.roles[0].replace("ROLE_",""):"string"==typeof h.roles&&(e=h.roles.replace("ROLE_",""))),`Bienvenue ${h.firstName||""} ${h.lastName||""} - ${e}`}),[h]);return o.useEffect((()=>{if(!h&&!u){const e=setTimeout((()=>{window.location.reload()}),2e3);return()=>clearTimeout(e)}}),[h,u]),e.jsx(t,{error:m?.message,isLoading:u&&!h,children:h?e.jsx(l.div,{className:"bg-white rounded-lg shadow-lg p-6",initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},children:e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-8",children:p})}):u?null:e.jsxs("div",{className:"bg-yellow-100 p-4 rounded-md text-yellow-800",children:["Problème de chargement des données utilisateur.",e.jsx("button",{onClick:()=>w(),className:"ml-2 text-blue-600 underline",children:"Réessayer"})]})})}));export{d as default};
