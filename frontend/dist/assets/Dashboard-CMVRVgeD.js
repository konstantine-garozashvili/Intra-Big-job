import{j as e}from"./ui-B5ZVMT00.js";import{b as r,r as t}from"./router-Cgxi-4fo.js";import{D as o}from"./DashboardLayout-DERSKsP0.js";import{b as a}from"./query-DUefEkVx.js";import{x as n,ak as i,al as s,m as l}from"./index-CLN0I5Ep.js";import"./react-0RZ2pslC.js";import"./charts-D4j3G6dB.js";import"./circle-alert-CQt-Nxa2.js";const c=(e={})=>{const r=s();return window._profilePreloadInitiated||(window._profilePreloadInitiated=!0,n.preloadProfileData()),function(){if(window._memoryMonitoringInitiated)return;if(window._memoryMonitoringInitiated=!0,window.performance&&window.performance.memory){const e=setInterval((()=>{const e=window.performance.memory;e.usedJSHeapSize>.8*e.jsHeapSizeLimit&&(n.clearMemoryCache(),i&&"function"==typeof i.clear&&i.clear())}),3e4);window.addEventListener("beforeunload",(()=>{clearInterval(e)}))}"onlowmemory"in window&&window.addEventListener("lowmemory",(()=>{n.clearMemoryCache()}))}(),a({queryKey:["user-profile",r],queryFn:async()=>{try{const r=localStorage.getItem("user");if(r&&!e.skipCache){const e=JSON.parse(r),t=e._extractedAt||0,o=Date.now()-t;if(o<2e4)return o>5e3&&setTimeout((()=>{n.getUserProfile({background:!0,noCache:!0,minimal:!0}).catch((()=>{}))}),0),e}return await n.getUserProfile({timeout:2e3,retries:0,minimal:!e.fullData})}catch(r){try{const e=localStorage.getItem("user");if(e)return JSON.parse(e)}catch(t){}throw r}},meta:{tracked:!0,source:"useOptimizedProfile",type:"profile",userId:r},staleTime:3e4,cacheTime:3e5,refetchOnWindowFocus:!1,refetchOnMount:!0,refetchInterval:!1,retry:0,retryDelay:1e3,gcTime:6e5,...e})};const d=r.memo((()=>{const[r,a]=t.useState(!1),[i,s]=t.useState(!1);t.useEffect((()=>(n.preloadProfileData({minimal:!0}),()=>{window._dashboardCleanupTimeout&&clearTimeout(window._dashboardCleanupTimeout)})),[]);const{data:d,error:m,isLoading:u,refetch:w}=c({staleTime:2e4,refetchOnMount:!0,fullData:i});t.useEffect((()=>{if(!d&&!u){const e=setTimeout((()=>{w().catch((e=>{console.error("Error refreshing dashboard data:",e)}))}),20);return()=>clearTimeout(e)}}),[w,d,u]),t.useEffect((()=>{const e=()=>{window._dashboardCleanupTimeout&&clearTimeout(window._dashboardCleanupTimeout),window._dashboardCleanupTimeout=setTimeout((()=>{document.hasFocus()||n.clearMemoryCache()}),3e5)};e();const r=()=>e();return window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("mousemove",r),()=>{window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("mousemove",r),window._dashboardCleanupTimeout&&clearTimeout(window._dashboardCleanupTimeout)}}),[]),t.useEffect((()=>{d&&!r&&a(!0)}),[d,r]);const f=t.useMemo((()=>{if(d)return null;try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return null}}),[d]),p=d||f,h=t.useMemo((()=>{if(!p)return"";let e="";return p.roles&&(Array.isArray(p.roles)&&p.roles.length>0?e=p.roles[0].replace("ROLE_",""):"string"==typeof p.roles&&(e=p.roles.replace("ROLE_",""))),`Bienvenue ${p.firstName||""} ${p.lastName||""} - ${e}`}),[p]);return t.useEffect((()=>{if(!p&&!u){const e=setTimeout((()=>{window.location.reload()}),2e3);return()=>clearTimeout(e)}}),[p,u]),e.jsx(o,{error:m?.message,isLoading:u&&!p,children:p?e.jsx(l.div,{className:"bg-white rounded-lg shadow-lg p-6",initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},children:e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-8",children:h})}):u?null:e.jsxs("div",{className:"bg-yellow-100 p-4 rounded-md text-yellow-800",children:["Problème de chargement des données utilisateur.",e.jsx("button",{onClick:()=>w(),className:"ml-2 text-blue-600 underline",children:"Réessayer"})]})})}));export{d as default};
