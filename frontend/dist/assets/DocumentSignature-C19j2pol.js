import{j as e}from"./ui-B5ZVMT00.js";import{u as r,r as t}from"./router-Cgxi-4fo.js";import{z as s,a,u as n,t as o,m as i,q as c,r as l,s as d,v as u,w as h,ay as g,x as m,B as p,L as x,M as b,b as f}from"./index-CmOIAGkt.js";import{A as j,a as y,b as w}from"./alert-3Mmvsv7Z.js";import{C as k}from"./circle-check-big-BrXx2h2I.js";import{C as v}from"./circle-alert-0hqz4i9o.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=s("CalendarCheck",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"m9 16 2 2 4-4",key:"19s6y9"}]]),N=s("MapPinned",[["path",{d:"M18 8c0 3.613-3.869 7.429-5.393 8.795a1 1 0 0 1-1.214 0C9.87 15.429 6 11.613 6 8a6 6 0 0 1 12 0",key:"11u0oz"}],["circle",{cx:"12",cy:"8",r:"2",key:"1822b1"}],["path",{d:"M8.714 14h-3.71a1 1 0 0 0-.948.683l-2.004 6A1 1 0 0 0 3 22h18a1 1 0 0 0 .948-1.316l-2-6a1 1 0 0 0-.949-.684h-3.712",key:"q8zwxj"}]]),S=s("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]),L=t.forwardRef(((r,s)=>{const a=t.useRef(null),[n,o]=t.useState(!1),[i,c]=t.useState(!0);t.useEffect((()=>{const e=a.current,r=e.getContext("2d");r.lineWidth=2,r.lineCap="round",r.strokeStyle="#000000",r.fillStyle="#ffffff",r.fillRect(0,0,e.width,e.height);const t=()=>{const t=e.parentElement;e.width=t.clientWidth,e.height=200,r.lineWidth=2,r.lineCap="round",r.strokeStyle="#000000",r.fillStyle="#ffffff",r.fillRect(0,0,e.width,e.height)};return t(),window.addEventListener("resize",t),()=>{window.removeEventListener("resize",t)}}),[]);const l=e=>{const r=a.current,t=r.getContext("2d"),s=r.getBoundingClientRect();let n,i;"mousedown"===e.type?(n=e.clientX-s.left,i=e.clientY-s.top):"touchstart"===e.type&&(n=e.touches[0].clientX-s.left,i=e.touches[0].clientY-s.top),t.beginPath(),t.moveTo(n,i),o(!0),c(!1)},d=e=>{if(!n)return;const r=a.current,t=r.getContext("2d"),s=r.getBoundingClientRect();let o,i;"mousemove"===e.type?(o=e.clientX-s.left,i=e.clientY-s.top):"touchmove"===e.type&&(o=e.touches[0].clientX-s.left,i=e.touches[0].clientY-s.top),t.lineTo(o,i),t.stroke()},u=()=>{n&&(o(!1),r.onEnd&&r.onEnd())},h=()=>{const e=a.current,r=e.getContext("2d");r.fillStyle="#ffffff",r.fillRect(0,0,e.width,e.height),c(!0)},g=()=>a.current.toDataURL();return t.useEffect((()=>{s&&(s.current={clear:h,isEmpty:()=>i,toDataURL:g})}),[i,s]),e.jsx("canvas",{ref:a,className:"border border-gray-300 rounded-md w-full",onMouseDown:l,onMouseMove:d,onMouseUp:u,onMouseLeave:u,onTouchStart:l,onTouchMove:d,onTouchEnd:u,style:{touchAction:"none"}})})),A=()=>{const s=r(),[A,C]=t.useState(null),[M,P]=t.useState(!1),[I,R]=t.useState(!1),[T,$]=t.useState(!1),[z,O]=t.useState(null),[D,V]=t.useState([]),[U,q]=t.useState({}),_=t.useRef(null),[B,F]=t.useState(!1),{hasRole:H}=a();n(),t.useEffect((()=>{if(!(H("ROLE_TEACHER")||H("ROLE_STUDENT")))return o.error("Accès non autorisé",{description:"Seuls les étudiants et les enseignants peuvent accéder à cette page."}),void s("/dashboard")}),[H,s]);const W=async(e,r,t=3)=>{for(let a=0;a<t;a++)try{const s=await fetch(e,r);if(!s.ok){const e=await s.json().catch((()=>({})));if(console.warn(`API call failed (attempt ${a+1}/${t}):`,e),a===t-1)throw new Error(e.message||`Request failed with status ${s.status}`);await new Promise((e=>setTimeout(e,1e3*Math.pow(2,a))));continue}return await s.json()}catch(s){if(console.error(`API call error (attempt ${a+1}/${t}):`,s),a===t-1)throw s;await new Promise((e=>setTimeout(e,1e3*Math.pow(2,a))))}};t.useEffect((()=>{(()=>{try{const e=Object.keys(localStorage).filter((e=>e.includes("signature")||e.includes("signed")||e.includes("period")));e.length>0&&(console.log("Found potential signature-related localStorage keys:",e),e.forEach((e=>{localStorage.removeItem(e),console.log(`Removed localStorage key: ${e}`)})))}catch(e){console.error("Error clearing cached signature state:",e)}})()}),[]),t.useEffect((()=>{(async()=>{try{await f.ensureUserDataInLocalStorage()}catch(e){console.error("Failed to ensure user data in localStorage:",e)}})();(async()=>{try{F(!0);const r=new Promise(((e,r)=>setTimeout((()=>r(new Error("API request timeout"))),1e4))),t=localStorage.getItem("token");if(!t)throw new Error("Authentication token not found");try{const e=await Promise.race([W("/api/signatures/today",{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),r]);e?(e.currentPeriod&&O(e.currentPeriod),e.signedPeriods&&V(e.signedPeriods||[]),e.availablePeriods&&q(e.availablePeriods)):(O("afternoon"),V([]),q({morning:"Matin (9h-12h)",afternoon:"Après-midi (13h-17h)"}))}catch(e){console.error("Error checking today's signatures:",e),O("afternoon"),V([]),q({morning:"Matin (9h-12h)",afternoon:"Après-midi (13h-17h)"}),o.error("Erreur",{description:"Impossible de vérifier les signatures. Utilisation de valeurs par défaut."})}finally{F(!1)}}catch(e){console.error("Error in signature setup:",e),F(!1),O("afternoon"),V([]),q({morning:"Matin (9h-12h)",afternoon:"Après-midi (13h-17h)"})}})(),X()}),[]);const X=()=>{P(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{const r=`${e.coords.latitude},${e.coords.longitude}`;C(r),P(!1),o.success("Localisation détectée",{description:"Votre position a été détectée avec succès."})}),(e=>{console.error("Error getting location:",e),P(!1);let r="Impossible d'obtenir votre position.";switch(e.code){case e.PERMISSION_DENIED:r="L'accès à la géolocalisation a été refusé. Veuillez autoriser l'accès dans les paramètres de votre navigateur.";break;case e.POSITION_UNAVAILABLE:r="Les informations de localisation ne sont pas disponibles.";break;case e.TIMEOUT:r="La requête de localisation a expiré. Veuillez réessayer.";break;default:r=`Une erreur est survenue: ${e.message}`}o.error("Erreur de localisation",{description:r})}),{enableHighAccuracy:!1,timeout:3e4,maximumAge:3e5}):(P(!1),o.error("Localisation non supportée",{description:"Votre navigateur ne supporte pas la géolocalisation."}))},Y=()=>{_.current&&_.current.clear()};return z&&D.includes(z)?e.jsx(i.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"space-y-4",children:e.jsxs(c,{className:"overflow-hidden border-green-100 dark:border-green-900",children:[e.jsxs(l,{className:"bg-green-50 dark:bg-green-900/20 border-b border-green-100 dark:border-green-900/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5 text-green-600 dark:text-green-500"}),e.jsx(d,{className:"text-green-800 dark:text-green-400",children:"Présence déjà enregistrée"})]}),e.jsxs(u,{className:"text-green-700 dark:text-green-300",children:["Vous avez déjà signé pour la période ",U[z]," aujourd'hui."]})]}),e.jsx(h,{className:"pt-4",children:e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("p",{className:"font-medium mb-2",children:"Les signatures sont autorisées aux périodes suivantes :"}),e.jsxs("ul",{className:"space-y-2 mt-2",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800",children:"Matin"}),e.jsx("span",{children:"9h - 12h"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400 border-amber-200 dark:border-amber-800",children:"Après-midi"}),e.jsx("span",{children:"13h - 17h"})]})]})]})})]})}):e.jsx(i.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"space-y-4",children:e.jsxs(c,{className:"overflow-hidden border-blue-100 dark:border-blue-900/50",children:[e.jsxs(l,{className:"bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/10",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(d,{className:"text-blue-800 dark:text-blue-400",children:z?"Signature de présence":"Période de signature fermée"})}),e.jsx(u,{className:"text-blue-700 dark:text-blue-300",children:z?`Signez ci-dessous pour confirmer votre présence pour la période ${U[z]}`:"Les signatures ne sont autorisées qu'entre 9h-12h (matin) et 13h-17h (après-midi)."})]}),e.jsxs(h,{className:"pt-4",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800/40 rounded-md border border-gray-200 dark:border-gray-700 p-4 mb-4",children:e.jsx(L,{ref:_,onEnd:()=>{}})}),A&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 mb-3",children:[e.jsx(N,{className:"h-4 w-4 text-green-600 dark:text-green-500"}),e.jsx("span",{children:"Localisation détectée avec succès"}),e.jsxs(g,{variant:"outline",className:"ml-auto bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800",children:[e.jsx(k,{className:"h-3 w-3 mr-1"})," Prêt"]})]}),!A&&e.jsxs(j,{variant:"destructive",className:"mb-3",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx(y,{children:"Localisation requise"}),e.jsx(w,{children:"Veuillez autoriser l'accès à votre position pour continuer."})]})]}),e.jsxs(m,{className:"flex justify-between border-t border-gray-100 dark:border-gray-800 py-3 bg-gray-50 dark:bg-gray-800/20",children:[e.jsxs(p,{variant:"outline",onClick:Y,disabled:I,className:"gap-1",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M18 6 6 18"}),e.jsx("path",{d:"m6 6 12 12"})]}),"Effacer"]}),e.jsxs("div",{className:"flex gap-2",children:[!A&&e.jsx(p,{variant:"outline",className:"gap-1 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800",onClick:X,disabled:M,children:M?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Localisation..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-4 w-4"}),e.jsx("span",{children:"Localiser"})]})}),e.jsx(p,{onClick:async()=>{if(!I)if(A)if(_.current&&!_.current.isEmpty())if(z)if(D.includes(z))o.error("Signature déjà enregistrée",{description:`Vous avez déjà signé pour la période ${U[z]} aujourd'hui.`});else try{R(!0);const r=_.current.toDataURL(),t={location:A,drawing:r},a=localStorage.getItem("token");if(!a)throw new Error("Authentication token not found");let n=!1,i=null;try{const e=await fetch("/api/signatures",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)});if(!e.ok){const r=await e.json().catch((()=>({})));throw console.error("API error response:",r),new Error(r.message||"Failed to create signature")}i=await e.json(),n=!0}catch(e){}if(!n){const e=(new Date).toISOString().split("T")[0],t=`signature_${e}_${z}`;localStorage.setItem(t,"true");const s=`signature_data_${e}_${z}`,a={date:(new Date).toISOString(),location:A,drawing:r.substring(0,100)+"...[truncated]"};localStorage.setItem(s,JSON.stringify(a))}V([...D,z]),$(!0),C(null),Y();const c=new CustomEvent("signatureSubmitted",{detail:{period:z,success:!0}});window.dispatchEvent(c),o.success("Signature enregistrée",{description:n?"Votre signature a été enregistrée avec succès.":"Votre signature a été enregistrée localement (mode hors-ligne)."});const l=JSON.parse(localStorage.getItem("userRoles")||"[]");l.includes("ROLE_TEACHER")?s("/teacher/dashboard"):l.includes("ROLE_STUDENT")?s("/student/dashboard"):s("/dashboard")}catch(r){console.error("Error submitting signature:",r),o.error("Erreur",{description:"Une erreur est survenue lors de la soumission de la signature."})}finally{R(!1)}else o.error("Signature non autorisée",{description:"Les signatures ne sont autorisées qu'entre 9h-12h (matin) et 13h-17h (après-midi)."});else o.error("Validation impossible",{description:"Veuillez signer avant de soumettre."});else o.error("Signature non autorisée",{description:"La localisation est requise. Veuillez autoriser l'accès à votre position."})},disabled:!!I||!!D.includes(z),className:"gap-1",children:I?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Envoi..."})]}):e.jsxs(e.Fragment,{children:[A?!_.current||_.current.isEmpty()?e.jsx(S,{className:"h-4 w-4"}):e.jsx(E,{className:"h-4 w-4"}):e.jsx(b,{className:"h-4 w-4"}),e.jsx("span",{children:I?"Envoi en cours...":A?!_.current||_.current.isEmpty()?"Signature requise":D.includes(z)?"Déjà signé pour cette période":z?"Signer":"Hors période":"Localisation requise"})]})})]})]})]})})};export{E as C,A as D};
