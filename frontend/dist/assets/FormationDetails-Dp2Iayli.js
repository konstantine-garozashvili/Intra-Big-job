import{j as e}from"./ui-CEgDFHEN.js";import{e as t,r as a,u as s}from"./router-Cgxi-4fo.js";import{L as r,q as l,w as i,ay as n,j as o,ax as d,ar as c,b9 as u,M as m,B as x,D as h,k as f,I as g,l as b,n as j,J as p,y,t as N,b as w}from"./index-CbCqSr3O.js";import"./react-0RZ2pslC.js";import"./query-CdiCT4_A.js";import"./charts-D4j3G6dB.js";function v(){const{id:v}=t(),[A,C]=a.useState(null),[k,S]=a.useState(!0),[$,U]=a.useState(0),[E,P]=a.useState(0),[F,L]=a.useState([]),[M,R]=a.useState(!1),[q,z]=a.useState([]),[D,T]=a.useState(!1),[I,B]=a.useState(null),[O,J]=a.useState([]),[W,_]=a.useState(""),[G,H]=a.useState(""),[K,Q]=a.useState(!1),[V,X]=a.useState(null),Y=a.useRef(null),Z=s();a.useEffect((()=>{(async()=>{S(!0);try{const e=await y.get(`/api/formations/${v}`);let t=null;e&&e.success&&e.data&&e.data.formation?t=e.data.formation:e&&e.success&&e.data&&e.data.data&&e.data.data.formation?t=e.data.data.formation:e&&e.formation?t=e.formation:e&&e.data&&(t=e.data),C(t),U(Array.isArray(t?.students)?t.students.length:0),J(Array.isArray(t?.students)?t.students:[])}catch(e){C(null),J([])}finally{S(!1)}})()}),[v]),a.useEffect((()=>{(async()=>{try{const e=await y.get(`/api/formations/${v}/enrollment-requests?status=accepted`);let t=[];e&&e.success&&Array.isArray(e.data)?t=e.data.map((e=>e.user)):Array.isArray(e)&&(t=e.map((e=>e.user))),L(t),P(t.length)}catch(e){L([]),P(0)}})()}),[v]);const ee=async e=>{const t=await(e=>(X(e),Q(!0),new Promise((e=>{Y.current=e}))))(e);if(t)try{await y.delete(`/api/formations/${v}/students/${e}`),N.success("Étudiant retiré de la formation."),J((t=>t.filter((t=>t.id!==e)))),U((e=>Math.max(0,e-1))),L((t=>t.filter((t=>t.id!==e)))),P((e=>Math.max(0,e-1)))}catch(a){N.error("Erreur lors du retrait de l'étudiant.")}},te=e=>{Q(!1),Y.current&&(Y.current(e),Y.current=null),X(null)};a.useEffect((()=>{const e=setTimeout((()=>{H(W)}),200);return()=>clearTimeout(e)}),[W]);const ae=a.useMemo((()=>{if(!G)return q.slice(0,5);const e=G.toLowerCase();return q.filter((t=>t.firstName?.toLowerCase().includes(e)||t.lastName?.toLowerCase().includes(e)||t.email?.toLowerCase().includes(e)))}),[q,G]);return e.jsxs("div",{className:"max-w-2xl mx-auto py-8",children:[k?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx(r,{className:"animate-spin w-8 h-8 text-gray-400"})}):A?e.jsx(l,{className:"relative rounded-3xl shadow-xl bg-white border border-gray-200 overflow-visible",children:e.jsx(i,{className:"p-0",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 pt-12 pb-8 px-8",children:[e.jsx("div",{className:"-mt-20 mb-2 z-10",children:e.jsx("div",{className:"w-32 h-32 rounded-full shadow-lg border-4 border-white bg-gray-100 flex items-center justify-center overflow-hidden",children:e.jsx("img",{src:A.image_url||"/placeholder.svg",alt:A.name,className:"object-cover w-full h-full"})})}),e.jsx("div",{className:"font-extrabold text-3xl mb-1 text-gray-900 dark:text-white text-center drop-shadow tracking-tight animate-fade-in",children:A.name}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2 animate-fade-in",children:[e.jsx(n,{className:"bg-[#2563eb] text-white font-semibold shadow-sm animate-bounceIn",children:A.specialization?.name||"Formation"}),e.jsx(n,{variant:"outline",className:"border-[#2563eb] text-[#2563eb] bg-white font-semibold animate-bounceIn delay-100",children:A.promotion||"N/A"})]}),e.jsx("div",{className:"text-gray-700 dark:text-gray-100 mb-2 text-center max-w-xl animate-fade-in-slow",children:A.description}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm mb-2 w-full max-w-md animate-fade-in-slow place-items-center mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-1 text-center justify-center",children:[e.jsx(o,{className:"w-4 h-4 text-[#2563eb] dark:text-blue-400"}),e.jsx("span",{className:"font-semibold text-[#2563eb] dark:text-blue-400",children:A.dateStart?new Date(A.dateStart).toLocaleDateString():"N/A"})]}),e.jsxs("div",{className:"flex items-center gap-1 text-center justify-center",children:[e.jsx(d,{className:"w-4 h-4 text-[#2563eb] dark:text-blue-400"}),e.jsx("span",{className:"font-semibold text-[#2563eb] dark:text-blue-400",children:A.duration?`${A.duration} mois`:"N/A"})]}),e.jsx("div",{className:"flex flex-col items-center gap-1 text-center justify-center col-span-2",children:(()=>{const t=Array.isArray(A.students)?A.students.length:0,a=A.capacity||0,s=((e,t)=>{const a=e/t*100;return a>=100?{text:"Complet",color:"text-red-500",bgColor:"bg-red-100 dark:bg-red-900/20"}:a>=80?{text:"Presque complet",color:"text-orange-500",bgColor:"bg-orange-100 dark:bg-orange-900/20"}:a>=50?{text:"Places limitées",color:"text-yellow-500",bgColor:"bg-yellow-100 dark:bg-yellow-900/20"}:{text:"Places disponibles",color:"text-green-500",bgColor:"bg-green-100 dark:bg-green-900/20"}})(t,a),r=a>0?Math.min(t/a*100,100):0;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(c,{className:"w-4 h-4 text-[#2563eb] dark:text-blue-400"}),e.jsxs("span",{className:"font-semibold text-[#2563eb] dark:text-blue-400",children:[t," / ",a," étudiants"]}),e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded-full text-xs font-semibold ${s.bgColor} ${s.color}`,children:s.text})]}),e.jsx(u,{value:r,className:"h-2 w-40"})]})})()}),A.location&&e.jsxs("div",{className:"flex items-center gap-1 text-center justify-center",children:[e.jsx(m,{className:"w-4 h-4 text-[#2563eb] dark:text-blue-400"}),e.jsx("span",{className:"font-semibold text-[#2563eb] dark:text-blue-400",children:A.location})]})]}),e.jsx("div",{className:"flex gap-6 mt-4 animate-fade-in-slow",children:e.jsxs("div",{className:"flex items-center gap-2 text-[#60a5fa] font-semibold",children:[e.jsx(c,{className:"w-5 h-5"}),e.jsxs("span",{children:[$," étudiants inscrits"]})]})}),e.jsxs("div",{className:"w-full mt-10 animate-fade-in-slow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-bold text-[#60a5fa]",children:"Étudiants inscrits"}),e.jsx(x,{onClick:async()=>{R(!0),T(!0);try{const e=await y.get(`/api/formations/${v}/available-students`);let t=[];e&&e.success&&Array.isArray(e.data)?t=e.data:e&&e.success&&Array.isArray(e.data?.users)?t=e.data.users:Array.isArray(e)&&(t=e);const a=new Set(O.map((e=>e.id)));t=t.filter((e=>!a.has(e.id))),z(t)}catch(e){z([]),N.error("Erreur lors du chargement des utilisateurs disponibles.")}finally{T(!1)}},className:"bg-[#2563eb] text-white font-semibold px-6 py-2 rounded-full shadow-sm hover:bg-blue-800 transition-all border-0",children:"Ajouter"})]}),0===O.length?e.jsx("div",{className:"text-gray-500 text-sm",children:"Aucun étudiant inscrit pour cette formation."}):e.jsx("ul",{className:"divide-y divide-gray-200",children:O.map((t=>{const a=`${t.firstName?.[0]||""}${t.lastName?.[0]||""}`.toUpperCase();return e.jsxs("li",{className:"py-3 flex items-center gap-4 group hover:bg-gray-100 rounded-xl transition",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-[#2563eb] text-lg border-2 border-gray-300 overflow-hidden",children:t.profilePictureUrl?e.jsx("img",{src:t.profilePictureUrl,alt:t.firstName,className:"w-full h-full object-cover rounded-full"}):a}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-medium text-[#60a5fa] truncate",children:[t.firstName," ",t.lastName]}),e.jsx("div",{className:"text-[#60a5fa] text-xs truncate",children:t.email})]}),e.jsx("button",{className:"mr-4 px-6 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition text-sm font-semibold opacity-0 group-hover:opacity-100 focus:opacity-100 shadow-sm",onClick:()=>ee(t.id),children:"Retirer"})]},`${t.id}-${t.email}`)}))})]})]})})}):e.jsx("div",{className:"text-center text-gray-500",children:"Formation non trouvée."}),e.jsx(h,{open:M,onOpenChange:R,children:e.jsxs(f,{className:"rounded-2xl shadow-2xl border border-gray-200 bg-white",children:[e.jsxs(g,{children:[e.jsx(b,{className:"text-gray-800 font-bold",children:"Ajouter un utilisateur à la formation"}),e.jsx(j,{className:"text-gray-600",children:"Choisissez un invité ou étudiant à ajouter à cette formation."})]}),D?e.jsx("div",{className:"py-6 text-center",children:e.jsx(r,{className:"animate-spin w-6 h-6 mx-auto text-[#2563eb]"})}):0===q.length?e.jsx("div",{className:"py-6 text-center text-gray-500",children:"Aucun utilisateur disponible à ajouter."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative mb-3",children:[e.jsx("input",{type:"text",className:"w-full px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#2563eb] focus:border-[#2563eb] text-gray-900 bg-white pr-10",placeholder:"Rechercher par nom, prénom ou email...",value:W,onChange:e=>_(e.target.value),autoFocus:!0}),e.jsx("span",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-gray-400",children:e.jsxs("svg",{width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-2-2"})]})})]}),e.jsx("ul",{className:"divide-y divide-gray-200 max-h-64 overflow-y-auto",children:0===ae.length?e.jsx("li",{className:"py-2 text-center text-gray-400",children:"Aucun résultat."}):ae.map((t=>{const a=`${t.firstName?.[0]||""}${t.lastName?.[0]||""}`.toUpperCase();return e.jsxs("li",{className:"py-2 flex items-center gap-4 group hover:bg-gray-100 rounded-xl transition",children:[e.jsx("div",{className:"w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center font-bold text-[#2563eb] text-base border-2 border-gray-300 overflow-hidden",children:t.profilePictureUrl?e.jsx("img",{src:t.profilePictureUrl,alt:t.firstName,className:"w-full h-full object-cover rounded-full"}):a}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-medium text-[#60a5fa] truncate",children:[t.firstName," ",t.lastName]}),e.jsx("div",{className:"text-[#60a5fa] text-xs truncate",children:t.email})]}),e.jsx(x,{size:"sm",className:"border border-green-200 text-green-700 bg-white hover:bg-green-50 hover:text-green-800 font-semibold rounded-full px-4 py-1 shadow-sm",disabled:I===t.id,onClick:()=>(async e=>{B(e);try{const t=await y.post(`/api/formations/${v}/students/${e}`);if(!t.success)throw new Error(t.message||"Erreur lors de l'ajout de l'utilisateur.");N.success("Utilisateur ajouté à la formation."),R(!1);const a=q.find((t=>t.id===e));a&&(J((e=>[...e,a])),U((e=>e+1)),L((e=>[...e,a])),P((e=>e+1)),z((t=>t.filter((t=>t.id!==e)))));const s=w.getUser();s&&String(s.id)===String(e)&&(await w.getCurrentUser(!0),w.hasRole("STUDENT")&&Z("/student/dashboard"))}catch(t){N.error(t.message||"Erreur lors de l'ajout de l'utilisateur.")}finally{B(null)}})(t.id),children:I===t.id?e.jsx(r,{className:"animate-spin w-4 h-4"}):"Ajouter"})]},t.id)}))})]}),e.jsx(p,{children:e.jsx(x,{variant:"outline",onClick:()=>R(!1),className:"border border-gray-300 text-gray-700 bg-white hover:bg-gray-100 rounded-full",children:"Fermer"})})]})}),e.jsx(h,{open:K,onOpenChange:()=>te(!1),children:e.jsxs(f,{className:"rounded-2xl shadow-2xl border border-gray-200 bg-white max-w-md",children:[e.jsxs(g,{children:[e.jsx(b,{className:"text-red-600 font-bold",children:"Retirer l'étudiant ?"}),e.jsx(j,{className:"text-gray-700",children:"Êtes-vous sûr de vouloir retirer cet étudiant de la formation ? Cette action est irréversible."})]}),e.jsxs(p,{className:"flex flex-row gap-4 justify-end mt-4",children:[e.jsx(x,{variant:"outline",onClick:()=>te(!1),className:"border border-gray-300 text-gray-700 bg-white hover:bg-gray-100 rounded-full",children:"Annuler"}),e.jsx(x,{onClick:()=>te(!0),className:"bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full px-6 py-2 shadow",children:"Retirer"})]})]})})]})}export{v as default};
