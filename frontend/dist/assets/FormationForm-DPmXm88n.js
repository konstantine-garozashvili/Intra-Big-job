import{j as e}from"./ui-B5ZVMT00.js";import{u as a,r as s}from"./router-Cgxi-4fo.js";import{u as i,o as r,q as t,r as n,v as o,B as l,t as c,D as d,k as m,H as u,l as p,I as x,n as h,aP as f}from"./index-CLN0I5Ep.js";import{I as g}from"./input-B8RzEYZ4.js";import{L as j}from"./label-DhZarcVR.js";import{T as b}from"./textarea-BP6CB6Zb.js";import{S as v,a as y,b as N,c as S,d as w}from"./select-Gl1Uw1Bl.js";import{U as z}from"./upload-CPApPr6Y.js";import{T as C}from"./trash-2-BlaGCLWN.js";import"./react-0RZ2pslC.js";import"./query-DUefEkVx.js";import"./charts-D4j3G6dB.js";import"./index-jVOyRz7F.js";const I=()=>{const I=a(),[k,F]=s.useState(!1),[E,A]=s.useState([]),[T,P]=s.useState(null),[q,B]=s.useState({name:"",promotion:"",description:"",capacity:"",duration:"",dateStart:"",location:"",specializationId:"",imageFile:null}),D=i(),[L,V]=s.useState(!1),[$,O]=s.useState([]),[H,M]=s.useState({name:"",domainId:""}),[G,R]=s.useState(!1),[U,W]=s.useState(!1),[J,K]=s.useState(!1),[Q,X]=s.useState(null);s.useEffect((()=>{(async()=>{try{const e=await f.getSpecializations();Array.isArray(e)?A(e):c.error("Structure de données de spécialisation inattendue")}catch(e){c.error("Erreur lors du chargement des spécialisations")}})()}),[]),s.useEffect((()=>{if(!L)return;(async()=>{try{const e=localStorage.getItem("token");if(!e)return void c.error("Session expirée. Veuillez vous reconnecter.");const a=await fetch("/api/domains",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=await a.json();s.success&&s.data&&Array.isArray(s.data.domains)?O(s.data.domains):(O([]),c.error("Structure de données de domaines inattendue"))}catch(e){O([]),c.error("Erreur lors du chargement des domaines")}})()}),[L]);const Y=e=>{const{name:a,value:s}=e.target;B((e=>({...e,[a]:s})))};return e.jsx("div",{className:"w-full max-w-5xl mx-auto px-2 sm:px-6 lg:px-8 py-6",children:e.jsxs(r,{className:"overflow-hidden w-full shadow-xl bg-white dark:bg-gray-900",children:[e.jsxs(t,{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b",children:[e.jsx(n,{className:"text-xl sm:text-2xl font-bold text-primary drop-shadow mb-1",children:"Nouvelle Formation"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Créez une nouvelle formation en remplissant les champs ci-dessous."})]}),e.jsx(o,{className:"px-4 sm:px-6 md:px-8 py-8",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),(()=>{const e=["name","promotion","capacity","duration","dateStart","specializationId"].filter((e=>!q[e]));return!(e.length>0&&(c.error(`Veuillez remplir tous les champs obligatoires : ${e.join(", ")}`),1))})())try{F(!0);const e={...q,capacity:parseInt(q.capacity),duration:parseInt(q.duration),dateStart:q.dateStart};await f.createFormation(e);c.success("Formation créée avec succès"),I("/formations")}catch(a){c.error(a.message||"Erreur lors de la création de la formation")}finally{F(!1)}},className:"space-y-10",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-8 items-stretch md:items-start pt-4",children:[e.jsxs("div",{className:"flex flex-col items-center w-full md:w-1/4 min-w-[180px] justify-center",children:[e.jsxs("div",{className:"relative group mb-4",children:[e.jsx("label",{htmlFor:"formation-image-upload",className:"block w-32 h-32 rounded-full bg-gray-100 dark:bg-gray-800 border-2 border-blue-200 dark:border-gray-700 shadow-lg cursor-pointer transition-all duration-200 group-hover:ring-4 group-hover:ring-blue-400 group-hover:shadow-xl outline-none select-none",style:{WebkitTapHighlightColor:"transparent"},children:e.jsxs("div",{className:"w-full h-full rounded-full overflow-hidden flex items-center justify-center",children:[T?e.jsx("img",{src:T,alt:"Prévisualisation",className:"w-full h-full object-cover transition-transform duration-200 group-hover:scale-105 pointer-events-none",draggable:"false"}):e.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full pointer-events-none select-none",children:[e.jsx(z,{className:"h-10 w-10 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Image"})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full pointer-events-none",children:e.jsx("span",{className:"text-white text-sm font-semibold px-2 text-center select-none",children:"Changer l'image"})})]})}),e.jsx("input",{id:"formation-image-upload",type:"file",className:"hidden",accept:"image/*",onChange:e=>{const a=e.target.files[0];if(a){if(a.size>2097152)return void c.error("L'image ne doit pas dépasser 2MB");if(!a.type.startsWith("image/"))return void c.error("Le fichier doit être une image");B((e=>({...e,imageFile:a}))),P(URL.createObjectURL(a))}},disabled:k}),T&&e.jsx(l,{type:"button",variant:"ghost",size:"sm",className:"mt-4 text-red-500 hover:bg-red-50 transition-colors",onClick:()=>{P(null),B((e=>({...e,imageFile:null})))},disabled:k,children:"Supprimer l'image"})]}),e.jsx("span",{className:"text-xs text-gray-400 text-center select-none",children:"Format JPG, PNG, GIF, WEBP. Max 2MB."})]}),e.jsxs("div",{className:"flex-1 flex flex-col justify-center",children:[e.jsx(j,{htmlFor:"description",className:"font-semibold",children:"Description"}),e.jsx(b,{id:"description",name:"description",value:q.description,onChange:Y,rows:5,className:"mt-2 resize-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(j,{htmlFor:"name",className:"font-semibold",children:"Nom *"}),e.jsx(g,{id:"name",name:"name",value:q.name,onChange:Y,required:!0,className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(j,{htmlFor:"promotion",className:"font-semibold",children:"Promotion *"}),e.jsx(g,{id:"promotion",name:"promotion",value:q.promotion,onChange:Y,required:!0,className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(j,{htmlFor:"capacity",className:"font-semibold",children:"Capacité *"}),e.jsx(g,{id:"capacity",name:"capacity",type:"number",min:"1",value:q.capacity,onChange:Y,required:!0,className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(j,{htmlFor:"duration",className:"font-semibold",children:"Durée (en mois) *"}),e.jsx(g,{type:"number",id:"duration",name:"duration",value:q.duration,onChange:Y,required:!0,className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(j,{htmlFor:"dateStart",className:"font-semibold",children:"Date de début *"}),e.jsx(g,{type:"date",id:"dateStart",name:"dateStart",value:q.dateStart,onChange:Y,required:!0,className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(j,{htmlFor:"location",className:"font-semibold",children:"Lieu"}),e.jsx(g,{id:"location",name:"location",value:q.location,onChange:Y,className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400"})]}),e.jsxs("div",{className:"flex flex-col gap-2 lg:col-span-1",children:[e.jsx(j,{htmlFor:"specializationId",className:"font-semibold",children:"Spécialisation *"}),e.jsxs(v,{value:q.specializationId,onValueChange:e=>{B((a=>({...a,specializationId:e})))},required:!0,children:[e.jsx(y,{className:"focus:ring-2 focus:ring-blue-400 focus:border-blue-400",children:e.jsx(N,{placeholder:"Sélectionnez une spécialisation"})}),e.jsx(S,{children:E.map((a=>e.jsx(w,{value:a.id.toString(),children:a.name},a.id)))})]}),(D.isAdmin()||D.isRecruiter()||D.isSuperadmin())&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(l,{type:"button",variant:"outline",size:"sm",className:"w-fit",onClick:()=>V(!0),children:"+ Nouvelle"}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",className:"w-fit text-red-500 hover:text-red-700 hover:bg-red-50",onClick:()=>{if(!q.specializationId)return void c.error("Veuillez sélectionner une spécialisation à supprimer");const e=E.find((e=>e.id.toString()===q.specializationId));e&&(async(e,a)=>{X({id:e,name:a}),K(!0)})(e.id,e.name)},children:[e.jsx(C,{className:"h-4 w-4 mr-1"}),"Supprimer"]})]}),e.jsx(d,{open:L,onOpenChange:V,children:e.jsxs(m,{"aria-describedby":"add-spec-desc",children:[e.jsxs(u,{children:[e.jsx(p,{children:"Nouvelle spécialisation"}),e.jsx("p",{id:"add-spec-desc",className:"text-sm text-gray-500",children:"Ajoutez une nouvelle spécialisation et associez-la à un domaine."})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(j,{htmlFor:"new-spec-name",children:"Nom"}),e.jsx(g,{id:"new-spec-name",value:H.name,onChange:e=>M((a=>({...a,name:e.target.value}))),placeholder:"Nom de la spécialisation",disabled:G}),e.jsx(j,{htmlFor:"new-spec-domain",children:"Domaine"}),e.jsxs("select",{id:"new-spec-domain",className:"border rounded px-3 py-2",value:H.domainId,onChange:e=>M((a=>({...a,domainId:e.target.value}))),disabled:G,children:[e.jsx("option",{value:"",children:"Sélectionnez un domaine"}),$.map((a=>e.jsx("option",{value:a.id,children:a.name},a.id)))]})]}),e.jsxs(x,{className:"mt-4 flex gap-2 justify-end",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>V(!1),disabled:G,children:"Annuler"}),e.jsx(l,{type:"button",onClick:async()=>{if(!H.name||!H.domainId)return void c.error("Veuillez remplir tous les champs");R(!0);const e=-Date.now(),a={id:e,name:H.name,domainId:H.domainId};A((e=>[...e,a])),B((a=>({...a,specializationId:e.toString()}))),V(!1),M({name:"",domainId:""});let s=!1;try{const i=localStorage.getItem("token");if(!i)throw new Error("Session expirée. Veuillez vous reconnecter.");const r=await fetch("/api/specializations",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({name:a.name,domainId:a.domainId})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!(t.success&&t.data&&t.data.specialization))throw new Error(t.message||"Erreur lors de l'ajout");c.success("Spécialisation ajoutée"),A((a=>a.map((a=>a.id===e?t.data.specialization:a)))),B((e=>({...e,specializationId:t.data.specialization.id.toString()}))),s=!0}catch(i){A((a=>a.filter((a=>a.id!==e)))),B((e=>({...e,specializationId:""}))),c.error(i.message||"Erreur lors de l'ajout")}finally{R(!1)}},disabled:G,children:G?"Ajout...":"Ajouter"})]})]})}),e.jsx(d,{open:J,onOpenChange:K,children:e.jsxs(m,{children:[e.jsxs(u,{children:[e.jsx(p,{children:"Supprimer la spécialisation"}),e.jsxs(h,{children:['Êtes-vous sûr de vouloir supprimer la spécialisation "',Q?.name,'" ? Cette action ne sera pas possible si la spécialisation est utilisée par des formations.']})]}),e.jsxs(x,{className:"mt-4 flex gap-2 justify-end",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>K(!1),disabled:U,children:"Annuler"}),e.jsx(l,{type:"button",variant:"destructive",onClick:async()=>{if(Q){W(!0);try{const e=localStorage.getItem("token");if(!e)return void c.error("Session expirée. Veuillez vous reconnecter.");const a=await fetch(`/api/specializations/${Q.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),s=await a.json();if(s.success){c.success("Spécialisation supprimée avec succès");const e=await f.getSpecializations();A(e),q.specializationId===Q.id.toString()&&B((e=>({...e,specializationId:""})))}else c.error(s.message||"Erreur lors de la suppression")}catch(e){c.error("Erreur lors de la suppression")}finally{W(!1),K(!1),X(null)}}},disabled:U,children:U?"Suppression...":"Supprimer"})]})]})})]})]}),e.jsxs("div",{className:"flex gap-4 justify-end",children:[e.jsx(l,{type:"submit",disabled:k,className:"bg-gradient-to-r from-blue-600 to-cyan-400 text-white shadow hover:from-blue-700 hover:to-cyan-500 transition",children:k?"Création...":"Créer"}),e.jsx(l,{type:"button",variant:"outline",onClick:()=>I("/formations"),disabled:k,children:"Annuler"})]})]})})]})})};export{I as default};
