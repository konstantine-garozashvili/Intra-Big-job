import{j as e}from"./ui-B9MhWaVJ.js";import{r as s}from"./router-D7BdrHDj.js";import{s as r,as as a,B as t,ai as n,ad as i,D as l,g as o,y as c,h as d,i as m,z as u,t as g,a7 as h,k as x,l as f,n as j,o as p,p as N,b as y}from"./index-Bd05LC-l.js";import{u as C,b as P,a as v}from"./query-DKQ6_O-p.js";import{C as w}from"./checkbox-CoApv7hz.js";import{L}from"./label-8eTlumoe.js";import{T as k,a as R,b,c as E,d as S,e as M}from"./table-CPW8ECtE.js";import{A as T,a as U}from"./arrow-up-5VG4LTM4.js";import{L as O}from"./loader-circle-BrSWE4DC.js";import"./react-0RZ2pslC.js";import"./charts-DkICKEBk.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=r("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);function q({selectedRoles:s,onChange:r,pagination:a,setPagination:t,filteredUsers:n}){const i=e=>{r({...s,[e]:!s[e]}),t({...a,currentPage:1})};return e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{id:"guest-filter",checked:s.guest,onCheckedChange:()=>i("guest")}),e.jsx(L,{htmlFor:"guest-filter",children:"Invités"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{id:"student-filter",checked:s.student,onCheckedChange:()=>i("student")}),e.jsx(L,{htmlFor:"student-filter",children:"Élèves"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{htmlFor:"items-per-page",children:"Éléments par page:"}),e.jsx("select",{id:"items-per-page",className:"p-2 border rounded-md",value:a.itemsPerPage,onChange:e=>{t({...a,itemsPerPage:Number(e.target.value),currentPage:1})},children:[10,25,50,100].map((s=>e.jsx("option",{value:s,children:s},s)))}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Affichage de ",Math.min(n.length,1+(a.currentPage-1)*a.itemsPerPage),"-",Math.min(n.length,a.currentPage*a.itemsPerPage),"sur ",n.length," utilisateurs"]})]})]})}function F({users:s,sortConfig:r,onSort:n,onChangeRole:i,getCurrentRole:l}){const o=s=>r.key!==s?e.jsx(A,{className:"w-4 h-4 ml-1"}):"ascending"===r.direction?e.jsx(T,{className:"w-4 h-4 ml-1"}):e.jsx(U,{className:"w-4 h-4 ml-1"}),c=e=>{const s=l(e);return s.toLowerCase().includes("guest")?"Promouvoir en élève":s.toLowerCase().includes("student")?"Rétrograder en invité":"Changer le rôle"},d=e=>{let s="ascending";r.key===e&&"ascending"===r.direction&&(s="descending"),n({key:e,direction:s})};return e.jsxs(k,{children:[e.jsx(R,{children:e.jsxs(b,{children:[e.jsx(E,{className:"cursor-pointer",onClick:()=>d("lastName"),children:e.jsxs("div",{className:"flex items-center",children:["Nom",o("lastName")]})}),e.jsx(E,{className:"cursor-pointer",onClick:()=>d("firstName"),children:e.jsxs("div",{className:"flex items-center",children:["Prénom",o("firstName")]})}),e.jsx(E,{className:"cursor-pointer",onClick:()=>d("email"),children:e.jsxs("div",{className:"flex items-center",children:["Email",o("email")]})}),e.jsx(E,{children:"Rôles actuels"}),e.jsx(E,{className:"text-right",children:"Actions"})]})}),e.jsx(S,{children:s.map((s=>e.jsxs(b,{children:[e.jsx(M,{children:s.lastName}),e.jsx(M,{children:s.firstName}),e.jsx(M,{children:s.email}),e.jsx(M,{children:s.roles.map((s=>{const r="object"==typeof s&&null!==s?s.name:"string"==typeof s?s:"USER";return e.jsx(a,{role:r,solid:!0,className:"mr-1.5"},"object"==typeof s&&s.id||r)}))}),e.jsx(M,{className:"text-right",children:e.jsx(t,{variant:"outline",onClick:()=>i(s),className:"w-52 text-center",children:c(s)})})]},s.id)))})]})}function I({currentPage:s,totalPages:r,onPageChange:a,itemsPerPage:t,onItemsPerPageChange:l}){if(r<=1)return null;const o=[];let c=Math.max(1,s-Math.floor(2.5)),d=Math.min(r,c+5-1);d-c+1<5&&(c=Math.max(1,d-5+1)),o.push(e.jsx("div",{className:"cursor-pointer",onClick:()=>a(Math.max(1,s-1)),children:e.jsx(n,{className:"w-4 h-4"})},"prev"));for(let n=c;n<=d;n++)o.push(e.jsx("div",{className:"cursor-pointer px-3 py-1 rounded-md "+(s===n?"bg-gray-200":""),onClick:()=>a(n),children:n},n));return o.push(e.jsx("div",{className:"cursor-pointer",onClick:()=>a(Math.min(r,s+1)),children:e.jsx(i,{className:"w-4 h-4"})},"next")),e.jsx("div",{className:"flex space-x-2 mt-4",children:o})}function _({open:s,onOpenChange:r,user:n,getCurrentRole:i,getNewRole:g,onConfirm:h,isProcessing:x}){if(!n)return null;const f=i(n),j=g(n),p=f.toLowerCase().includes("guest");return e.jsx(l,{open:s,onOpenChange:r,children:e.jsxs(o,{children:[e.jsxs(c,{children:[e.jsx(d,{children:"Changement de rôle"}),e.jsx(m,{children:e.jsxs("p",{children:["Vous êtes sur le point de ",p?"promouvoir":"rétrograder",e.jsxs("strong",{children:[" ",n.firstName," ",n.lastName]}),"."]})})]}),e.jsxs("div",{className:"py-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Rôle actuel :"}),e.jsx(a,{role:f,solid:!0,useVariant:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Nouveau rôle :"}),e.jsx(a,{role:j,solid:!0,useVariant:!0})]})]}),e.jsxs(u,{children:[e.jsx(t,{variant:"outline",onClick:()=>r(!1),children:"Annuler"}),e.jsx(t,{disabled:x,onClick:h,children:x?"Traitement en cours...":p?"Promouvoir en élève":"Rétrograder en invité"})]})]})})}const D=h.create({baseURL:"http://localhost:8000/api"});D.interceptors.request.use((e=>{const s=localStorage.getItem("token");return s&&(e.headers.Authorization=`Bearer ${s}`),e}));const $="/user-roles/roles",z=e=>`/user-roles/users/${e}`,G="/user-roles/change-role";function V(){const r=C(),[a,t]=s.useState(null),[n,i]=s.useState(!1),[l,o]=s.useState({guest:!0,student:!1}),[c,d]=s.useState({key:"lastName",direction:"ascending"}),[m,u]=s.useState({currentPage:1,itemsPerPage:10}),{data:h=[],isLoading:w}=P({queryKey:["roles"],queryFn:async()=>{try{const e=await D.get($);if(200===e.status&&e.data){if(e.data.success&&e.data.data)return e.data.data;if(Array.isArray(e.data))return e.data;if(e.data.data||e.data.roles)return e.data.data||e.data.roles;if(e.data.hydra&&e.data["hydra:member"])return e.data["hydra:member"]}return[]}catch(e){return console.error("Error fetching roles:",e),[{id:1,name:"ROLE_GUEST"},{id:2,name:"ROLE_STUDENT"},{id:3,name:"ROLE_RECRUITER"},{id:4,name:"ROLE_ADMIN"}]}},staleTime:3e5}),L=e=>{if(200===e.status&&e.data){if(e.data.success&&e.data.data)return e.data.data;if(Array.isArray(e.data))return e.data;if(e.data.data||e.data.users)return e.data.data||e.data.users;if(e.data.hydra&&e.data["hydra:member"])return e.data["hydra:member"]}return[]},{data:k=[],isLoading:R}=P({queryKey:["users","guest"],queryFn:async()=>{try{const e=h.find((e=>e.name.toLowerCase().includes("guest")));if(!e)return[];const s=await D.get(z(e.name));return L(s)}catch(e){return console.error("Error fetching guest users:",e),[{id:1,firstName:"Jean",lastName:"Dupont",email:"jean.dupont@exemple.fr",roles:[{id:1,name:"ROLE_GUEST"}]},{id:2,firstName:"Marie",lastName:"Martin",email:"marie.martin@exemple.fr",roles:[{id:1,name:"ROLE_GUEST"}]}]}},enabled:l.guest&&h.length>0,staleTime:12e4}),{data:b=[],isLoading:E}=P({queryKey:["users","student"],queryFn:async()=>{try{const e=h.find((e=>e.name.toLowerCase().includes("student")));if(!e)return[];const s=await D.get(z(e.name));return L(s)}catch(e){return console.error("Error fetching student users:",e),[{id:3,firstName:"Pierre",lastName:"Leroy",email:"pierre.leroy@exemple.fr",roles:[{id:2,name:"ROLE_STUDENT"}]},{id:4,firstName:"Sophie",lastName:"Bernard",email:"sophie.bernard@exemple.fr",roles:[{id:2,name:"ROLE_STUDENT"}]}]}},enabled:l.student&&h.length>0,staleTime:12e4}),S=v({mutationFn:async e=>(await D.post(G,e)).data,onSuccess:()=>{r.invalidateQueries(["users"]),i(!1);const e=M(a).toLowerCase().includes("guest")?`${a.firstName} ${a.lastName} a été promu en élève`:`${a.firstName} ${a.lastName} a été rétrogradé en invité`;g.success(e)},onError:e=>{console.error("Error changing role:",e),g.error("Erreur lors de la modification du rôle")}}),M=s.useCallback((e=>e?.roles?.find((e=>e.name.toLowerCase().includes("guest")||e.name.toLowerCase().includes("student")))?.name||""),[]),T=s.useCallback((e=>M(e).toLowerCase().includes("guest")?h.find((e=>e.name.toLowerCase().includes("student")))?.name:h.find((e=>e.name.toLowerCase().includes("guest")))?.name),[M,h]),U=s.useCallback((()=>{if(!a)return;const e=M(a),s=T(a);S.mutate({userId:a.id,oldRoleName:e,newRoleName:s})}),[a,M,T,S]),A=s.useMemo((()=>{let e=[];return l.guest&&e.push(...k),l.student&&e.push(...b),[...e].sort(((e,s)=>e[c.key]<s[c.key]?"ascending"===c.direction?-1:1:e[c.key]>s[c.key]?"ascending"===c.direction?1:-1:0))}),[k,b,l,c]),V=s.useMemo((()=>{const e=(m.currentPage-1)*m.itemsPerPage,s=e+m.itemsPerPage;return A.slice(e,s)}),[A,m]),B=s.useMemo((()=>Math.ceil(A.length/m.itemsPerPage)),[A.length,m.itemsPerPage]);s.useEffect((()=>{(()=>{const e=y.getUser(),s=e?.roles?.some((e=>"string"==typeof e?e.toLowerCase().includes("recruiter"):(e.name||e.role||"").toLowerCase().includes("recruiter"))),r=e?.roles?.some((e=>"string"==typeof e?e.toLowerCase().includes("admin")||e.toLowerCase().includes("superadmin"):(e.name||e.role||"").toLowerCase().includes("admin")));s||r||g.error("Vous n'avez pas les droits pour accéder à cette page")})()}),[]);const K=w||R||E&&l.student;return e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsxs(x,{className:"mb-6",children:[e.jsxs(f,{children:[e.jsx(j,{children:"Gestion des rôles Invité/Élève"}),e.jsx(p,{children:"Gérez la promotion des invités en élèves et la rétrogradation des élèves en invités"})]}),e.jsxs(N,{children:[e.jsx(q,{selectedRoles:l,onChange:o,pagination:m,setPagination:u,filteredUsers:A}),K?e.jsx("div",{className:"text-center py-8 flex justify-center",children:e.jsx(O,{className:"w-8 h-8 text-gray-500 animate-spin"})}):e.jsxs(e.Fragment,{children:[e.jsx(F,{users:V,sortConfig:c,onSort:d,onChangeRole:e=>{t(e),i(!0)},getCurrentRole:M}),e.jsx(I,{currentPage:m.currentPage,totalPages:B,onPageChange:e=>u({...m,currentPage:e}),itemsPerPage:m.itemsPerPage,onItemsPerPageChange:e=>u({currentPage:1,itemsPerPage:e})})]})]})]}),e.jsx(_,{open:n,onOpenChange:i,user:a,getCurrentRole:M,getNewRole:T,onConfirm:U,isProcessing:S.isPending})]})}export{V as default};
