import{j as e}from"./ui-CEgDFHEN.js";import{r as s}from"./router-Cgxi-4fo.js";import{t as r,ao as n,q as a,r as t,s as i,v as o,w as l,aQ as c,B as d,b as m,D as u,k as h,I as x,l as j,n as p,J as g}from"./index-BnANEtVp.js";import{u as v,b as f,a as N}from"./query-CdiCT4_A.js";import{T as E,a as C,b as S,c as b,d as L,e as T}from"./table-DS2AyS3B.js";import{C as U}from"./checkbox-DB6Fdzbi.js";import{D as y}from"./DashboardLayout-Beti_5fJ.js";import"./label-T_DAMYbi.js";import{L as G}from"./loader-circle-tYz9PP6p.js";import"./react-0RZ2pslC.js";import"./charts-D4j3G6dB.js";import"./circle-alert-MkLjJhtw.js";const w=n.create({baseURL:"http://localhost:5173/api"});w.interceptors.request.use((e=>{const s=localStorage.getItem("token");return s&&(e.headers.Authorization=`Bearer ${s}`),e}));const k="/users",R="/user-roles/change-role",O=({open:s,onOpenChange:r,user:n,onConfirm:a,isProcessing:t})=>{const i=n?.roles?.some((e=>"GUEST"===e.name||"ROLE_GUEST"===e.name));return e.jsx(u,{open:s,onOpenChange:r,children:e.jsxs(h,{children:[e.jsxs(x,{children:[e.jsx(j,{children:"Confirmation du changement de rôle"}),e.jsx(p,{children:i?`Êtes-vous sûr de vouloir promouvoir ${n?.firstName} ${n?.lastName} en tant qu'élève ?`:`Êtes-vous sûr de vouloir rétrograder ${n?.firstName} ${n?.lastName} en tant qu'invité ?`})]}),e.jsxs(g,{children:[e.jsx(d,{variant:"outline",onClick:()=>r(!1),children:"Annuler"}),e.jsxs(d,{onClick:a,disabled:t,children:[t?e.jsx(G,{className:"w-4 h-4 mr-2 animate-spin"}):null,"Confirmer"]})]})]})})};function $(){const n=v(),[u,h]=s.useState(null),[x,j]=s.useState(!1),[p,g]=s.useState({guest:!0,student:!1}),[$,q]=s.useState(1),[_,D]=s.useState([]),{data:I=[],isLoading:P}=f({queryKey:["guest-student-users",p],queryFn:async()=>{try{const e=await w.get(k);if(e.data.success){return(e.data.data||[]).filter((e=>{const s=e.roles.map((e=>e.name));return!(!p.guest||!s.includes("GUEST"))||!(!p.student||!s.includes("STUDENT"))}))}return[]}catch(e){return console.error("Error fetching users:",e),r.error("Erreur lors de la récupération des utilisateurs"),[]}}}),A=N({mutationFn:async e=>{const s=e.roles.some((e=>"GUEST"===e.name||"ROLE_GUEST"===e.name))?"ROLE_STUDENT":"ROLE_GUEST";return w.post(R,{userId:e.id,newRole:s})},onSuccess:(e,s)=>{const a=s.roles.some((e=>"GUEST"===e.name||"ROLE_GUEST"===e.name));r.success(a?`${s.firstName} ${s.lastName} a été promu en élève`:`${s.firstName} ${s.lastName} a été rétrogradé en invité`),n.invalidateQueries(["guest-student-users"]),j(!1)},onError:e=>{console.error("Error changing role:",e),r.error("Une erreur est survenue lors du changement de rôle")}}),F=s.useMemo((()=>{const e=10*($-1),s=e+10;return I.slice(e,s)}),[I,$]);return s.useEffect((()=>{(()=>{const e=m.getUser(),s=e?.roles?.some((e=>"string"==typeof e?e.toLowerCase().includes("recruiter"):(e.name||e.role||"").toLowerCase().includes("recruiter"))),n=e?.roles?.some((e=>"string"==typeof e?e.toLowerCase().includes("admin")||e.toLowerCase().includes("superadmin"):(e.name||e.role||"").toLowerCase().includes("admin")));s||n||r.error("Vous n'avez pas les droits pour accéder à cette page")})()}),[]),s.useEffect((()=>{I&&D(I)}),[I]),e.jsxs(y,{children:[e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs(a,{children:[e.jsxs(t,{children:[e.jsx(i,{children:"Gestion des rôles Invité/Élève"}),e.jsx(o,{children:"Gérez la promotion des invités en élèves et la rétrogradation des élèves en invités"})]}),e.jsxs(l,{children:[e.jsxs("div",{className:"flex items-center space-x-4 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{id:"invites",checked:p.guest,onCheckedChange:e=>g((s=>({...s,guest:e})))}),e.jsx("label",{htmlFor:"invites",children:"Invités"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{id:"eleves",checked:p.student,onCheckedChange:e=>g((s=>({...s,student:e})))}),e.jsx("label",{htmlFor:"eleves",children:"Élèves"})]}),e.jsxs("div",{className:"ml-auto flex items-center space-x-2",children:[e.jsx("span",{children:"Éléments par page:"}),e.jsx("select",{className:"border rounded p-1",value:10,disabled:!0,children:e.jsx("option",{value:10,children:"10"})}),e.jsxs("span",{children:["Affichage de ",F.length," sur ",_.length," utilisateurs"]})]})]}),e.jsxs(E,{children:[e.jsx(C,{children:e.jsxs(S,{children:[e.jsx(b,{className:"w-[200px]",children:"Nom ↑"}),e.jsx(b,{children:"Prénom"}),e.jsx(b,{children:"Email"}),e.jsx(b,{children:"Rôles actuels"}),e.jsx(b,{className:"text-right",children:"Actions"})]})}),e.jsx(L,{children:P?e.jsx(S,{children:e.jsx(T,{colSpan:5,className:"text-center py-4",children:e.jsx(G,{className:"w-6 h-6 animate-spin mx-auto"})})}):F.map((s=>e.jsxs(S,{children:[e.jsx(T,{children:s.lastName}),e.jsx(T,{children:s.firstName}),e.jsx(T,{children:s.email}),e.jsx(T,{children:s.roles.map((s=>e.jsx(c,{role:s.name,className:"mr-1"},s.id||s.name)))}),e.jsx(T,{className:"text-right",children:e.jsx(d,{variant:"outline",onClick:()=>{h(s),j(!0)},children:s.roles.some((e=>"GUEST"===e.name||"ROLE_GUEST"===e.name))?"Promouvoir en élève":"Rétrograder en invité"})})]},s.id)))})]})]})]})}),e.jsx(O,{open:x,onOpenChange:j,user:u,onConfirm:()=>A.mutate(u),isProcessing:A.isPending})]})}export{$ as default};
