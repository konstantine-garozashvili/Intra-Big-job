import{j as e}from"./ui-CEgDFHEN.js";import{r}from"./router-Cgxi-4fo.js";import{a2 as s,O as t,m as a,B as o,a3 as i,a4 as n,q as l,r as c,s as d,v as u,w as m,t as p,a5 as f,a6 as E,a7 as g,a8 as x,A as D,a9 as h}from"./index-BnANEtVp.js";import{S as N}from"./switch-CIzLH02W.js";import{L as j}from"./label-T_DAMYbi.js";import{A as y,a as b,b as O}from"./alert-DMCK1Qkn.js";import{P as v}from"./ProfileSettingsSkeleton-DHINh_0Q.js";import"./react-0RZ2pslC.js";import"./query-CdiCT4_A.js";import"./charts-D4j3G6dB.js";const T=()=>{const[T,P]=r.useState(!0),[U,C]=r.useState({app:{ROLE_UPDATE:!0,DOCUMENT_UPLOADED:!0,DOCUMENT_DELETED:!0,DOCUMENT_APPROVED:!0,DOCUMENT_REJECTED:!0}}),[w,_]=r.useState(null),[k,S]=r.useState(!1),[R,A]=r.useState(null),[M,I]=r.useState(!1),{updateNotificationPreference:L,forceReinitializePreferences:J}=s(),{user:z}=t(),q=()=>{let e=null;if(z?.id)e=z.id;else if(localStorage.getItem("user"))try{const r=JSON.parse(localStorage.getItem("user"));r?.id&&(e=r.id)}catch(r){console.error("Error parsing user from localStorage:",r)}return e||(e=localStorage.getItem("userId")||localStorage.getItem("user_id")),e?String(e):(console.error("No user ID found"),null)};r.useEffect((()=>{const e=async(e,r)=>{try{const s={app:{ROLE_UPDATE:!0,DOCUMENT_UPLOADED:!0,DOCUMENT_DELETED:!0,DOCUMENT_APPROVED:!0,DOCUMENT_REJECTED:!0}},t=f(E,"notificationPreferences",e),a={userId:e,userEmail:r||null,ROLE_UPDATE:!0,DOCUMENT_UPLOADED:!0,DOCUMENT_DELETED:!0,DOCUMENT_APPROVED:!0,DOCUMENT_REJECTED:!0,createdAt:new Date,lastLogin:new Date};await h(t,a),console.log("Préférences par défaut créées dans Firestore pour utilisateur:",e),C(s),_(JSON.stringify(s))}catch(s){console.error("Erreur lors de la création des préférences par défaut:",s),p.error("Erreur lors de la création des préférences par défaut")}};(async()=>{P(!0);try{const r=q(),s=(()=>{if(z?.email)return z.email;try{const e=JSON.parse(localStorage.getItem("user")||"{}");return e?.email||null}catch(e){return console.warn("Error parsing user email from localStorage:",e),null}})();if(!r)return console.error("No user ID available, cannot load notification settings"),void p.error("Erreur: Utilisateur non identifié");console.log("Chargement des préférences pour l'utilisateur ID:",r),console.log("Informations utilisateur:",z);const t=f(E,"notificationPreferences",r);console.log("Référence du document pour les préférences:",t.path);const a=await g(t);if(console.log("Préférences brutes depuis Firestore:",a.exists()?a.data():"Aucune préférence trouvée"),a.exists()){const o=a.data();if(o.userId&&o.userId!==r)return console.error("Erreur: Les préférences ne correspondent pas à l'utilisateur actuel",{expectedId:r,actualId:o.userId}),void(await e(r,s));!s||o.userEmail&&o.userEmail===s||(console.log("Mise à jour de l'email utilisateur dans les préférences",{oldEmail:o.userEmail||"none",newEmail:s}),await x(t,{userEmail:s,lastUpdated:new Date})),console.log("Préférences chargées depuis Firestore:",o);const i={app:{ROLE_UPDATE:!1!==o.ROLE_UPDATE,DOCUMENT_UPLOADED:!1!==o.DOCUMENT_UPLOADED,DOCUMENT_DELETED:!1!==o.DOCUMENT_DELETED,DOCUMENT_APPROVED:!1!==o.DOCUMENT_APPROVED,DOCUMENT_REJECTED:!1!==o.DOCUMENT_REJECTED}};console.log("Nouvelles préférences appliquées:",i),C(i),_(JSON.stringify(i))}else console.log("Aucune préférence trouvée pour cet utilisateur, création des valeurs par défaut"),await e(r,s)}catch(r){console.error("Erreur lors du chargement des paramètres:",r),p.error("Erreur lors du chargement des paramètres de notification")}finally{P(!1)}})()}),[z]);const V=({category:r,setting:s,label:t,description:o})=>{const i=U[r][s],n=R&&R.category===r&&R.setting===s;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50 "+(n?"bg-blue-50/50 dark:bg-blue-900/20":""),children:[e.jsxs("div",{className:"space-y-0.5 flex-1 mr-4",children:[e.jsx(j,{htmlFor:`${r}-${s}`,className:"text-gray-900 dark:text-gray-100 font-medium cursor-pointer",children:t}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:o})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(N,{id:`${r}-${s}`,checked:i,onCheckedChange:()=>(async(e,r)=>{A({category:e,setting:r});const s=q();if(!s)return void p.error("Erreur: Utilisateur non identifié");const t={...U,[e]:{...U[e],[r]:!U[e][r]}};C(t),console.log(`Changement de préférence pour utilisateur ${s}: ${r} → ${!U[e][r]}`),S(!0);try{await L(r,!U[e][r]);const t=f(E,"notificationPreferences",s),o=await g(t);if(o.exists()){const t=o.data();if(console.log("Préférences après mise à jour pour utilisateur",s,":",t),t.userId&&t.userId!==s)return console.error("Erreur: Les préférences ne correspondent pas à l'utilisateur",{expectedId:s,actualId:t.userId}),void p.error("Erreur lors de la mise à jour des préférences");if(t[r]!==!U[e][r])return console.error("La préférence n'a pas été correctement mise à jour:",{expected:!U[e][r],actual:t[r]}),void p.error("Erreur lors de la mise à jour des préférences");try{localStorage.setItem("notificationPreferences",JSON.stringify({...t,lastUpdated:(new Date).toISOString()})),console.log("Préférences sauvegardées dans le localStorage comme backup")}catch(a){console.warn("Impossible de sauvegarder les préférences dans localStorage:",a)}}p.success("Préférence de notification mise à jour")}catch(o){console.error("Erreur lors de la sauvegarde:",o),p.error("Erreur lors de la mise à jour des préférences"),C(U)}finally{S(!1)}setTimeout((()=>{A(null)}),1e3)})(r,s),className:(i?"dark:bg-blue-500":"dark:bg-gray-600")+" transition-all duration-200"}),e.jsx("div",{className:"ml-2 w-16 text-right relative h-5",children:e.jsx(D,{mode:"wait",children:e.jsx(a.span,{initial:{y:-10,opacity:0},animate:{y:0,opacity:1},exit:{y:10,opacity:0},transition:{duration:.2},className:"absolute right-0 text-xs font-medium "+(i?"text-blue-600 dark:text-blue-400":"text-gray-500 dark:text-gray-400"),children:i?"Activé":"Désactivé"},i?"on":"off")})})]})]})};return T?e.jsx("div",{className:"space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow dark:shadow-blue-900/10",children:e.jsx(v,{type:"notifications"})}):e.jsxs(a.div,{className:"space-y-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Paramètres de notification"}),e.jsxs(o,{variant:"outline",className:"flex items-center gap-2",onClick:async()=>{I(!0);try{await J()?(p.success("Préférences de notification réinitialisées avec succès"),window.location.reload()):p.error("Erreur lors de la réinitialisation des préférences")}catch(e){console.error("Erreur lors de la réinitialisation des préférences:",e),p.error("Erreur lors de la réinitialisation des préférences")}finally{I(!1)}},disabled:M||T,children:[e.jsx(i,{className:"h-4 w-4 "+(M?"animate-spin":"")}),"Réinitialiser les notifications"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Notifications"})]}),e.jsxs(y,{className:"border dark:border-blue-800 dark:bg-blue-900/20",children:[e.jsx(n,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsx(b,{className:"dark:text-white",children:"Gérez vos notifications"}),e.jsx(O,{className:"dark:text-gray-300",children:"Personnalisez la façon dont vous souhaitez être informé des activités importantes. Vos préférences seront conservées même après déconnexion."})]}),e.jsx("div",{className:"grid gap-6",children:e.jsxs(l,{className:"border dark:border-gray-700 transition-all hover:shadow-md dark:hover:shadow-blue-900/10",children:[e.jsxs(c,{className:"dark:border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),e.jsx(d,{className:"dark:text-white",children:"Notifications système"})]}),e.jsx(u,{className:"dark:text-gray-400",children:"Gérez vos notifications système."})]}),e.jsxs(m,{className:"space-y-4",children:[e.jsx(V,{category:"app",setting:"ROLE_UPDATE",label:"Changements de rôle",description:"Recevez des notifications lorsque votre rôle est modifié."}),e.jsx(V,{category:"app",setting:"DOCUMENT_UPLOADED",label:"Ajout de documents",description:"Recevez des notifications lorsqu'un document est ajouté à votre profil."}),e.jsx(V,{category:"app",setting:"DOCUMENT_DELETED",label:"Suppression de documents",description:"Recevez des notifications lorsqu'un document est supprimé de votre profil."}),e.jsx(V,{category:"app",setting:"DOCUMENT_APPROVED",label:"Approbation de documents",description:"Recevez des notifications lorsqu'un document est approuvé."}),e.jsx(V,{category:"app",setting:"DOCUMENT_REJECTED",label:"Rejet de documents",description:"Recevez des notifications lorsqu'un document est rejeté."})]})]})})]})};export{T as default};
