import{j as e}from"./ui-B5ZVMT00.js";import{r}from"./router-Cgxi-4fo.js";import{a1 as s,O as t,m as a,B as i,a2 as o,o as n,q as c,r as l,s as d,v as u,t as m,a3 as E,a4 as p,a5 as f,a6 as g,A as x,a7 as D}from"./index-B55PlCdI.js";import{S as N}from"./switch-fbMmz6Cg.js";import{L as h}from"./label-BEdedqxi.js";import{A as y,a as j,b as O}from"./alert-C5A0QBqW.js";import{P as T}from"./ProfileSettingsSkeleton-B2VEb88m.js";import{R as b}from"./refresh-cw-DdYQs95L.js";import"./react-0RZ2pslC.js";import"./query-DUefEkVx.js";import"./charts-D4j3G6dB.js";const P=()=>{const[P,U]=r.useState(!0),[v,C]=r.useState({app:{ROLE_UPDATE:!0,DOCUMENT_UPLOADED:!0,DOCUMENT_DELETED:!0,DOCUMENT_APPROVED:!0,DOCUMENT_REJECTED:!0,GUEST_APPLICATION:!0}}),[_,A]=r.useState(null),[w,I]=r.useState(!1),[S,k]=r.useState(null),[L,R]=r.useState(!1),{updateNotificationPreference:M,forceReinitializePreferences:z}=s(),{user:J}=t(),q=()=>{let e=null;if(J?.id)e=J.id;else if(localStorage.getItem("user"))try{const r=JSON.parse(localStorage.getItem("user"));r?.id&&(e=r.id)}catch(r){console.error("Error parsing user from localStorage:",r)}return e||(e=localStorage.getItem("userId")||localStorage.getItem("user_id")),e?String(e):(console.error("No user ID found"),null)};r.useEffect((()=>{const e=async(e,r)=>{try{const s={app:{ROLE_UPDATE:!0,DOCUMENT_UPLOADED:!0,DOCUMENT_DELETED:!0,DOCUMENT_APPROVED:!0,DOCUMENT_REJECTED:!0,GUEST_APPLICATION:!0}},t=E(p,"notificationPreferences",e),a={userId:e,userEmail:r||null,ROLE_UPDATE:!0,DOCUMENT_UPLOADED:!0,DOCUMENT_DELETED:!0,DOCUMENT_APPROVED:!0,DOCUMENT_REJECTED:!0,GUEST_APPLICATION:!0,createdAt:new Date,lastLogin:new Date};await D(t,a),C(s),A(JSON.stringify(s))}catch(s){console.error("Erreur lors de la création des préférences par défaut:",s),m.error("Erreur lors de la création des préférences par défaut")}};(async()=>{U(!0);try{const r=q(),s=(()=>{if(J?.email)return J.email;try{const e=JSON.parse(localStorage.getItem("user")||"{}");return e?.email||null}catch(e){return console.warn("Error parsing user email from localStorage:",e),null}})();if(!r)return console.error("No user ID available, cannot load notification settings"),void m.error("Erreur: Utilisateur non identifié");const t=E(p,"notificationPreferences",r),a=await f(t);if(a.exists()){const i=a.data();if(i.userId&&i.userId!==r)return console.error("Erreur: Les préférences ne correspondent pas à l'utilisateur actuel",{expectedId:r,actualId:i.userId}),void(await e(r,s));!s||i.userEmail&&i.userEmail===s||await g(t,{userEmail:s,lastUpdated:new Date});const o={app:{ROLE_UPDATE:!1!==i.ROLE_UPDATE,DOCUMENT_UPLOADED:!1!==i.DOCUMENT_UPLOADED,DOCUMENT_DELETED:!1!==i.DOCUMENT_DELETED,DOCUMENT_APPROVED:!1!==i.DOCUMENT_APPROVED,DOCUMENT_REJECTED:!1!==i.DOCUMENT_REJECTED,GUEST_APPLICATION:!1!==i.GUEST_APPLICATION}};C(o),A(JSON.stringify(o))}else await e(r,s)}catch(r){console.error("Erreur lors du chargement des paramètres:",r),m.error("Erreur lors du chargement des paramètres de notification")}finally{U(!1)}})()}),[J]);const G=({category:r,setting:s,label:t,description:i})=>{const o=v[r][s],n=S&&S.category===r&&S.setting===s;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50 "+(n?"bg-blue-50/50 dark:bg-blue-900/20":""),children:[e.jsxs("div",{className:"space-y-0.5 flex-1 mr-4",children:[e.jsx(h,{htmlFor:`${r}-${s}`,className:"text-gray-900 dark:text-gray-100 font-medium cursor-pointer",children:t}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:i})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(N,{id:`${r}-${s}`,checked:o,onCheckedChange:()=>(async(e,r)=>{k({category:e,setting:r});const s=q();if(!s)return void m.error("Erreur: Utilisateur non identifié");const t={...v,[e]:{...v[e],[r]:!v[e][r]}};C(t),I(!0);try{await M(r,!v[e][r]);const t=E(p,"notificationPreferences",s),i=await f(t);if(i.exists()){const t=i.data();if(t.userId&&t.userId!==s)return console.error("Erreur: Les préférences ne correspondent pas à l'utilisateur",{expectedId:s,actualId:t.userId}),void m.error("Erreur lors de la mise à jour des préférences");if(t[r]!==!v[e][r])return console.error("La préférence n'a pas été correctement mise à jour:",{expected:!v[e][r],actual:t[r]}),void m.error("Erreur lors de la mise à jour des préférences");try{localStorage.setItem("notificationPreferences",JSON.stringify({...t,lastUpdated:(new Date).toISOString()}))}catch(a){console.warn("Impossible de sauvegarder les préférences dans localStorage:",a)}}m.success("Préférence de notification mise à jour")}catch(i){console.error("Erreur lors de la sauvegarde:",i),m.error("Erreur lors de la mise à jour des préférences"),C(v)}finally{I(!1)}setTimeout((()=>{k(null)}),1e3)})(r,s),className:(o?"dark:bg-blue-500":"dark:bg-gray-600")+" transition-all duration-200"}),e.jsx("div",{className:"ml-2 w-16 text-right relative h-5",children:e.jsx(x,{mode:"wait",children:e.jsx(a.span,{initial:{y:-10,opacity:0},animate:{y:0,opacity:1},exit:{y:10,opacity:0},transition:{duration:.2},className:"absolute right-0 text-xs font-medium "+(o?"text-blue-600 dark:text-blue-400":"text-gray-500 dark:text-gray-400"),children:o?"Activé":"Désactivé"},o?"on":"off")})})]})]})};return P?e.jsx("div",{className:"space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow dark:shadow-blue-900/10",children:e.jsx(T,{type:"notifications"})}):e.jsxs(a.div,{className:"space-y-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Paramètres de notification"}),e.jsxs(i,{variant:"outline",className:"flex items-center gap-2",onClick:async()=>{R(!0);try{await z()?(m.success("Préférences de notification réinitialisées avec succès"),window.location.reload()):m.error("Erreur lors de la réinitialisation des préférences")}catch(e){console.error("Erreur lors de la réinitialisation des préférences:",e),m.error("Erreur lors de la réinitialisation des préférences")}finally{R(!1)}},disabled:L||P,children:[e.jsx(b,{className:"h-4 w-4 "+(L?"animate-spin":"")}),"Réinitialiser les notifications"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Notifications"})]}),e.jsxs(y,{className:"border dark:border-blue-800 dark:bg-blue-900/20",children:[e.jsx(o,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsx(j,{className:"dark:text-white",children:"Gérez vos notifications"}),e.jsx(O,{className:"dark:text-gray-300",children:"Personnalisez la façon dont vous souhaitez être informé des activités importantes. Vos préférences seront conservées même après déconnexion."})]}),e.jsx("div",{className:"grid gap-6",children:e.jsxs(n,{className:"border dark:border-gray-700 transition-all hover:shadow-md dark:hover:shadow-blue-900/10",children:[e.jsxs(c,{className:"dark:border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),e.jsx(l,{className:"dark:text-white",children:"Notifications système"})]}),e.jsx(d,{className:"dark:text-gray-400",children:"Gérez vos notifications système."})]}),e.jsxs(u,{className:"space-y-4",children:[e.jsx(G,{category:"app",setting:"ROLE_UPDATE",label:"Changements de rôle",description:"Recevez des notifications lorsque votre rôle est modifié."}),e.jsx(G,{category:"app",setting:"DOCUMENT_UPLOADED",label:"Ajout de documents",description:"Recevez des notifications lorsqu'un document est ajouté à votre profil."}),e.jsx(G,{category:"app",setting:"DOCUMENT_DELETED",label:"Suppression de documents",description:"Recevez des notifications lorsqu'un document est supprimé de votre profil."}),e.jsx(G,{category:"app",setting:"DOCUMENT_APPROVED",label:"Approbation de documents",description:"Recevez des notifications lorsqu'un document est approuvé."}),e.jsx(G,{category:"app",setting:"DOCUMENT_REJECTED",label:"Rejet de documents",description:"Recevez des notifications lorsqu'un document est rejeté."}),e.jsx(G,{category:"app",setting:"GUEST_APPLICATION",label:"Demandes d'inscription invité",description:"Recevez une notification lorsqu'un invité fait une demande d'inscription à une formation."})]})]})})]})};export{P as default};
