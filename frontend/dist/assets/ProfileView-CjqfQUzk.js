import{j as e}from"./ui-B9MhWaVJ.js";import{e as s,r as a}from"./router-D7BdrHDj.js";import{N as r,J as l,t,v as i,S as d,m as o,a3 as n,a4 as c,r as u,Z as m}from"./index-Bd05LC-l.js";import"./react-0RZ2pslC.js";import"./query-DKQ6_O-p.js";import"./charts-DkICKEBk.js";const f=()=>{const{userId:f}=s(),[p,h]=a.useState([]),[x,g]=a.useState(null),[j,w]=a.useState(!1),[N,v]=a.useState(!1),b=!!f,{user:y,isLoading:P,error:U,forceRefresh:k,setUser:E}=r({preferComprehensiveData:!0,enabled:!b}),[S,L]=a.useState(null),[C,A]=a.useState(!1),[D,I]=a.useState(null),M=a.useCallback((async(e=!0)=>{if(!N)try{v(!0);const s=await l.getMyProfile(e);s&&s.success&&s.data&&(g(s.data),y&&!b&&(y.studentProfile=s.data,T({studentProfile:s.data}))),w(!0)}catch(s){w(!0)}finally{v(!1)}}),[N,y,b]);a.useEffect((()=>{if(!b&&y&&!j&&!N){const e=y.roles?.some((e=>"string"==typeof e?e.includes("STUDENT"):!("object"!=typeof e||null===e||!e.name)&&e.name.includes("STUDENT")));e?M(!0):w(!0)}}),[b,y,j,N,M]);const T=a.useCallback((e=>{b?L((s=>({...s,...e}))):(E?E((s=>({...s,...e}))):k(),e.documents&&h(e.documents),e.studentProfile&&g(e.studentProfile)),!1!==e.toastMessage&&t.success(e.toastMessage||"Profil mis à jour")}),[b,E,k]);a.useEffect((()=>{if(!b){const e=async e=>{await M(!0)},s=async e=>{if(void 0!==e.detail?.portfolioUrl||"portfolio"===e.detail?.type){const s=e.detail.portfolioUrl||("portfolio"===e.detail.type?e.detail.portfolioUrl:void 0);x&&void 0!==s&&(g((e=>({...e,portfolioUrl:s}))),y&&y.studentProfile&&(y.studentProfile.portfolioUrl=s,T({studentProfile:{...y.studentProfile,portfolioUrl:s},toastMessage:!1}))),await M(!0)}};return window.addEventListener("job-status-updated",e),window.addEventListener("profile-updated",s),window.addEventListener("portfolio-updated",s),()=>{window.removeEventListener("job-status-updated",e),window.removeEventListener("profile-updated",s),window.removeEventListener("portfolio-updated",s)}}}),[b,M,x,y,T]),a.useEffect((()=>{const e=()=>{l.clearCache()};return window.addEventListener("beforeunload",e),l.clearCache(),()=>{window.removeEventListener("beforeunload",e)}}),[]),a.useEffect((()=>{if(b&&f){const e=y?.id;if(e&&e.toString()===f)return L(y),void A(!1);A(!0);(async()=>{try{const e=await u.get(`/profile/public/${f}`);e&&(!0===e.success||e.data)?L(e.data||e):I(e.error||"Failed to fetch profile data")}catch(e){I(e.message||"Error fetching profile data")}finally{A(!1)}})()}}),[f,b,y]);const{profilePictureUrl:z,isLoading:R,refetch:q}=i(),F=b?S:y,J=(b?C:P)||R,Z=b?D:U;a.useEffect((()=>{z||R||q()}),[f]),a.useEffect((()=>{F&&z&&F.profilePictureUrl!==z&&(F.profilePictureUrl=z)}),[F,z,b]),a.useEffect((()=>{b||J||Z||!F||(async()=>{try{const e=await m.getDocuments(!0);h(e)}catch(e){console.error("Error fetching documents:",e)}})()}),[b,J,Z,F]);if(a.useEffect((()=>{localStorage.removeItem("user"),sessionStorage.removeItem("user"),k&&k()}),[f,k]),J)return e.jsxs("div",{className:"w-full max-w-7xl mx-auto px-4 py-6 space-y-8","data-testid":"profile-loading",children:[e.jsx("div",{className:"w-full bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"p-6 sm:p-8",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6 items-start",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -inset-0.5 bg-gradient-to-r from-primary/30 to-indigo-600/30 rounded-full opacity-75 blur"}),e.jsx(d,{className:"h-24 w-24 sm:h-32 sm:w-32 rounded-full border-4 border-background relative"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-start gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"h-8 w-64 mb-2"}),e.jsx(d,{className:"h-4 w-48 mb-4"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[e.jsx(d,{className:"h-6 w-24 rounded-full"}),e.jsx(d,{className:"h-6 w-32 rounded-full"})]})]}),e.jsx(d,{className:"h-10 w-36"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{className:"h-6 w-48"}),e.jsx(d,{className:"h-6 w-56"})]})]})]})})}),e.jsxs("div",{children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-1 rounded-lg mb-6",children:e.jsxs("div",{className:"grid w-full grid-cols-2 h-auto p-1",children:[e.jsx(d,{className:"h-12 rounded-md"}),e.jsx(d,{className:"h-12 rounded-md"})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"overflow-hidden border-none shadow-md bg-white dark:bg-slate-800 rounded-lg",children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 p-4",children:e.jsx(d,{className:"h-6 w-48"})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-20 w-full rounded-lg"}),e.jsx(d,{className:"h-20 w-full rounded-lg"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-20 w-full rounded-lg"}),e.jsx(d,{className:"h-20 w-full rounded-lg"})]})]})})]}),e.jsxs("div",{className:"overflow-hidden border-none shadow-md bg-white dark:bg-slate-800 rounded-lg",children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 p-4",children:e.jsx(d,{className:"h-6 w-36"})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-20 w-full rounded-lg"}),e.jsx(d,{className:"h-20 w-full rounded-lg"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{className:"h-20 w-full rounded-lg"}),e.jsx(d,{className:"h-20 w-full rounded-lg"})]})]})})]})]})]})]});if(Z)return e.jsx("div",{className:"w-full max-w-7xl mx-auto px-4 py-6","data-testid":"profile-error",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Erreur :"}),e.jsxs("span",{className:"block sm:inline",children:[" ",Z.message||"Une erreur est survenue lors du chargement du profil."]})]})});if(!F)return e.jsx("div",{className:"w-full max-w-7xl mx-auto px-4 py-6","data-testid":"profile-no-data",children:e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded relative",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Attention :"}),e.jsx("span",{className:"block sm:inline",children:" Aucune donnée de profil n'est disponible."})]})});let $;return $=b?{user:{id:F.id||F.user?.id,firstName:F.firstName||F.user?.firstName||"",lastName:F.lastName||F.user?.lastName||"",email:F.email||F.user?.email||"",phoneNumber:F.phoneNumber||F.user?.phoneNumber||"",profilePictureUrl:z||F.profilePictureUrl||F.user?.profilePictureUrl||"",roles:Array.isArray(F.roles)?F.roles.map((e=>"string"==typeof e?{name:e}:e)):F.user?.roles||[{name:"USER"}],specialization:F.specialization||F.user?.specialization||{},linkedinUrl:F.linkedinUrl||F.user?.linkedinUrl||"",city:F.city||""},studentProfile:F.studentProfile||{isSeekingInternship:!1,isSeekingApprenticeship:!1},diplomas:F.diplomas||[],addresses:F.addresses||[],documents:F.documents||[],stats:F.stats||{profile:{completionPercentage:0}}}:{user:F,studentProfile:x||F.studentProfile||{isSeekingInternship:!1,isSeekingApprenticeship:!1},diplomas:F.diplomas||[],addresses:F.addresses||[],documents:p.length>0?p:F.documents||[],stats:F.stats||{profile:{completionPercentage:0}}},e.jsxs(o.div,{className:"w-full max-w-7xl mx-auto px-4 py-6 space-y-8",variants:{hidden:{opacity:0},visible:{opacity:1,transition:{when:"beforeChildren",staggerChildren:.2,duration:.3}}},initial:"hidden",animate:"visible","data-testid":"profile-view",children:[e.jsx(n,{userData:$,isPublicProfile:b,profilePictureUrl:z,onProfileUpdate:T}),e.jsx(c,{userData:$,isPublicProfile:b,documents:p,onProfileUpdate:T})]})};export{f as default};
