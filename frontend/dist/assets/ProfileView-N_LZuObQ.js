import{j as e}from"./ui-B5ZVMT00.js";import{e as s,r as a}from"./router-Cgxi-4fo.js";import{X as l,V as r,t as d,z as t,S as i,m as o,ai as c,aj as n,x as m,ab as u}from"./index-2R14kkJt.js";import"./react-0RZ2pslC.js";import"./query-DUefEkVx.js";import"./charts-D4j3G6dB.js";const f=()=>{const{userId:f}=s(),[x,h]=a.useState([]),[p,g]=a.useState(null),[j,N]=a.useState(!1),[w,v]=a.useState(!1),b=!!f,{user:y,isLoading:P,error:k,forceRefresh:S,setUser:E}=l({userId:b?f:void 0,preferComprehensiveData:!0,enabled:!0}),[U,C]=a.useState(null),[D,I]=a.useState(!1),[L,T]=a.useState(null),A=a.useCallback((async(e=!0)=>{if(!w)try{v(!0);const s=await r.getMyProfile(e);s&&s.success&&s.data&&(g(s.data),y&&!b&&(y.studentProfile=s.data,M({studentProfile:s.data}))),N(!0)}catch(s){N(!0)}finally{v(!1)}}),[w,y,b]);a.useEffect((()=>{if(!b&&y&&!j&&!w){const e=y.roles?.some((e=>"string"==typeof e?e.includes("STUDENT"):!("object"!=typeof e||null===e||!e.name)&&e.name.includes("STUDENT")));e?A(!0):N(!0)}}),[b,y,j,w,A]);const M=a.useCallback((e=>{b?C((s=>({...s,...e}))):(E?E((s=>({...s,...e}))):S(),e.documents&&h(e.documents),e.studentProfile&&g(e.studentProfile)),!1!==e.toastMessage&&d.success(e.toastMessage||"Profil mis à jour")}),[b,E,S]);a.useEffect((()=>{if(b&&f){const e=y?.id;if(e&&e.toString()===f)return C(y),void I(!1);I(!0);(async()=>{try{const e=await m.get(`/profile/public/${f}`);e&&(!0===e.success||e.data)?C(e.data||e):T(e.error||"Failed to fetch profile data")}catch(e){T(e.message||"Error fetching profile data")}finally{I(!1)}})()}}),[f,b,y]);const{profilePictureUrl:q,isLoading:z,refetch:F}=t(),R=b?U:y,V=(b?D:P)||z,X=b?L:k;a.useEffect((()=>{q||z||F()}),[f]),a.useEffect((()=>{R&&q&&R.profilePictureUrl!==q&&(R.profilePictureUrl=q)}),[R,q,b]),a.useEffect((()=>{b||V||X||!R||(async()=>{try{const e=await u.getDocuments(!0);h(e)}catch(e){console.error("Error fetching documents:",e)}})()}),[b,V,X,R]);if(a.useEffect((()=>{const e=()=>{r.clearCache()};return window.addEventListener("beforeunload",e),r.clearCache(),()=>{window.removeEventListener("beforeunload",e)}}),[]),a.useEffect((()=>{localStorage.removeItem("user"),sessionStorage.removeItem("user"),S&&S()}),[f,S]),V)return e.jsxs("div",{className:"w-full max-w-7xl mx-auto px-4 py-6 space-y-8","data-testid":"profile-loading",children:[e.jsx("div",{className:"w-full bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"p-6 sm:p-8",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6 items-start",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -inset-0.5 bg-gradient-to-r from-primary/30 to-indigo-600/30 rounded-full opacity-75 blur"}),e.jsx(i,{className:"h-24 w-24 sm:h-32 sm:w-32 rounded-full border-4 border-background relative"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-start gap-4",children:[e.jsxs("div",{children:[e.jsx(i,{className:"h-8 w-64 mb-2"}),e.jsx(i,{className:"h-4 w-48 mb-4"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[e.jsx(i,{className:"h-6 w-24 rounded-full"}),e.jsx(i,{className:"h-6 w-32 rounded-full"})]})]}),e.jsx(i,{className:"h-10 w-36"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(i,{className:"h-6 w-48"}),e.jsx(i,{className:"h-6 w-56"})]})]})]})})}),e.jsxs("div",{children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-1 rounded-lg mb-6",children:e.jsxs("div",{className:"grid w-full grid-cols-2 h-auto p-1",children:[e.jsx(i,{className:"h-12 rounded-md"}),e.jsx(i,{className:"h-12 rounded-md"})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"overflow-hidden border-none shadow-md bg-white dark:bg-slate-800 rounded-lg",children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 p-4",children:e.jsx(i,{className:"h-6 w-48"})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"h-20 w-full rounded-lg"}),e.jsx(i,{className:"h-20 w-full rounded-lg"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"h-20 w-full rounded-lg"}),e.jsx(i,{className:"h-20 w-full rounded-lg"})]})]})})]}),e.jsxs("div",{className:"overflow-hidden border-none shadow-md bg-white dark:bg-slate-800 rounded-lg",children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 p-4",children:e.jsx(i,{className:"h-6 w-36"})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"h-20 w-full rounded-lg"}),e.jsx(i,{className:"h-20 w-full rounded-lg"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"h-20 w-full rounded-lg"}),e.jsx(i,{className:"h-20 w-full rounded-lg"})]})]})})]})]})]})]});if(X)return e.jsx("div",{className:"w-full max-w-7xl mx-auto px-4 py-6","data-testid":"profile-error",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Erreur :"}),e.jsxs("span",{className:"block sm:inline",children:[" ",X.message||"Une erreur est survenue lors du chargement du profil."]})]})});if(!R)return e.jsx("div",{className:"w-full max-w-7xl mx-auto px-4 py-6","data-testid":"profile-no-data",children:e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded relative",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Attention :"}),e.jsx("span",{className:"block sm:inline",children:" Aucune donnée de profil n'est disponible."})]})});const $={user:y||{},studentProfile:p||{isSeekingInternship:!1,isSeekingApprenticeship:!1},diplomas:y?.diplomas||[],addresses:y?.addresses||[],documents:x.length>0?x:y?.documents||[],stats:y?.stats||{profile:{completionPercentage:0}}};return e.jsxs(o.div,{className:"w-full max-w-7xl mx-auto px-4 py-6 space-y-8",variants:{hidden:{opacity:0},visible:{opacity:1,transition:{when:"beforeChildren",staggerChildren:.2,duration:.3}}},initial:"hidden",animate:"visible","data-testid":"profile-view",children:[e.jsx(c,{userData:$,isPublicProfile:b,profilePictureUrl:q,onProfileUpdate:M}),e.jsx(n,{userData:$,isPublicProfile:b,documents:x,onProfileUpdate:M})]})};export{f as default};
