import{j as e}from"./ui-B5ZVMT00.js";import{r}from"./router-Cgxi-4fo.js";import{y as a,x as s,$ as t,o,q as d,r as c,s as i,v as l,B as n,w as u,D as m,a0 as p,k as x,H as h,l as g,n as y,I as v,t as j,b as k}from"./index-XAN29Is_.js";import{I as f}from"./input-C0qWiGl4.js";import{L as b}from"./label-SSxY3P1H.js";import{A as N,a as w,b as S}from"./alert-D7Qliu0q.js";import{P as A}from"./ProfileSettingsSkeleton-BdE-90xB.js";import{E,a as C}from"./eye-Ok-5IPJT.js";import{C as z}from"./circle-alert-DsiMPx8y.js";import"./react-0RZ2pslC.js";import"./query-DUefEkVx.js";import"./charts-D4j3G6dB.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=a("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]),q=a("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]),D=a("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),P={getUserData:async()=>{try{return(await s.get("/api/profile/user-data")).data.data.user}catch(e){throw console.error("Erreur lors de la récupération des données utilisateur:",e),e}},getUserDiplomas:async()=>{try{return(await s.get("/api/profile/diplomas")).data.data.diplomas}catch(e){throw console.error("Erreur lors de la récupération des diplômes:",e),e}},getUserAddresses:async()=>{try{return(await s.get("/api/profile/addresses")).data.data.addresses}catch(e){throw console.error("Erreur lors de la récupération des adresses:",e),e}},getUserStats:async()=>{try{return(await s.get("/api/profile/stats")).data.data.stats}catch(e){throw console.error("Erreur lors de la récupération des statistiques:",e),e}},getAllProfilData:async()=>{try{const r=await s.get("/api/profile/all");let a={};if(r&&r.data){const e=r.data.data;a=e.user?{...e.user,addresses:Array.isArray(e.user.addresses)?e.user.addresses:[],diplomas:Array.isArray(e.user.diplomas)?e.user.diplomas:Array.isArray(e.diplomas)?e.diplomas:[],stats:e.stats||{profile:{completionPercentage:0}}}:{...e,addresses:Array.isArray(e.addresses)?e.addresses:[],diplomas:Array.isArray(e.diplomas)?e.diplomas:[],stats:e.stats||{profile:{completionPercentage:0}}},a.studentProfile||(a.studentProfile={portfolioUrl:null,isSeekingInternship:!1,isSeekingApprenticeship:!1,currentInternshipCompany:null,internshipStartDate:null,internshipEndDate:null,situationType:null})}try{localStorage.setItem("user",JSON.stringify(a))}catch(e){console.error("Error storing user data in localStorage:",e)}return a}catch(r){console.error("Erreur lors de la récupération des données du profil:",r);try{const e=localStorage.getItem("user");if(e)return JSON.parse(e)}catch(e){console.error("Error getting user data from localStorage:",e)}try{const[r,a,s,t]=await Promise.all([P.getUserData(),P.getUserDiplomas(),P.getUserAddresses(),P.getUserStats()]),o={...r,diplomas:a,addresses:s,stats:t};try{localStorage.setItem("user",JSON.stringify(o))}catch(e){console.error("Error storing fallback user data in localStorage:",e)}return o}catch(a){throw console.error("Échec du fallback pour récupérer les données:",a),r}}},deactivateAccount:async()=>{try{return await s.post("/api/profile/deactivate")}catch(e){throw console.error("Erreur lors de la désactivation du compte:",e),e}},getCurrentStatus:async()=>{try{return await s.get("/api/profile/status")}catch(e){throw console.error("Erreur lors de la récupération du statut:",e),e}}},U=()=>{const[a,s]=r.useState(""),[U,V]=r.useState(""),[M,T]=r.useState(""),[L,O]=r.useState(!1),[J,F]=r.useState(!0),[G,R]=r.useState(!1),[B,H]=r.useState(!1),[K,$]=r.useState([]),[Q,W]=r.useState(!1),[X,Y]=r.useState(!1),[Z,_]=r.useState(!1),[ee,re]=r.useState(!1);r.useEffect((()=>{(async()=>{try{const e=localStorage.getItem("userRoles"),r=e?JSON.parse(e):[];$(r);const a=r.some((e=>"string"==typeof e?e.includes("GUEST")||e.includes("INVITE"):e.name&&(e.name.includes("GUEST")||e.name.includes("INVITE"))));W(a)}catch(e){j.error("Erreur lors du chargement des paramètres de sécurité")}finally{F(!1)}})()}),[]);return J?e.jsx("div",{className:"space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow dark:shadow-blue-900/10",children:e.jsx(A,{type:"security"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Sécurité"})]}),e.jsxs(N,{className:"border dark:border-blue-800 dark:bg-blue-900/20",children:[e.jsx(t,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsx(w,{className:"dark:text-white",children:"Sécurité du compte"}),e.jsx(S,{className:"dark:text-gray-300",children:"Protégez votre compte en utilisant un mot de passe fort et en activant l'authentification à deux facteurs."})]}),e.jsxs("div",{className:"grid gap-6",children:[e.jsxs(o,{className:"border dark:border-gray-700",children:[e.jsxs(d,{className:"dark:border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),e.jsx(c,{className:"dark:text-white",children:"Changer le mot de passe"})]}),e.jsx(i,{className:"dark:text-gray-400",children:"Choisissez un mot de passe fort et unique que vous n'utilisez pour aucun autre compte."})]}),e.jsx(l,{children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),a)if(U)if(U.length<8)j.error("Le nouveau mot de passe doit contenir au moins 8 caractères");else if(U===M)if(a!==U){O(!0);try{const e=await k.changePassword({currentPassword:a,newPassword:U});e.success?(j.success(e.message||"Mot de passe modifié avec succès"),s(""),V(""),T("")):j.error(e.message||"Erreur lors du changement de mot de passe")}catch(r){j.error(r.response?.data?.message||"Erreur lors du changement de mot de passe")}finally{O(!1)}}else j.error("Le nouveau mot de passe doit être différent du mot de passe actuel");else j.error("Les mots de passe ne correspondent pas");else j.error("Veuillez saisir un nouveau mot de passe");else j.error("Veuillez saisir votre mot de passe actuel")},className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"current-password",className:"text-gray-700 dark:text-gray-300",children:"Mot de passe actuel"}),e.jsxs("div",{className:"relative",children:[e.jsx(f,{id:"current-password",type:X?"text":"password",value:a,onChange:e=>s(e.target.value),required:!0,className:"pr-10 dark:bg-gray-700/50 dark:border-gray-600"}),e.jsx(n,{type:"button",variant:"ghost",size:"icon",className:"absolute right-0 top-0 h-full px-3 dark:text-gray-300 dark:hover:bg-gray-700/50",onClick:()=>Y(!X),tabIndex:"-1",children:X?e.jsx(E,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"}):e.jsx(C,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"new-password",className:"text-gray-700 dark:text-gray-300",children:"Nouveau mot de passe"}),e.jsxs("div",{className:"relative",children:[e.jsx(f,{id:"new-password",type:Z?"text":"password",value:U,onChange:e=>V(e.target.value),required:!0,className:"pr-10 dark:bg-gray-700/50 dark:border-gray-600"}),e.jsx(n,{type:"button",variant:"ghost",size:"icon",className:"absolute right-0 top-0 h-full px-3 dark:text-gray-300 dark:hover:bg-gray-700/50",onClick:()=>_(!Z),tabIndex:"-1",children:Z?e.jsx(E,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"}):e.jsx(C,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"confirm-password",className:"text-gray-700 dark:text-gray-300",children:"Confirmer le nouveau mot de passe"}),e.jsxs("div",{className:"relative",children:[e.jsx(f,{id:"confirm-password",type:ee?"text":"password",value:M,onChange:e=>T(e.target.value),required:!0,className:"pr-10 dark:bg-gray-700/50 dark:border-gray-600"}),e.jsx(n,{type:"button",variant:"ghost",size:"icon",className:"absolute right-0 top-0 h-full px-3 dark:text-gray-300 dark:hover:bg-gray-700/50",onClick:()=>re(!ee),tabIndex:"-1",children:ee?e.jsx(E,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"}):e.jsx(C,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"})})]})]}),e.jsx(n,{type:"submit",disabled:L,children:L?"Modification en cours...":"Modifier le mot de passe"})]})})]}),e.jsxs(o,{className:"border dark:border-gray-700",children:[e.jsxs(d,{className:"dark:border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),e.jsx(c,{className:"dark:text-white",children:"Authentification à deux facteurs"})]}),e.jsx(i,{className:"dark:text-gray-400",children:"Ajoutez une couche de sécurité supplémentaire à votre compte en activant l'authentification à deux facteurs."})]}),e.jsxs(l,{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:"L'authentification à deux facteurs ajoute une couche de sécurité supplémentaire à votre compte en demandant un code en plus de votre mot de passe."}),e.jsx(n,{variant:"outline",className:"dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700",children:"Configurer l'authentification à deux facteurs"})]}),e.jsx(u,{className:"bg-gray-50 dark:bg-gray-800/60 dark:border-t dark:border-gray-700",children:e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Vous devrez entrer un code à chaque connexion une fois l'authentification à deux facteurs activée."})})]}),Q&&e.jsxs(o,{className:"border-destructive dark:border-red-800",children:[e.jsxs(d,{className:"dark:border-b dark:border-red-800/70",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5 text-destructive dark:text-red-500"}),e.jsx(c,{className:"text-destructive dark:text-red-500",children:"Désactiver mon compte"})]}),e.jsx(i,{className:"dark:text-gray-400",children:"Désactivez temporairement votre compte. Vous pourrez le réactiver ultérieurement en contactant l'administration."})]}),e.jsxs(l,{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:"La désactivation de votre compte conservera toutes vos données, mais vous n'aurez plus accès à l'application jusqu'à sa réactivation."}),e.jsxs(m,{open:B,onOpenChange:H,children:[e.jsx(p,{asChild:!0,children:e.jsx(n,{variant:"destructive",children:"Désactiver mon compte"})}),e.jsxs(x,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsxs(h,{children:[e.jsxs(g,{className:"flex items-center gap-2 dark:text-white",children:[e.jsx(z,{className:"h-5 w-5 text-destructive dark:text-red-500"}),e.jsx("span",{children:"Désactiver votre compte ?"})]}),e.jsxs(y,{className:"dark:text-gray-300",children:["Cette action va désactiver votre compte. Vous n'aurez plus accès à l'application jusqu'à ce qu'un administrateur réactive votre compte.",e.jsx("br",{}),e.jsx("br",{}),"Toutes vos données seront conservées mais inaccessibles jusqu'à la réactivation."]})]}),e.jsxs(v,{children:[e.jsx(n,{variant:"outline",onClick:()=>H(!1),className:"dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700",children:"Annuler"}),e.jsx(n,{variant:"destructive",onClick:async()=>{R(!0);try{const e=await P.deactivateAccount();e.success?(j.success(e.message||"Votre compte a été désactivé avec succès"),H(!1),setTimeout((()=>{k.logout(),window.location.href="/login"}),3e3)):j.error(e.message||"Erreur lors de la désactivation du compte")}catch(e){j.error(e.response?.data?.message||"Erreur lors de la désactivation du compte")}finally{R(!1)}},disabled:G,children:G?"Désactivation en cours...":"Confirmer la désactivation"})]})]})]})]}),e.jsx(u,{className:"bg-destructive/10 dark:bg-red-900/20 dark:border-t dark:border-red-800/50",children:e.jsx("p",{className:"text-sm text-destructive dark:text-red-400",children:"Attention : Un administrateur devra réactiver votre compte si vous souhaitez y accéder à nouveau."})})]})]})]})};export{U as default};
