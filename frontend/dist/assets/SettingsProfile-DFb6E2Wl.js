import{j as e}from"./ui-B9MhWaVJ.js";import{r as s,R as a}from"./router-D7BdrHDj.js";import{s as r,v as l,A as t,w as i,U as o,x as n,B as d,D as m,g as c,y as u,h,i as p,z as x,S as f,t as g,E as j,f as N,F as v,M as w,G as y,H as b,I as E,L as D,J as U,K as C,N as P,O as S,k,l as M,n as F,o as L,p as A,Q as R}from"./index-Bd05LC-l.js";import{u as I}from"./query-DKQ6_O-p.js";import{L as T}from"./loader-circle-BrSWE4DC.js";import{U as z,f as O,E as V,P as q,c as Q}from"./JobSeekingSettings-CSuKU92O.js";import{T as $}from"./trash-2-DKnnSyZj.js";import{i as _,b as K,c as G,d as J,e as W}from"./phone-input-CRnCpG_6.js";import{L as Y}from"./label-8eTlumoe.js";import{I as B}from"./input-CRxVDqWf.js";import{S as H}from"./switch-CR_l9-Tu.js";import{f as X}from"./index-DV0JwV4u.js";import{a as Z}from"./api-O7WXtPX6.js";import{P as ee}from"./phone-DdTCirMT.js";import"./command-BHW6ogSE.js";import"./react-0RZ2pslC.js";import"./charts-DkICKEBk.js";import"./download-gCgY_qOV.js";import"./circle-alert-DkC07JJn.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=r("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]),ae=()=>e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx(f,{className:"w-20 h-20 sm:w-28 sm:h-28 md:w-32 md:h-32 rounded-full"}),e.jsx(f,{className:"absolute bottom-2 right-2 w-6 h-6 sm:w-8 sm:h-8 rounded-full"})]}),e.jsx(f,{className:"h-6 w-32 mb-1"}),e.jsx(f,{className:"h-4 w-48"})]}),re=({userData:r,onProfilePictureChange:f,isLoading:j=!1})=>{const N=s.useRef(null),[v,w]=a.useState(!1),[y,b]=a.useState(!1),{profilePictureUrl:E,isLoading:D,isFetching:U,refetch:C,uploadProfilePicture:P,deleteProfilePicture:S,uploadStatus:k,deleteStatus:M}=l(),F=s.useRef(null);s.useRef(((e,s)=>{let a;return function(...r){clearTimeout(a),a=setTimeout((()=>{clearTimeout(a),e(...r)}),s)}})((e=>{var s;!f||((s=e)&&s.startsWith("blob:")||s===F.current||(F.current=s,0))||(console.log("ProfilePicture - Profile picture URL changed, notifying parent (debounced)"),f(e))}),2e3)).current,a.useEffect((()=>{}),[E]);const L=()=>{k.isPending||M.isPending||N.current?.click()},A=D||U||M.isPending||k.isPending||j;if(D&&!E)return e.jsx(ae,{});return e.jsxs("div",{className:"p-4 sm:p-6 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"relative mb-3",children:[e.jsxs("div",{className:"w-20 h-20 sm:w-28 sm:h-28 md:w-32 md:h-32 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden group relative cursor-pointer border-2 border-white dark:border-gray-700 shadow-sm",onClick:L,children:[k.isPending||y?e.jsx(T,{className:"w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 text-gray-400 animate-spin"}):E?e.jsx("img",{src:E?E.startsWith("blob:")?(console.log("Blob URL detected, using fallback:",E),null):E:null,alt:"Photo de profil",className:"object-cover w-full h-full",onError:e=>{console.error("Image failed to load:",e.target.src),e.target.style.display="none",e.target.onerror=null;const s=document.createElement("div");s.innerHTML='<div class="w-full h-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 sm:w-14 sm:h-14 md:w-16 md:h-16 text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>',e.target.parentNode.appendChild(s.firstChild)}}):e.jsx(t,{className:"w-full h-full",children:e.jsx(i,{className:"bg-gradient-to-r from-[#02284f] to-[#03386b] text-white",children:e.jsx(o,{className:"w-10 h-10 sm:w-14 sm:h-14 md:w-16 md:h-16"})})}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(n,{className:"w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 text-white"})})]}),e.jsx("input",{ref:N,type:"file",accept:"image/*",className:"hidden",onChange:async e=>{const s=e.target.files?.[0];if(!s)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(s.type))return void g.error("Type de fichier non autorisé. Formats acceptés: JPG, PNG, GIF, WEBP");const a=s.name.substring(s.name.lastIndexOf(".")).toLowerCase();if(![".jpg",".jpeg",".png",".gif",".webp"].includes(a))return void g.error("Extension de fichier non autorisée. Extensions acceptées: JPG, PNG, GIF, WEBP");if(s.size>2097152)g.error("La taille du fichier dépasse la limite autorisée (2MB)");else try{const e=s.name.split("."),a=e.pop().toLowerCase(),r=`${e.join(".")}.${a}`,l=new File([s],r,{type:s.type}),t=new FormData;t.append("profile_picture",l),P(t,{onSuccess:()=>{g.success("Photo de profil mise à jour avec succès")},onError:()=>{g.error("Erreur lors de la mise à jour de la photo de profil")}})}catch(r){console.error("Erreur non gérée lors de l'upload:",r),g.error("Erreur lors de la mise à jour de la photo de profil")}}}),e.jsx(d,{variant:"ghost",size:"icon",className:"absolute bottom-0 right-0 rounded-full p-1 sm:p-1.5 md:p-2 bg-white dark:bg-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-600",onClick:L,disabled:A,children:e.jsx(z,{className:"w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5"})}),E&&e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>w(!0),disabled:A,className:"absolute top-0 right-0 rounded-full p-1 sm:p-1.5 md:p-2 bg-white dark:bg-gray-700 shadow-sm hover:bg-red-50 hover:text-red-600 transition-colors",children:M.isPending?e.jsx(T,{className:"w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 animate-spin"}):e.jsx($,{className:"w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5"})})]}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-1",children:"Photo de profil"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Mettre à jour votre photo"})]}),e.jsx(m,{open:v,onOpenChange:e=>!M.isPending&&w(e),children:e.jsxs(c,{className:"max-h-[calc(100vh-2rem)] w-full max-w-md overflow-hidden rounded-2xl border-0 shadow-xl",children:[e.jsx("div",{className:"overflow-y-auto max-h-[70vh] fade-in-up",children:e.jsxs(u,{children:[e.jsx(h,{className:"text-xl font-semibold",children:"Confirmation de suppression"}),e.jsx(p,{className:"text-base mt-2",children:"Êtes-vous sûr de vouloir supprimer votre photo de profil ? Cette action est irréversible."})]})}),e.jsxs(x,{className:"mt-6 flex justify-end space-x-2",children:[e.jsx(d,{variant:"outline",onClick:()=>w(!1),disabled:M.isPending,className:"rounded-full border-2 hover:bg-gray-100 transition-all duration-200",children:"Annuler"}),e.jsx(d,{variant:"destructive",onClick:async()=>{try{w(!1),b(!0),C(),await S(null,{onSuccess:()=>{setTimeout((()=>{C()}),300)},onError:e=>{C(),g.error("Erreur lors de la suppression de la photo de profil")}})}catch(e){g.error("Erreur lors de la suppression de la photo de profil")}finally{b(!1)}},disabled:M.isPending,className:"rounded-full bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 transition-all duration-200 "+(M.isPending?"opacity-80":""),children:M.isPending?"Suppression...":"Supprimer"})]})]})})]})},le=()=>e.jsxs("div",{className:"container mx-auto p-6",children:[e.jsx(f,{className:"h-10 w-48 mb-8"}),e.jsx("div",{className:"bg-white p-6 rounded-lg shadow-sm mb-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-6 mb-6",children:[e.jsx(f,{className:"h-24 w-24 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-6 w-48"}),e.jsx(f,{className:"h-4 w-32"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(f,{className:"h-16 w-full"}),e.jsx(f,{className:"h-16 w-full"}),e.jsx(f,{className:"h-16 w-full"}),e.jsx(f,{className:"h-16 w-full"})]}),e.jsx(f,{className:"h-16 w-full"}),e.jsx(f,{className:"h-16 w-full"}),e.jsxs("div",{className:"mt-8",children:[e.jsx(f,{className:"h-6 w-32 mb-4"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(f,{className:"h-16 w-full"}),e.jsx(f,{className:"h-16 w-full"})]})]}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsx(f,{className:"h-10 w-48"})})]})}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm",children:[e.jsx(f,{className:"h-6 w-48 mb-6"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(f,{className:"h-16 w-full"}),e.jsx(f,{className:"h-16 w-full"})]})]})]}),te=e=>{if(!e)return"Non renseigné";try{const s=new Date(e);if(isNaN(s.getTime()))return"Date invalide";const a=6e4*s.getTimezoneOffset(),r=new Date(s.getTime()-a);return X(r,"dd MMMM yyyy",{locale:j})}catch(s){return"Date invalide"}},ie=e=>{if(!e)return"Non renseignée";let s=[];return e.name&&s.push(e.name),e.complement&&s.push(e.complement),e.postalCode?.code&&s.push(e.postalCode.code),e.city?.name&&s.push(e.city.name),s.join(", ")||"Adresse incomplète"},oe=({label:s,icon:a,value:r,fieldType:l="text"})=>{const t=((e,s="text")=>"phone"===s&&e?O(e):e)(r,l);return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 sm:p-5",children:[e.jsx(Y,{className:"text-sm font-medium text-gray-700",children:s}),e.jsx("div",{className:"mt-2",children:e.jsxs("div",{className:"flex items-center text-sm text-gray-900",children:[a,e.jsx("span",{className:"font-medium break-words",children:t})]})})]})},ne=({userData:s,editedData:a,editMode:r,isFieldEditable:l,toggleFieldEdit:t,handleCancelField:i,handleInputChange:n,onSave:d})=>e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5 md:gap-6",children:[l("firstName")?e.jsx(V,{field:"firstName",label:"Prénom",icon:e.jsx(o,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 mr-1.5 sm:mr-2 text-gray-500"}),value:s.firstName,editedValue:a.personal.firstName,isEditing:r.firstName,isEditable:!0,onEdit:()=>t("firstName"),onSave:d,onCancel:()=>i("firstName"),onChange:e=>n("firstName",e)}):e.jsx(oe,{label:"Prénom",icon:e.jsx(o,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 mr-1.5 sm:mr-2 text-gray-500"}),value:s.firstName||"Non renseigné"}),l("lastName")?e.jsx(V,{field:"lastName",label:"Nom",icon:e.jsx(o,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 mr-1.5 sm:mr-2 text-gray-500"}),value:s.lastName,editedValue:a.personal.lastName,isEditing:r.lastName,isEditable:!0,onEdit:()=>t("lastName"),onSave:d,onCancel:()=>i("lastName"),onChange:e=>n("lastName",e)}):e.jsx(oe,{label:"Nom",icon:e.jsx(o,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 mr-1.5 sm:mr-2 text-gray-500"}),value:s.lastName||"Non renseigné"}),e.jsx(oe,{label:"Date de naissance",icon:e.jsx(N,{className:"h-4 w-4 mr-2 text-blue-500"}),value:`${te(s.birthDate)}${s.age?` (${s.age} ans)`:""}`}),e.jsx(oe,{label:"Nationalité",icon:e.jsx(se,{className:"h-4 w-4 mr-2 text-blue-500"}),value:s.nationality?.name||"Non renseignée"})]}),de=({userData:a,editedData:r,editMode:l,setEditMode:t,setEditedData:i,onSaveAddress:o,isAdmin:n,handleCancelAddress:m})=>{const c="address",u=l[c],h=a.addresses&&a.addresses.length>0?a.addresses[0]:null,[p,x]=s.useState(""),[f,j]=s.useState([]),[N,y]=s.useState(!1),[b,E]=s.useState(!1),D=s.useRef(null),U=s.useRef(null);s.useEffect((()=>{const e=setTimeout((()=>{p&&(async e=>{if(!e||e.length<3)return j([]),void E(!1);y(!0);try{const s=await Z.searchAddress(e);j(s),E(s.length>0)}catch(s){console.error("Erreur lors de la recherche d'adresses:",s),g.error("Erreur lors de la recherche d'adresses")}finally{y(!1)}})(p)}),300);return()=>clearTimeout(e)}),[p]),s.useEffect((()=>{const e=e=>{D.current&&!D.current.contains(e.target)&&U.current&&!U.current.contains(e.target)&&E(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}}),[]);return e.jsxs("div",{className:`\n      rounded-lg transition-all duration-200 \n      ${u?"bg-white border-2 border-blue-200 shadow-sm":"bg-gray-50"} \n      ${u?"":"hover:bg-gray-100"} \n      p-4 sm:p-5\n    `,children:[e.jsxs(Y,{className:"text-sm font-medium text-gray-700 flex items-center justify-between",children:[e.jsx("span",{children:"Adresse"}),n&&!u&&e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{t((e=>({...e,[c]:!e[c]})))},className:"text-blue-600 hover:text-blue-700 hover:bg-blue-50 transition-colors",children:e.jsx(q,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-2",children:u?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"address-search",children:"Rechercher une adresse"}),e.jsxs("div",{className:"relative",children:[e.jsx(B,{id:"address-search",ref:U,value:p,onChange:e=>x(e.target.value),onFocus:()=>{p.length>=3&&f.length>0&&E(!0)},placeholder:"Commencez à taper une adresse...",className:"pr-10"}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:N?e.jsx(T,{className:"h-4 w-4 text-gray-400 animate-spin"}):e.jsx(v,{className:"h-4 w-4 text-gray-400"})}),b&&e.jsx("div",{ref:D,className:"absolute z-50 left-0 right-0 mt-1 bg-white shadow-lg rounded-md border border-gray-200 max-h-60 overflow-auto",children:e.jsx("ul",{className:"py-1",children:f.map(((s,a)=>e.jsx("li",{className:"px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>(e=>{i((s=>({...s,address:{name:e.houseNumber?`${e.houseNumber} ${e.street}`:e.street,complement:"",postalCode:{code:e.postcode},city:{name:e.city}}}))),x(""),j([]),E(!1)})(s),children:s.label},a)))})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"address-line",children:"Ligne d'adresse *"}),e.jsx(B,{id:"address-line",value:r.address?.name||"",onChange:e=>i((s=>({...s,address:{...s.address,name:e.target.value}}))),placeholder:"Ligne d'adresse",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"address-complement",children:"Complément"}),e.jsx(B,{id:"address-complement",value:r.address?.complement||"",onChange:e=>i((s=>({...s,address:{...s.address,complement:e.target.value}}))),placeholder:"Complément d'adresse"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"address-postal",children:"Code postal *"}),e.jsx(B,{id:"address-postal",value:r.address?.postalCode?.code||"",onChange:e=>i((s=>({...s,address:{...s.address,postalCode:{code:e.target.value}}}))),placeholder:"Code postal",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"address-city",children:"Ville *"}),e.jsx(B,{id:"address-city",value:r.address?.city?.name||"",onChange:e=>i((s=>({...s,address:{...s.address,city:{name:e.target.value}}}))),placeholder:"Ville",required:!0})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(d,{onClick:async()=>{if(r.address?.name&&r.address?.postalCode?.code&&r.address?.city?.name)try{await o(),t((e=>({...e,[c]:!1}))),x(""),j([]),E(!1)}catch(e){g.error("Une erreur est survenue lors de l'enregistrement de l'adresse"),console.error("Erreur lors de l'enregistrement de l'adresse:",e)}else g.error("Veuillez remplir tous les champs obligatoires")},size:"sm",className:"bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 min-w-[100px]",children:"Enregistrer"}),e.jsx(d,{onClick:m,variant:"ghost",size:"sm",className:"text-gray-600 hover:text-gray-800 hover:bg-gray-100",children:"Annuler"})]})]}):e.jsxs("div",{className:"flex items-center min-w-0",children:[e.jsx(w,{className:"h-4 w-4 mr-2 text-blue-500 flex-shrink-0"}),e.jsx("span",{className:"text-sm truncate flex-1 text-gray-900",children:h?ie(h):e.jsx("span",{className:"text-gray-500 italic",children:"Aucune adresse renseignée"})})]})})]})},me=({userData:s,editedData:a,editMode:r,setEditedData:l,isFieldEditable:t,toggleFieldEdit:i,handleCancelField:o,handleInputChange:n,onSave:d,onSaveAddress:m,setEditMode:c})=>e.jsxs("div",{className:"space-y-5 sm:space-y-6",children:[e.jsx("div",{className:"w-full",children:t("email")?e.jsx(V,{field:"email",label:"Email",icon:e.jsx(y,{className:"h-4 w-4 mr-2 text-gray-500"}),value:s.email,editedValue:a.personal.email,type:"email",isEditing:r.email,isEditable:!0,onEdit:()=>i("email"),onSave:d,onCancel:()=>o("email"),onChange:e=>n("email",e)}):e.jsx(oe,{label:"Email",icon:e.jsx(y,{className:"h-4 w-4 mr-2 text-gray-500"}),value:s.email||"Non renseigné"})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-5 sm:gap-6",children:[e.jsx("div",{className:"w-full",children:t("phoneNumber")?e.jsx(V,{field:"phoneNumber",label:"Téléphone",icon:e.jsx(ee,{className:"h-4 w-4 mr-2 text-gray-500"}),value:s.phoneNumber,editedValue:a.personal.phoneNumber,type:"phone",isEditing:r.phoneNumber,isEditable:!0,onEdit:()=>i("phoneNumber"),onSave:d,onCancel:()=>o("phoneNumber"),onChange:e=>n("phoneNumber",e)}):e.jsx(oe,{label:"Téléphone",icon:e.jsx(ee,{className:"h-4 w-4 mr-2 text-gray-500"}),value:s.phoneNumber||"Non renseigné"})}),e.jsx("div",{className:"w-full",children:t("address")?e.jsx(de,{userData:s,editedData:a,editMode:r,setEditMode:c,setEditedData:l,onSaveAddress:m,isAdmin:!0,handleCancelAddress:()=>{const e=s.addresses&&s.addresses.length>0?s.addresses[0]:null;l((s=>({...s,address:e?{name:e.name||"",complement:e.complement||"",postalCode:{code:e.postalCode?.code||""},city:{name:e.city?.name||""}}:{name:"",complement:"",postalCode:{code:""},city:{name:""}}}))),c((e=>({...e,address:!1})))}}):e.jsx(oe,{label:"Adresse",icon:e.jsx(w,{className:"h-4 w-4 mr-2 text-blue-500 flex-shrink-0"}),value:s.addresses&&Array.isArray(s.addresses)&&s.addresses.length>0?ie(s.addresses[0]):"Aucune adresse renseignée"})})]})]}),ce=({userData:r,studentProfile:l,editedData:t,editMode:i,isStudent:o,isAdmin:n,toggleFieldEdit:d,handleCancelField:m,handleInputChange:c,onSave:u})=>{const[h,p]=a.useState(!1),[x,f]=a.useState(""),j=s.useMemo((()=>l?.portfolioUrl||""),[l?.portfolioUrl]);s.useEffect((()=>{f(j)}),[j]),s.useEffect((()=>{const e=e=>{void 0!==e.detail?.portfolioUrl&&(console.log("Mise à jour du portfolio détectée:",e.detail.portfolioUrl),f(e.detail.portfolioUrl))};return window.addEventListener("portfolio-updated",e),()=>{window.removeEventListener("portfolio-updated",e)}}),[]);return s.useEffect((()=>{console.log("ProfessionalInfoSection - studentProfile?.portfolioUrl:",l?.portfolioUrl),console.log("ProfessionalInfoSection - localPortfolioUrl:",x),console.log("ProfessionalInfoSection - editedData.personal.portfolioUrl:",t.personal.portfolioUrl)}),[l?.portfolioUrl,x,t.personal.portfolioUrl]),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-5 sm:gap-6",children:[e.jsx(oe,{label:"Domaine",icon:e.jsx(b,{className:"h-4 w-4 mr-2 text-blue-500"}),value:r.specialization?.domain?.name||"Non renseigné"}),e.jsx(oe,{label:"Spécialisation",icon:e.jsx(E,{className:"h-4 w-4 mr-2 text-blue-500"}),value:r.specialization?.name||"Non renseignée"}),e.jsx(V,{field:"linkedinUrl",label:"LinkedIn",icon:e.jsx(D,{className:"h-4 w-4"}),value:r.linkedinUrl,editedValue:t.personal.linkedinUrl,type:"url",isEditing:i.linkedinUrl,isEditable:!0,onEdit:()=>d("linkedinUrl"),onSave:()=>u("linkedinUrl",t.personal.linkedinUrl),onCancel:()=>m("linkedinUrl"),onChange:e=>c("linkedinUrl",e)}),o?e.jsx(V,{field:"portfolioUrl",label:"Portfolio",icon:e.jsx(se,{className:"h-4 w-4"}),value:x,editedValue:t.personal.portfolioUrl,type:"url",isEditing:i.portfolioUrl,isEditable:!0,onEdit:()=>{c("portfolioUrl",x),d("portfolioUrl")},onSave:()=>(async e=>{try{if(p(!0),e&&!e.startsWith("https://"))return g.error("L'URL du portfolio doit commencer par https://"),void p(!1);f(e),c("portfolioUrl",e);const s=await U.updatePortfolioUrl(e);s&&s.success?(u("portfolioUrl",e),C(e),g.success("Portfolio mis à jour avec succès"),l&&(l.portfolioUrl=e)):(f(j),g.error("Une erreur est survenue lors de la mise à jour du portfolio"))}catch(s){f(j),console.error("Erreur lors de la mise à jour du portfolio:",s),g.error(s.message||"Une erreur est survenue lors de la mise à jour du portfolio")}finally{p(!1)}})(t.personal.portfolioUrl),onCancel:()=>{m("portfolioUrl"),f(j)},onChange:e=>c("portfolioUrl",e),loading:h}):e.jsx(oe,{label:"Portfolio",icon:e.jsx(se,{className:"h-4 w-4 mr-2 text-blue-500"}),value:x||"Non renseigné"}),o&&e.jsx(oe,{label:"Situation actuelle",icon:e.jsx(b,{className:"h-4 w-4 mr-2 text-blue-500"}),value:l?.situationType?.name||"Non renseignée"})]})},ue=({userData:a,editMode:r,setEditMode:l,editedData:t,setEditedData:i,userRole:n,onSave:d,onSaveAddress:m,onUploadIdentity:c,isLoading:u=!1})=>{if(u)return e.jsx(le,{});const{isStudent:h,isAdmin:p,studentProfile:x,isFieldEditable:f,handleInputChange:j,toggleFieldEdit:N,handleCancelField:v}=(({userData:e,userRole:a,editMode:r,setEditMode:l,editedData:t,setEditedData:i})=>{const o="ROLE_STUDENT"===a,n="ROLE_SUPER_ADMIN"===a||"SUPER_ADMIN"===a||"SUPERADMIN"===a,d=s.useCallback((()=>["ROLE_ADMIN","ROLE_SUPER_ADMIN","ADMIN","SUPER_ADMIN","SUPERADMIN"].includes(a)),[a])(),m=e?.studentProfile||{},c=s.useCallback((e=>{if(n)return!0;if(d)return!0;if("address"===e)return Q(a);const s=["phoneNumber","linkedinUrl"];return o&&s.push("portfolioUrl"),s.includes(e)}),[d,o,a,n]),u=e=>{if(!e)return!0;try{const s=new Date(e);if(isNaN(s.getTime()))return!1;const a=new Date,r=new Date(a);return r.setFullYear(a.getFullYear()-16),s<=r}catch(s){return!1}};return{isStudent:o,isAdmin:d,isSuperAdmin:n,studentProfile:m,isFieldEditable:c,handleInputChange:(e,s)=>{"birthDate"!==e||u(s)?i((a=>({...a,personal:{...a.personal,[e]:s}}))):g.error("Vous devez avoir au moins 16 ans pour vous inscrire.")},toggleFieldEdit:e=>{l((s=>({...s,[e]:!s[e]})))},handleCancelField:s=>{i((a=>({...a,personal:{...a.personal,[s]:"portfolioUrl"===s?m?.portfolioUrl??"":e[s]??""}}))),l((e=>({...e,[s]:!1})))},handleCancelAddress:()=>{const s=e.addresses&&e.addresses.length>0?e.addresses[0]:null;i((e=>({...e,address:s?{name:s.name||"",complement:s.complement||"",postalCode:{code:s.postalCode?.code||""},city:{name:s.city?.name||""}}:{name:"",complement:"",postalCode:{code:""},city:{name:""}}}))),l((e=>({...e,address:!1})))},validateMinimumAge:u}})({userData:a,userRole:n,editMode:r,setEditMode:l,editedData:t,setEditedData:i});return s.useEffect((()=>{if(a){const e={firstName:a.firstName??"",lastName:a.lastName??"",email:a.email??"",phoneNumber:a.phoneNumber??"",linkedinUrl:a.linkedinUrl??"",portfolioUrl:x?.portfolioUrl??""},s=a.addresses&&a.addresses.length>0?a.addresses[0]:null;r.address?i((s=>({...s,personal:e}))):i((a=>({...a,personal:e,address:s?{name:s.name||"",complement:s.complement||"",postalCode:{code:s.postalCode?.code||""},city:{name:s.city?.name||""}}:{name:"",complement:"",postalCode:{code:""},city:{name:""}}})))}}),[a?.id,x?.portfolioUrl]),s.useEffect((()=>{const e=e=>{const s=e.detail?.portfolioUrl;void 0!==s&&(console.log("Mise à jour du portfolio détectée:",s),i((e=>({...e,personal:{...e.personal,portfolioUrl:s}}))),x&&(x.portfolioUrl=s))};return window.addEventListener("portfolio-updated",e),()=>{window.removeEventListener("portfolio-updated",e)}}),[x,i]),e.jsxs("div",{className:"space-y-6 sm:space-y-8 w-full px-1 sm:px-2 md:px-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold flex items-center mb-3 sm:mb-5",children:[e.jsx(o,{className:"h-4 w-4 sm:h-5 sm:w-5 mr-1.5 sm:mr-2 text-blue-600"}),"Informations personnelles"]}),e.jsx(ne,{userData:a,editedData:t,editMode:r,isFieldEditable:f,toggleFieldEdit:N,handleCancelField:v,handleInputChange:j,onSave:d})]}),e.jsx(H,{className:"my-6 sm:my-8"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold flex items-center mb-3 sm:mb-5",children:[e.jsx(ee,{className:"h-4 w-4 sm:h-5 sm:w-5 mr-1.5 sm:mr-2 text-blue-600"}),"Coordonnées"]}),e.jsx(me,{userData:a,editedData:t,editMode:r,setEditedData:i,isFieldEditable:f,toggleFieldEdit:N,handleCancelField:v,handleInputChange:j,onSave:d,onSaveAddress:m,setEditMode:l})]}),e.jsx(H,{className:"my-6 sm:my-8"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold flex items-center mb-3 sm:mb-5",children:[e.jsx(b,{className:"h-4 w-4 sm:h-5 sm:w-5 mr-1.5 sm:mr-2 text-blue-600"}),"Ma carrière"]}),e.jsx(ce,{userData:a,studentProfile:x,editedData:t,editMode:r,isStudent:h,isAdmin:p,toggleFieldEdit:N,handleCancelField:v,handleInputChange:j,onSave:d})]})]})},he=()=>{const r=I(),[l,t]=s.useState({personal:!1,address:!1,academic:!1}),[i,o]=s.useState({personal:{firstName:"",lastName:"",email:"",phoneNumber:"",linkedinUrl:"",portfolioUrl:"",nationality:"",birthDate:""},address:{},academic:{}}),{user:n,isLoading:m,isError:c,error:u,forceRefresh:h}=P({refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:3e5,onError:e=>{g.error("Failed to load profile data: "+(e.message||"Unknown error"))}}),p=a.useMemo((()=>n?{data:{user:n,addresses:n.addresses||[],studentProfile:n.studentProfile||null}}:null),[n]),{userRole:x,isStudent:f}=a.useMemo((()=>{const e=n?.roles||[],s=Array.isArray(e)?e:"object"==typeof e?Object.values(e):[],a=s.some((e=>"string"==typeof e&&e.includes("STUDENT")))||n?.studentProfile&&Object.keys(n?.studentProfile||{}).length>0;let r="";if(a)r="ROLE_STUDENT";else if(s.length>0){const e=s[0];r="object"==typeof e&&null!==e&&e.name?e.name:String(e)}return{userRole:r,isStudent:a}}),[n?.roles,n?.studentProfile]);s.useEffect((()=>{if(n&&Object.keys(n).length>0){const e={firstName:n.firstName??"",lastName:n.lastName??"",email:n.email??"",phoneNumber:n.phoneNumber??"",linkedinUrl:n.linkedinUrl??"",portfolioUrl:n.studentProfile?.portfolioUrl??"",nationality:n.nationality??"",birthDate:n.birthDate??""};JSON.stringify(e)!==JSON.stringify(i.personal)&&o((s=>({...s,personal:e,address:{},academic:{}})))}}),[p]),s.useEffect((()=>{const e=e=>{if(void 0!==e.detail?.portfolioUrl){const s=e.detail.portfolioUrl;i.personal.portfolioUrl!==s&&o((e=>({...e,personal:{...e.personal,portfolioUrl:s}})))}};return window.addEventListener("portfolio-url-updated",e),()=>{window.removeEventListener("portfolio-url-updated",e)}}),[i.personal.portfolioUrl]);const j=s.useCallback(((e,s)=>{"portfolioUrl"===e?(o((e=>({...e,personal:{...e.personal,portfolioUrl:s}}))),n&&n.studentProfile&&(n.studentProfile={...n.studentProfile,portfolioUrl:s},window.dispatchEvent(new CustomEvent("portfolio-update-local",{detail:{portfolioUrl:s}})))):(o((a=>({...a,personal:{...a.personal,[e]:s}}))),n&&(n[e]=s,"birthDate"===e&&s&&(n.age=(e=>{if(!e)return null;try{const s=new Date(e);if(isNaN(s.getTime()))return null;const a=new Date,r=a.getFullYear()-s.getFullYear();return a.getMonth()>s.getMonth()||a.getMonth()===s.getMonth()&&a.getDate()>=s.getDate()?r:r-1}catch(s){return null}})(s))))}),[n]),N=async e=>{try{const s=i.personal[e];if("birthDate"===e&&s){const e=new Date(s),a=new Date,r=new Date(a);if(r.setFullYear(a.getFullYear()-16),e>r)return void g.error("Vous devez avoir au moins 16 ans pour vous inscrire.")}if("email"===e&&s&&!_(s))return void g.error("Format d'email invalide");if("phoneNumber"===e&&s&&!K(s))return void g.error("Format de numéro de téléphone invalide");if(("firstName"===e||"lastName"===e)&&s&&!G(s))return void g.error(`Format de ${"firstName"===e?"prénom":"nom"} invalide. Utilisez uniquement des lettres, espaces, tirets et apostrophes.`);if("linkedinUrl"===e&&s&&!J(s))return void g.error("L'URL LinkedIn doit commencer par 'https://www.linkedin.com/in/'");if("portfolioUrl"===e&&s&&!W(s))return void g.error("L'URL du portfolio doit commencer par 'https://'");await R.updateProfile({[e]:s}),j(e,s),t((s=>({...s,[e]:!1}))),document.dispatchEvent(new CustomEvent("user:data-updated")),g.success(`${e} mis à jour avec succès`)}catch(s){"portfolioUrl"===e&&f?(j("portfolioUrl",p?.data?.studentProfile?.portfolioUrl||null),g.error("Erreur lors de la mise à jour de l'URL du portfolio")):(j(e,p?.data?.user?.[e]||null),g.error(`Erreur lors de la mise à jour de ${e}`))}},{mutate:v}=S("/api/profile","put","userProfileData",{onMutate:async e=>{await r.cancelQueries({queryKey:["userProfileData"]});return{previousData:r.getQueryData(["userProfileData"])}},onSuccess:(e,s)=>{g.success("Informations mises à jour avec succès")},onError:(e,s,a)=>{r.setQueryData(["userProfileData"],a.previousData),g.error("Une erreur est survenue lors de la mise à jour du profil")},onSettled:()=>{r.invalidateQueries({queryKey:["userProfileData"]})}}),{mutate:w}=S("/api/student/profile/portfolio-url","put","userProfileData",{onMutate:async e=>{await r.cancelQueries({queryKey:["userProfileData"]});return{previousData:r.getQueryData(["userProfileData"])}},onSuccess:async(e,s)=>{g.success("URL du portfolio mise à jour avec succès"),await r.invalidateQueries({queryKey:["unified-user-data"]}),setTimeout((()=>h()),300),window.dispatchEvent(new CustomEvent("portfolio-url-updated",{detail:{portfolioUrl:s.portfolioUrl}}))},onError:(e,s,a)=>{r.setQueryData(["userProfileData"],a.previousData),g.error(e.response?.data?.message||"L'URL du portfolio doit commencer par 'https://'")},onSettled:()=>{r.invalidateQueries({queryKey:["userProfileData"]}),r.invalidateQueries({queryKey:["profile"]}),r.invalidateQueries({queryKey:["unified-user-data"]})}}),[y,b]=s.useState(null),[E,D]=s.useState(0),U=s.useCallback((e=>{console.log("UserProfileSettings - Profile picture change handler disabled to prevent infinite loops")}),[]);return m?e.jsx(pe,{}):c?e.jsx("div",{className:"space-y-6 bg-white p-6 rounded-lg shadow",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error Loading Profile"}),e.jsx("p",{className:"text-gray-600 mb-4",children:u?.response?.data?.message||u?.message||"An unexpected error occurred"}),e.jsx(d,{onClick:()=>h(),children:"Try Again"})]})}):e.jsxs("div",{className:"space-y-4 sm:space-y-6 w-full",children:[e.jsx(k,{className:"overflow-hidden w-full",children:e.jsx("div",{className:"flex flex-col xs:flex-row items-center p-2 xs:p-3",children:e.jsx(re,{userData:n,onProfilePictureChange:U,isLoading:m})})}),e.jsxs(k,{className:"overflow-hidden w-full",children:[e.jsxs(M,{className:"px-4 sm:px-6 md:px-8 py-3 sm:py-4",children:[e.jsx(F,{className:"text-lg sm:text-xl",children:"Informations personnelles"}),e.jsx(L,{className:"text-xs sm:text-sm",children:"Mettre à jour vos informations personnelles"})]}),e.jsx(A,{className:"px-3 sm:px-4 md:px-6 pb-6",children:e.jsx(ue,{userData:n,editMode:l,setEditMode:t,editedData:i,setEditedData:o,userRole:x,onSave:N,onSaveAddress:async()=>{try{const e=i.address,s={name:e.name?.trim()||"",complement:e.complement?.trim()||null,postalCode:{code:e.postalCode?.code?.trim()||""},city:{name:e.city?.name?.trim()||""}};if(!s.name||!s.postalCode.code||!s.city.name)return void g.error("Veuillez remplir tous les champs obligatoires");n.addresses;await R.updateAddress(s),g.success("Adresse mise à jour avec succès"),await r.invalidateQueries({queryKey:["userProfileData"]}),await h()}catch(e){console.error("Error saving address:",e),g.error("Erreur lors de la mise à jour de l'adresse")}},children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nationality",children:"Nationalité"}),e.jsx(B,{id:"nationality",value:i.personal.nationality||"",onChange:e=>N("nationality"),disabled:!l.personal,placeholder:"Votre nationalité"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"birthDate",children:"Date de naissance"}),e.jsx(B,{id:"birthDate",type:"date",value:i.personal.birthDate||"",onChange:e=>N("birthDate"),disabled:!l.personal})]})]})})})]})]})},pe=()=>e.jsxs("div",{className:"space-y-4 sm:space-y-6 w-full",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden w-full",children:[e.jsxs("div",{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b",children:[e.jsx(f,{className:"h-5 sm:h-6 w-36 sm:w-48 mb-2"}),e.jsx(f,{className:"h-3 sm:h-4 w-48 sm:w-64"})]}),e.jsxs("div",{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-6",children:[e.jsxs("div",{className:"flex flex-col xs:flex-row items-center justify-center",children:[e.jsxs("div",{className:"relative",children:[e.jsx(f,{className:"h-20 w-20 sm:h-24 sm:w-24 md:h-32 md:w-32 rounded-full"}),e.jsx(f,{className:"absolute bottom-0 right-0 w-6 sm:w-8 h-6 sm:h-8 rounded-full"})]}),e.jsxs("div",{className:"mt-3 xs:mt-0 xs:ml-3",children:[e.jsx(f,{className:"h-4 sm:h-5 w-32 mb-2"}),e.jsx(f,{className:"h-3 w-40"})]})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(f,{className:"h-8 sm:h-9 w-24 sm:w-28"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden w-full",children:[e.jsxs("div",{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b",children:[e.jsx(f,{className:"h-5 sm:h-6 w-48 sm:w-64 mb-2"}),e.jsx(f,{className:"h-3 sm:h-4 w-56 sm:w-80"})]}),e.jsx("div",{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-6",children:e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 sm:h-5 w-24 sm:w-32"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 sm:h-5 w-24 sm:w-32"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 sm:h-5 w-24 sm:w-32"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 sm:h-5 w-24 sm:w-32"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 sm:h-5 w-24 sm:w-32"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]}),e.jsxs("div",{className:"pt-3 sm:pt-4",children:[e.jsx(f,{className:"h-5 sm:h-6 w-24 sm:w-32 mb-3 sm:mb-4"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[e.jsx(f,{className:"h-9 sm:h-10 w-full"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]})]}),e.jsx("div",{className:"flex justify-end mt-4 sm:mt-6",children:e.jsx(f,{className:"h-9 sm:h-10 w-32 sm:w-48"})})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden w-full",children:[e.jsxs("div",{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b",children:[e.jsx(f,{className:"h-5 sm:h-6 w-36 sm:w-48 mb-2"}),e.jsx(f,{className:"h-3 sm:h-4 w-48 sm:w-64"})]}),e.jsx("div",{className:"px-4 sm:px-6 md:px-8 py-4 sm:py-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[e.jsx(f,{className:"h-9 sm:h-10 w-full"}),e.jsx(f,{className:"h-9 sm:h-10 w-full"})]})})]})]}),xe=()=>e.jsxs("div",{className:"w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Mon compte"}),e.jsx(he,{})]});export{xe as default};
