import{j as e}from"./ui-CEgDFHEN.js";import{r as s}from"./router-Cgxi-4fo.js";import{z as r,m as a,B as t,a3 as n,q as i,r as l,s as d,v as o,w as c,o as g,j as m,ax as u,aw as x,b as h,t as j}from"./index-BnANEtVp.js";import{T as p,a as b,b as y,c as f,d as N,e as w}from"./table-DS2AyS3B.js";import{T as k,a as v,b as D,c as T}from"./tooltip-D-CkI6pU.js";import"./progress-_P7boFqI.js";import{A as S,a as H,b as A}from"./alert-DMCK1Qkn.js";import{L as E}from"./loader-circle-tYz9PP6p.js";import{C as M}from"./circle-alert-MkLjJhtw.js";import{C as P}from"./circle-check-big-C_3AL0uz.js";
/**
 * @license lucide-react v0.476.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=r("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),I={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.05,delayChildren:.1}}},B={hidden:{y:10,opacity:0},visible:{y:0,opacity:1,transition:{type:"spring",stiffness:300,damping:25}}},C=()=>{const[r,C]=s.useState(!0),[_,q]=s.useState(null),[L,z]=s.useState(null),[F,R]=s.useState(!1),J=async()=>{try{F?R(!0):C(!0),z(null),await h.ensureUserDataInLocalStorage();const s=localStorage.getItem("token");if(!s)throw new Error("Token d'authentification non trouvé");let r=!1,a=null;try{const e=await fetch("/api/signatures/weekly",{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(!e.ok){const s=await e.json().catch((()=>({})));throw console.error("API error response:",s),new Error(s.message||`Erreur ${e.status}`)}a=await e.json(),r=!0,a&&a.signaturesByDate&&(a.signaturesByDate=a.signaturesByDate.filter((e=>!["Saturday","Sunday"].includes(e.dayName)))),console.log("Weekly signature history from API:",a)}catch(e){console.error("API request failed:",e)}if(r&&a)q(a);else{console.log("Fallback: Using local signature data");const e=new Date,s=e.getDay(),r=0===s?-6:1-s,a=new Date(e);a.setDate(e.getDate()+r);const t=[];for(let l=0;l<5;l++){const e=new Date(a);e.setDate(a.getDate()+l),t.push(e)}const n=t.map((e=>e.toISOString().split("T")[0])),i={success:!0,weekStart:n[0],weekEnd:new Date(t[4]).setDate(t[4].getDate()+1),availablePeriods:{morning:"Matin (9h-12h)",afternoon:"Après-midi (13h-17h)"},signaturesByDate:[]};n.forEach(((e,s)=>{const r=`signature_${e}_morning`,a=`signature_${e}_afternoon`,n=`signature_data_${e}_morning`,l=`signature_data_${e}_afternoon`,d="true"===localStorage.getItem(r),o="true"===localStorage.getItem(a);let c=null,g=null;if(d){const s=localStorage.getItem(n);if(s)try{c=JSON.parse(s)}catch(u){console.error("Error parsing morning signature data:",u)}c||(c={date:`${e}T09:30:00.000Z`})}if(o){const s=localStorage.getItem(l);if(s)try{g=JSON.parse(s)}catch(u){console.error("Error parsing afternoon signature data:",u)}g||(g={date:`${e}T14:30:00.000Z`})}const m=t[s];i.signaturesByDate.push({date:e,dayName:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][m.getDay()],signatures:{morning:d?c:null,afternoon:o?g:null}})})),console.log("Generated local weekly data:",i),q(i)}}catch(s){console.error("Error fetching weekly history:",s),z(s.message||"Erreur de chargement de l'historique"),j.error("Erreur",{description:s.message||"Impossible de charger l'historique des signatures"})}finally{C(!1),R(!1)}};s.useEffect((()=>{J()}),[]);if(r&&!F)return e.jsxs(a.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 space-y-4",children:[e.jsx(E,{className:"h-10 w-10 animate-spin text-primary"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Chargement de l'historique des signatures..."})]});if(L)return e.jsx(a.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(S,{variant:"destructive",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx(H,{children:"Erreur"}),e.jsxs(A,{children:[L,e.jsxs(t,{className:"mt-4",variant:"outline",onClick:J,size:"sm",children:[e.jsx(n,{className:"h-4 w-4 mr-2"}),"Réessayer"]})]})]})});if(!_)return e.jsx(a.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(i,{children:[e.jsxs(l,{children:[e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5 text-muted-foreground"}),"Aucune donnée"]}),e.jsx(o,{children:"Aucun historique de signatures n'est disponible"})]}),e.jsx(c,{children:e.jsxs(t,{variant:"outline",onClick:J,size:"sm",className:"w-full",children:[e.jsx(n,{className:"h-4 w-4 mr-2"}),"Actualiser les données"]})})]})});const O=(()=>{if(!_?.signaturesByDate)return{total:0,present:0};let e=0,s=0;const r=new Date;r.setHours(0,0,0,0);const a=(new Date).getHours();return _.signaturesByDate.forEach((t=>{const n=new Date(t.date);n.setHours(0,0,0,0);const i=n>r,l=!(n.getTime()===r.getTime()&&a<12),d=!(n.getTime()===r.getTime()&&a<17);i||(l&&(e+=1,t.signatures&&t.signatures.morning&&(s+=1,console.log(`Présence du matin comptée pour ${t.date}`))),d&&(e+=1,t.signatures&&t.signatures.afternoon&&(s+=1,console.log(`Présence de l'après-midi comptée pour ${t.date}`))))})),console.log(`Résumé de la semaine - Total: ${e}, Présent: ${s}`),{total:e,present:s,percentage:e>0?Math.round(s/e*100):0}})();return e.jsxs(a.div,{className:"space-y-6",variants:I,initial:"hidden",animate:"visible",children:[e.jsx(a.div,{variants:B,children:e.jsxs(i,{className:"overflow-hidden border-blue-100 dark:border-blue-900/50",children:[e.jsx(l,{className:"bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-900/30 border-b border-blue-100 dark:border-blue-900/10",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(d,{className:"text-blue-800 dark:text-blue-400 flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"Résumé de la semaine"]})})}),e.jsx(c,{className:"pt-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-4",children:[e.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-800/30 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(P,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium",children:"Présent"})]}),e.jsx("span",{className:"text-2xl font-bold text-green-600",children:O.present}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-1",children:"périodes"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-800/30 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(g,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium",children:"Absent"})]}),e.jsx("span",{className:"text-2xl font-bold text-red-600",children:O.total-O.present}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-1",children:"périodes"})]})]})})]})}),e.jsx(a.div,{variants:B,children:e.jsxs(i,{children:[e.jsxs(l,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(m,{className:"h-5 w-5 text-primary"}),"Détail des signatures"]}),e.jsxs(t,{variant:"outline",size:"sm",onClick:()=>{R(!0),J()},disabled:F,className:"gap-1",children:[F?e.jsx(E,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(n,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Actualiser"})]})]}),e.jsx(o,{children:"Historique détaillé des signatures pour la semaine en cours"})]}),e.jsx(c,{className:"p-0",children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(p,{children:[e.jsx(b,{children:e.jsxs(y,{children:[e.jsx(f,{className:"w-[100px]",children:"Jour"}),e.jsx(f,{children:"Date"}),e.jsx(f,{className:"text-center",children:"Matin (9h-12h)"}),e.jsx(f,{className:"text-center",children:"Après-midi (13h-17h)"})]})}),e.jsx(N,{children:_.signaturesByDate.map((s=>{return e.jsxs(y,{children:[e.jsx(w,{className:"font-medium",children:(r=s.dayName,{Monday:"Lundi",Tuesday:"Mardi",Wednesday:"Mercredi",Thursday:"Jeudi",Friday:"Vendredi"}[r]||r)}),e.jsx(w,{children:new Date(s.date).toLocaleDateString("fr-FR")}),e.jsx(w,{className:"text-center",children:e.jsx(k,{children:e.jsxs(v,{children:[e.jsx(D,{className:"cursor-help inline-flex",children:s.signatures.morning?e.jsxs(u,{variant:"outline",className:"bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800 gap-1",children:[e.jsx(P,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Présent"})]}):(()=>{const r=new Date;r.setHours(0,0,0,0);const a=new Date(s.date);a.setHours(0,0,0,0);return a>r||a.getTime()===r.getTime()&&(new Date).getHours()<12?e.jsxs(u,{variant:"outline",className:"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800 gap-1",children:[e.jsx(m,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"À venir"})]}):e.jsxs(u,{variant:"outline",className:"bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800 gap-1",children:[e.jsx(g,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Absent"})]})})()}),e.jsx(T,{side:"bottom",children:s.signatures.morning?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-4 w-4 text-green-600"}),e.jsxs("p",{children:["Signé à ",new Date(s.signatures.morning.date).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]})]}):(()=>{const r=new Date;r.setHours(0,0,0,0);const a=new Date(s.date);a.setHours(0,0,0,0);return a>r||a.getTime()===r.getTime()&&(new Date).getHours()<12?e.jsx("p",{children:"Période à venir"}):e.jsx("p",{children:"Aucune signature enregistrée"})})()})]})})}),e.jsx(w,{className:"text-center",children:e.jsx(k,{children:e.jsxs(v,{children:[e.jsx(D,{className:"cursor-help inline-flex",children:s.signatures.afternoon?e.jsxs(u,{variant:"outline",className:"bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800 gap-1",children:[e.jsx(P,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Présent"})]}):(()=>{const r=new Date;r.setHours(0,0,0,0);const a=new Date(s.date);a.setHours(0,0,0,0);return a>r||a.getTime()===r.getTime()&&(new Date).getHours()<17?e.jsxs(u,{variant:"outline",className:"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800 gap-1",children:[e.jsx(m,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"À venir"})]}):e.jsxs(u,{variant:"outline",className:"bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800 gap-1",children:[e.jsx(g,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Absent"})]})})()}),e.jsx(T,{side:"bottom",children:s.signatures.afternoon?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-4 w-4 text-green-600"}),e.jsxs("p",{children:["Signé à ",new Date(s.signatures.afternoon.date).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]})]}):(()=>{const r=new Date;r.setHours(0,0,0,0);const a=new Date(s.date);a.setHours(0,0,0,0);return a>r||a.getTime()===r.getTime()&&(new Date).getHours()<17?e.jsx("p",{children:"Période à venir"}):e.jsx("p",{children:"Aucune signature enregistrée"})})()})]})})})]},s.date);var r}))})]})})})]})})]})};export{C as S};
