import{j as e}from"./ui-CEgDFHEN.js";import{r as s}from"./router-Cgxi-4fo.js";import{aC as a,aD as t,aE as r,j as n,aG as i,q as l,r as d,s as o,v as c,w as m,ac as h,ax as u,B as x,t as g,aH as j}from"./index-BnANEtVp.js";import{T as p,a as f,b as N,c as v,d as b,e as y}from"./table-DS2AyS3B.js";import{L as w}from"./loader-circle-tYz9PP6p.js";import{C as S}from"./clipboard-check-BF9lqbed.js";import{f as M}from"./index-DLO_YBUS.js";import{C as k}from"./circle-check-big-C_3AL0uz.js";import"./react-0RZ2pslC.js";import"./query-CdiCT4_A.js";import"./charts-D4j3G6dB.js";const D=()=>{const[j,D]=s.useState([]),[E,$]=s.useState(!0),[C,A]=s.useState(null),[V,z]=s.useState("today"),[I,L]=s.useState([]),T=async()=>{try{$(!0);const e=localStorage.getItem("token");if(!e)throw new Error("Authentification requise");const s=await fetch("/api/signatures",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!s.ok)throw new Error("Failed to fetch signatures");const a=await s.json();D(a.signatures),A(null)}catch(e){console.error("Error fetching signatures:",e),A("Impossible de récupérer les signatures. Veuillez réessayer plus tard."),g.error("Erreur",{description:"Impossible de récupérer les signatures. Veuillez réessayer plus tard."})}finally{$(!1)}},F=()=>{const e=new Date,s=e.getDay(),a=0===s?-6:1-s,t=new Date(e);t.setDate(e.getDate()+a);const r=[],n=["Lundi","Mardi","Mercredi","Jeudi","Vendredi"],i=[{id:1,firstName:"Jean",lastName:"Dupont"},{id:2,firstName:"Marie",lastName:"Martin"},{id:3,firstName:"Lucas",lastName:"Bernard"},{id:4,firstName:"Emma",lastName:"Petit"},{id:5,firstName:"Louis",lastName:"Durand"},{id:6,firstName:"Léa",lastName:"Thomas"},{id:7,firstName:"Hugo",lastName:"Robert"},{id:8,firstName:"Chloé",lastName:"Richard"},{id:9,firstName:"Jules",lastName:"Moreau"},{id:10,firstName:"Jade",lastName:"Simon"}];for(let l=0;l<5;l++){const s=new Date(t);s.setDate(t.getDate()+l);const a=s.toISOString().split("T")[0],d=i.length,o=Math.floor(Math.random()*(d+1)),c=Math.floor(Math.random()*(d+1)),m=s<e,h=s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear(),u=e.getHours(),x=m||h&&u>=12,g=m||h&&u>=17,j=[],p=[];if(x){const e=[...i].sort((()=>.5-Math.random()));for(let s=0;s<o;s++)j.push({id:`m${a}${s}`,student:e[s],time:`${8+Math.floor(3*Math.random())}:${Math.floor(60*Math.random()).toString().padStart(2,"0")}`})}if(g){const e=[...i].sort((()=>.5-Math.random()));for(let s=0;s<c;s++)p.push({id:`a${a}${s}`,student:e[s],time:`${13+Math.floor(4*Math.random())}:${Math.floor(60*Math.random()).toString().padStart(2,"0")}`})}r.push({date:a,dayName:n[l],totalStudents:d,morning:{present:x?o:null,absent:x?d-o:null,percentage:x?Math.round(o/d*100):null,signatures:j},afternoon:{present:g?c:null,absent:g?d-c:null,percentage:g?Math.round(c/d*100):null,signatures:p}})}L(r)};s.useEffect((()=>{T(),(async()=>{try{$(!0);const e=localStorage.getItem("token");if(!e)throw new Error("Authentification requise");const s=await fetch("/api/signatures/statistics",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!s.ok)return void F();const a=await s.json();L(a.statistics),A(null)}catch(e){console.error("Error fetching weekly statistics:",e),F()}finally{$(!1)}})();const e=setInterval(T,6e4);return()=>{clearInterval(e)}}),[]);const q=({percentage:s})=>{if(null==s)return e.jsx("span",{children:"-"});let a="text-red-600";return s>=80?a="text-green-600":s>=60&&(a="text-amber-600"),e.jsxs("span",{className:`font-semibold ${a}`,children:[s,"%"]})};return!E||I.length||j.length?e.jsx("div",{className:"space-y-6",children:e.jsxs(a,{defaultValue:"today",value:V,onValueChange:z,className:"w-full",children:[e.jsxs(t,{className:"grid w-full grid-cols-2",children:[e.jsxs(r,{value:"today",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Signatures d'aujourd'hui"]}),e.jsxs(r,{value:"weekly",children:[e.jsx(n,{className:"h-4 w-4 mr-2"}),"Statistiques hebdomadaires"]})]}),e.jsx(i,{value:"today",className:"pt-4",children:e.jsxs(l,{children:[e.jsxs(d,{children:[e.jsxs(o,{className:"text-xl text-blue-700 dark:text-blue-400 flex items-center gap-2",children:[e.jsx(S,{className:"h-5 w-5"}),"Suivi des signatures d'aujourd'hui"]}),e.jsx(c,{children:"Validez les signatures des étudiants pour aujourd'hui"})]}),e.jsxs(m,{children:[C&&e.jsx("div",{className:"bg-red-50 text-red-700 p-4 rounded-md mb-4",children:C}),0===j.length?e.jsx("div",{className:"text-center py-12 border border-dashed border-gray-300 rounded-md",children:e.jsx("p",{className:"text-gray-500",children:"Aucune signature n'est disponible pour le moment."})}):e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsxs(p,{children:[e.jsx(f,{children:e.jsxs(N,{children:[e.jsx(v,{children:"Étudiant"}),e.jsx(v,{children:"Date"}),e.jsx(v,{children:"Statut"}),e.jsx(v,{children:"Actions"})]})}),e.jsx(b,{children:j.map((s=>e.jsxs(N,{children:[e.jsxs(y,{className:"font-medium",children:[s.user.firstName," ",s.user.lastName]}),e.jsx(y,{children:M(new Date(s.date),"PPP à HH:mm",{locale:h})}),e.jsx(y,{children:e.jsx(u,{variant:s.validated?"success":"pending",children:s.validated?"Validé":"En attente"})}),e.jsxs(y,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Localisation:"})," ",s.location]}),!s.validated&&e.jsx(x,{variant:"default",size:"sm",onClick:()=>(async e=>{try{if(!(await fetch(`/api/signatures/${e}/validate`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}})).ok)throw new Error("Failed to validate signature");D(j.map((s=>s.id===e?{...s,validated:!0}:s))),g.success("Signature validée",{description:"La signature a été validée avec succès."})}catch(s){console.error("Error validating signature:",s),g.error("Erreur",{description:"Impossible de valider la signature. Veuillez réessayer."})}})(s.id),className:"mt-2",children:"Valider"}),s.validated&&e.jsxs("span",{className:"text-green-600 flex items-center mt-2",children:[e.jsx(k,{className:"h-4 w-4 mr-1"})," Signature validée"]})]})]},s.id)))})]})})]})]})}),e.jsx(i,{value:"weekly",className:"pt-4",children:e.jsxs(l,{children:[e.jsxs(d,{children:[e.jsxs(o,{className:"text-xl text-blue-700 dark:text-blue-400 flex items-center gap-2",children:[e.jsx(n,{className:"h-5 w-5"}),"Statistiques de présence hebdomadaires"]}),e.jsx(c,{children:"Suivi des présences des étudiants pour la semaine en cours"})]}),e.jsx(m,{children:0===I.length?e.jsx("div",{className:"text-center py-12 border border-dashed border-gray-300 rounded-md",children:e.jsx("p",{className:"text-gray-500",children:"Aucune statistique n'est disponible pour le moment."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border rounded-md overflow-x-auto",children:e.jsxs(p,{children:[e.jsx(f,{children:e.jsxs(N,{children:[e.jsx(v,{children:"Jour"}),e.jsx(v,{children:"Date"}),e.jsx(v,{className:"text-center",children:"Matin"}),e.jsx(v,{className:"text-center",children:"Après-midi"}),e.jsx(v,{className:"text-right",children:"Actions"})]})}),e.jsx(b,{children:I.map((s=>{return e.jsxs(N,{children:[e.jsx(y,{className:"font-medium",children:s.dayName}),e.jsx(y,{children:(a=s.date,new Date(a).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}))}),e.jsx(y,{className:"text-center",children:null!==s.morning.present?e.jsxs(e.Fragment,{children:[e.jsx(q,{percentage:s.morning.percentage}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[s.morning.present,"/",s.totalStudents," présents"]})]}):e.jsx(u,{variant:"outline",children:"À venir"})}),e.jsx(y,{className:"text-center",children:null!==s.afternoon.present?e.jsxs(e.Fragment,{children:[e.jsx(q,{percentage:s.afternoon.percentage}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[s.afternoon.present,"/",s.totalStudents," présents"]})]}):e.jsx(u,{variant:"outline",children:"À venir"})}),e.jsx(y,{className:"text-right",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>{g.info("Fonctionnalité à venir",{description:"La liste détaillée sera disponible prochainement."})},children:"Détails"})})]},s.date);var a}))})]})}),e.jsxs(l,{className:"p-4 bg-slate-50 dark:bg-slate-900",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Évolution de la présence"}),e.jsx("div",{className:"h-40 flex items-end gap-2",children:I.map(((s,a)=>{const t=((null!==s.morning.percentage?s.morning.percentage:0)+(null!==s.afternoon.percentage?s.afternoon.percentage:0))/2;return e.jsxs("div",{className:"flex-1 flex flex-col items-center gap-1",children:[e.jsx("div",{className:"text-xs text-gray-500",children:t>0?`${Math.round(t)}%`:"-"}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-t-sm overflow-hidden relative",style:{height:`${Math.max(t,5)}%`},children:e.jsx("div",{className:"absolute bottom-0 w-full "+(t>=80?"bg-green-500 dark:bg-green-600":t>=60?"bg-amber-500 dark:bg-amber-600":"bg-red-500 dark:bg-red-600"),style:{height:"100%"}})}),e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:s.dayName.substring(0,3)})]},a)}))})]})]})})]})})]})}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px]",children:[e.jsx(w,{className:"w-8 h-8 animate-spin text-blue-600 mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Chargement des données de présence..."})]})},E=()=>e.jsxs("div",{className:"container mx-auto py-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Suivi des présences"}),e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsx(D,{})}),e.jsx(j,{})]});export{E as default};
