import{j as e}from"./ui-B9MhWaVJ.js";import{e as t,u as s,r}from"./router-D7BdrHDj.js";import{aX as a,t as o}from"./index-BMLMJrKU.js";import"./react-0RZ2pslC.js";import"./query-DKQ6_O-p.js";import"./charts-DkICKEBk.js";const i={Open:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300","In Progress":"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300",Resolved:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300",Closed:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",Pending:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"},d={Low:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",Normal:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300",High:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"};function c(){const{id:c}=t(),l=s(),[n,m]=r.useState(null),[u,x]=r.useState([]),[g,h]=r.useState(null),[b,p]=r.useState("Normal"),[k,y]=r.useState(!0),[f,j]=r.useState(null),[N,v]=r.useState(!1),[w,S]=r.useState(!1),[A,E]=r.useState(""),[I,C]=r.useState(!1);r.useEffect((()=>{(()=>{try{const e=localStorage.getItem("token");if(!e)return;const t=e.split(".");if(3!==t.length)return;const s=JSON.parse(atob(t[1]));console.log("User roles from token:",s.roles);const r=s.roles&&(s.roles.includes("ROLE_ADMIN")||s.roles.includes("ROLE_SUPER_ADMIN")||s.roles.includes("ROLE_SUPERADMIN"));console.log("Is admin check result:",r),v(r)}catch(e){console.error("Error checking admin role:",e)}})(),L();(async()=>{try{const e=await a.get("/tickets/status");console.log("Status response:",e.data),e.data&&e.data.statuses&&x(e.data.statuses)}catch(e){console.error("Error fetching statuses:",e)}})()}),[c]);const L=async()=>{try{y(!0),console.log(`Refreshing ticket data for ID: ${c}`);const s=localStorage.getItem("token");if(!s)return j("Authentication required"),void y(!1);console.log("About to request:",`/tickets/${c}`),console.log("Authorization header set:",!!s);try{const e=await a.get(`/tickets/${c}`);if(console.log("Refreshed ticket response:",e.data),!e.data||!e.data.ticket)throw new Error("Invalid ticket data received");m(e.data.ticket),h(e.data.ticket.status?.id||""),p(e.data.ticket.priority||"Normal"),y(!1)}catch(e){if(console.error("Error fetching specific ticket. Status:",e.response?.status),console.error("Error response:",e.response?.data),403===e.response?.status){console.log("Permission denied for direct access, trying to fetch from tickets list");try{const e=await a.get("/tickets");if(console.log("All tickets response:",e.data),e.data?.tickets?.length>0){const t=e.data.tickets.find((e=>e.id===parseInt(c)));if(t)return console.log("Found matching ticket in all tickets response:",t),m(t),h(t.status?.id||""),p(t.priority||"Normal"),void y(!1)}j("Vous n'avez pas accès à ce ticket."),y(!1)}catch(t){console.error("Error in fallback tickets fetch:",t),j("Vous n'avez pas accès à ce ticket."),y(!1)}}else j(e.response?.data?.message||"Failed to load ticket details"),y(!1)}}catch(e){console.error("Unexpected error refreshing ticket details:",e),j(e.message||"Failed to load ticket details"),y(!1)}};return k?e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):f||!n?e.jsxs("div",{className:"text-center p-6",children:[e.jsx("p",{className:"text-red-500 mb-4",children:f||"Ticket not found"}),e.jsx("button",{onClick:()=>l(N?"/admin/tickets":"/tickets"),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Retour aux tickets"})]}):e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("button",{onClick:()=>l(N?"/admin/tickets":"/tickets"),className:"text-blue-500 hover:text-blue-700 flex items-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Retour aux tickets"]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4 md:mb-0",children:["Ticket #",n.id,": ",n.title]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-3 py-1 text-sm font-semibold rounded-full ${i[n.status.name]}`,children:n.status.name}),e.jsx("span",{className:`px-3 py-1 text-sm font-semibold rounded-full ${d[n.priority]}`,children:n.priority||"Normal"})]})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Créé par"}),e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[n.creator.firstName," ",n.creator.lastName]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Créé le"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:new Date(n.createdAt).toLocaleString()})]}),n.assignedTo&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Assigné à"}),e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[n.assignedTo.firstName," ",n.assignedTo.lastName]})]}),n.updatedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Dernière mise à jour"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:new Date(n.updatedAt).toLocaleString()})]}),n.resolvedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Résolu le"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:new Date(n.resolvedAt).toLocaleString()})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Description"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded",children:e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:n.description})})]}),n.service&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Service concerné"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded",children:e.jsxs("p",{className:"text-gray-900 dark:text-white",children:[n.service.name,n.service.description&&e.jsxs("span",{className:"text-gray-600 dark:text-gray-400 ml-2",children:["- ",n.service.description]})]})})]}),e.jsxs("div",{className:"mb-6 border-t border-gray-200 dark:border-gray-700 pt-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Communications"}),e.jsx("div",{className:"space-y-4 mb-6",children:n.comments&&n.comments.length>0?n.comments.map((t=>e.jsxs("div",{className:"p-4 rounded-lg "+(t.isFromAdmin?"bg-blue-50 dark:bg-blue-900/30 ml-8":"bg-gray-50 dark:bg-gray-700 mr-8"),children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("p",{className:"font-medium text-sm",children:t.isFromAdmin?"Support":n.creator.firstName+" "+n.creator.lastName}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(t.createdAt).toLocaleString()})]}),e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:t.content})]},t.id))):e.jsx("div",{className:"text-center py-4 text-gray-500 dark:text-gray-400",children:"Aucune communication pour le moment"})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-md font-medium text-gray-900 dark:text-white mb-2",children:N?"Répondre au ticket":"Ajouter un commentaire"}),e.jsx("textarea",{value:A,onChange:e=>E(e.target.value),rows:4,className:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:N?"Votre réponse au ticket...":"Ajoutez des informations complémentaires..."}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx("button",{onClick:async()=>{if(A.trim()){C(!0);try{const e=await a.post(`/tickets/${c}/comments`,{content:A.trim(),isFromAdmin:N});m((t=>({...t,comments:[...t.comments||[],e.data.comment]}))),E(""),o.success("Commentaire ajouté avec succès")}catch(e){console.error("Error adding comment:",e),o.error(e.response?.data?.message||"Échec de l'ajout du commentaire")}finally{C(!1)}}},disabled:!A.trim()||I,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:I?"Envoi...":"Envoyer"})})]})]}),N&&e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Actions administrateur"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Mise à jour du statut"}),e.jsx("select",{id:"status",value:g,onChange:e=>h(Number(e.target.value)),className:"w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:u.map((t=>e.jsx("option",{value:t.id,children:t.name},t.id)))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"priority",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Mise à jour de la priorité"}),e.jsxs("select",{id:"priority",value:b,onChange:e=>p(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[e.jsx("option",{value:"Low",children:"Low"}),e.jsx("option",{value:"Normal",children:"Normal"}),e.jsx("option",{value:"High",children:"High"})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:async()=>{if(N&&(g!==n.status.id||b!==n.priority)){S(!0);try{console.log("Sending ticket update:",{statusId:g,priority:b,currentStatusId:n.status.id,currentStatusName:n.status.name});const e=await a.put(`/tickets/${c}`,{statusId:g,priority:b});console.log("Ticket update response:",e.data);const t=u.find((e=>e.id===g));console.log("Found status for update:",t);const s={...n,status:t||n.status,priority:b,updatedAt:(new Date).toISOString()};console.log("Updated ticket state:",s),m(s),o.success("Ticket mis à jour avec succès"),L()}catch(e){console.error("Error updating ticket:",e),o.error(e.response?.data?.message||"Échec de la mise à jour du ticket")}finally{S(!1)}}},disabled:w||g===n.status.id&&b===n.priority,className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed",children:w?"Mise à jour...":"Mettre à jour le ticket"})})]})]})]})})]})}export{c as default};
