import{j as e}from"./ui-B5ZVMT00.js";import{e as t,u as r,r as s}from"./router-Cgxi-4fo.js";import{bn as a,t as i}from"./index-B55PlCdI.js";import"./react-0RZ2pslC.js";import"./query-DUefEkVx.js";import"./charts-D4j3G6dB.js";const d={Open:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300","In Progress":"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300",Resolved:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300",Closed:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",Pending:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"},l={Low:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",Normal:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300",High:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"};function o(){const{id:o}=t(),c=r(),[n,m]=s.useState(null),[x,u]=s.useState([]),[g,h]=s.useState(null),[b,p]=s.useState("Normal"),[y,k]=s.useState(!0),[j,f]=s.useState(null),[N,v]=s.useState(!1),[w,S]=s.useState(!1),[A,C]=s.useState(""),[E,L]=s.useState(!1);s.useEffect((()=>{(()=>{try{const e=localStorage.getItem("token");if(!e)return;const t=e.split(".");if(3!==t.length)return;const r=JSON.parse(atob(t[1])),s=r.roles&&(r.roles.includes("ROLE_ADMIN")||r.roles.includes("ROLE_SUPER_ADMIN")||r.roles.includes("ROLE_SUPERADMIN"));v(s)}catch(e){console.error("Error checking admin role:",e)}})(),D();(async()=>{try{const e=await a.get("/tickets/status");e.data&&e.data.statuses&&u(e.data.statuses)}catch(e){console.error("Error fetching statuses:",e)}})()}),[o]);const D=async()=>{try{k(!0);if(!localStorage.getItem("token"))return f("Authentication required"),void k(!1);try{const e=await a.get(`/tickets/${o}`);if(!e.data||!e.data.ticket)throw new Error("Invalid ticket data received");m(e.data.ticket),h(e.data.ticket.status?.id||""),p(e.data.ticket.priority||"Normal"),k(!1)}catch(e){if(403===e.response?.status)try{const e=await a.get("/tickets");if(e.data?.tickets?.length>0){const t=e.data.tickets.find((e=>e.id===parseInt(o)));if(t)return m(t),h(t.status?.id||""),p(t.priority||"Normal"),void k(!1)}f("Vous n'avez pas accès à ce ticket."),k(!1)}catch(t){f("Vous n'avez pas accès à ce ticket."),k(!1)}else f(e.response?.data?.message||"Failed to load ticket details"),k(!1)}}catch(e){f(e.message||"Failed to load ticket details"),k(!1)}};return y?e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):j||!n?e.jsxs("div",{className:"text-center p-6",children:[e.jsx("p",{className:"text-red-500 mb-4",children:j||"Ticket not found"}),e.jsx("button",{onClick:()=>c(N?"/admin/tickets":"/tickets"),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Retour aux tickets"})]}):e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("button",{onClick:()=>c(N?"/admin/tickets":"/tickets"),className:"text-blue-500 hover:text-blue-700 flex items-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Retour aux tickets"]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4 md:mb-0",children:["Ticket #",n.id,": ",n.title]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-3 py-1 text-sm font-semibold rounded-full ${d[n.status.name]}`,children:n.status.name}),e.jsx("span",{className:`px-3 py-1 text-sm font-semibold rounded-full ${l[n.priority]}`,children:n.priority||"Normal"})]})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Créé par"}),e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[n.creator.firstName," ",n.creator.lastName]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Créé le"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:new Date(n.createdAt).toLocaleString()})]}),n.assignedTo&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Assigné à"}),e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[n.assignedTo.firstName," ",n.assignedTo.lastName]})]}),n.updatedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Dernière mise à jour"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:new Date(n.updatedAt).toLocaleString()})]}),n.resolvedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Résolu le"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:new Date(n.resolvedAt).toLocaleString()})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Description"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded",children:e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:n.description})})]}),n.service&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Service concerné"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded",children:e.jsxs("p",{className:"text-gray-900 dark:text-white",children:[n.service.name,n.service.description&&e.jsxs("span",{className:"text-gray-600 dark:text-gray-400 ml-2",children:["- ",n.service.description]})]})})]}),e.jsxs("div",{className:"mb-6 border-t border-gray-200 dark:border-gray-700 pt-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Communications"}),e.jsx("div",{className:"space-y-4 mb-6",children:n.comments&&n.comments.length>0?n.comments.map((t=>e.jsxs("div",{className:"p-4 rounded-lg "+(t.isFromAdmin?"bg-blue-50 dark:bg-blue-900/30 ml-8":"bg-gray-50 dark:bg-gray-700 mr-8"),children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("p",{className:"font-medium text-sm",children:t.isFromAdmin?"Support":n.creator.firstName+" "+n.creator.lastName}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(t.createdAt).toLocaleString()})]}),e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:t.content})]},t.id))):e.jsx("div",{className:"text-center py-4 text-gray-500 dark:text-gray-400",children:"Aucune communication pour le moment"})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-md font-medium text-gray-900 dark:text-white mb-2",children:N?"Répondre au ticket":"Ajouter un commentaire"}),e.jsx("textarea",{value:A,onChange:e=>C(e.target.value),rows:4,className:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:N?"Votre réponse au ticket...":"Ajoutez des informations complémentaires..."}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx("button",{onClick:async()=>{if(A.trim()){L(!0);try{const e=await a.post(`/tickets/${o}/comments`,{content:A.trim(),isFromAdmin:N});m((t=>({...t,comments:[...t.comments||[],e.data.comment]}))),C(""),i.success("Commentaire ajouté avec succès")}catch(e){console.error("Error adding comment:",e),i.error(e.response?.data?.message||"Échec de l'ajout du commentaire")}finally{L(!1)}}},disabled:!A.trim()||E,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:E?"Envoi...":"Envoyer"})})]})]}),N&&e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Actions administrateur"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Mise à jour du statut"}),e.jsx("select",{id:"status",value:g,onChange:e=>h(Number(e.target.value)),className:"w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:x.map((t=>e.jsx("option",{value:t.id,children:t.name},t.id)))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"priority",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Mise à jour de la priorité"}),e.jsxs("select",{id:"priority",value:b,onChange:e=>p(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[e.jsx("option",{value:"Low",children:"Low"}),e.jsx("option",{value:"Normal",children:"Normal"}),e.jsx("option",{value:"High",children:"High"})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:async()=>{if(N&&(g!==n.status.id||b!==n.priority)){S(!0);try{await a.put(`/tickets/${o}`,{statusId:g,priority:b});const e=x.find((e=>e.id===g)),t={...n,status:e||n.status,priority:b,updatedAt:(new Date).toISOString()};m(t),i.success("Ticket mis à jour avec succès"),D()}catch(e){console.error("Error updating ticket:",e),i.error(e.response?.data?.message||"Échec de la mise à jour du ticket")}finally{S(!1)}}},disabled:w||g===n.status.id&&b===n.priority,className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed",children:w?"Mise à jour...":"Mettre à jour le ticket"})})]})]})]})})]})}export{o as default};
